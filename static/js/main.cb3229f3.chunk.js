(this["webpackJsonpdrawing-sample"]=this["webpackJsonpdrawing-sample"]||[]).push([[0],{121:function(e,t){},122:function(e,t){},123:function(e,t){},125:function(e,t,i){"use strict";i.r(t);var a,n,s,o,r=i(0),c=i.n(r),l=i(35),h=i.n(l),d=i(92),u=i(187),v=i(177),g=i(4),f=i(51),b=i.n(f),p=new b.a(1,0),m=new b.a(0,1),y=function(e,t,i){if(i>=1)return t;if(i<=0)return e;var a=t.clone().subtract(e).normalize(),n=e.distance(t),s=a.multiplyScalar(n*i);return e.clone().add(s)},j=function(e,t){var i=t.clone().subtract(e).normalize(),a=new b.a(i.y,-1*i.x).normalize();return m.dot(a)>0&&a.invert(),a},O=function(e){return JSON.parse(JSON.stringify(e))},x=function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:3,i=Math.pow(10,t),a=Math.round(e*i)/i;return a},w=function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:25,i=e/t,a=Math.round(i)*t;return a},k=function(e){var t=Object(g.a)(e,2),i=t[0],a=t[1],n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:25;return[w(i,n),w(a,n)]},M=function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:5;return w(e,t)},S=function e(t){var i=t;return 0>i&&(i+=360),i>=360&&(i-=360),(0>i||i>=360)&&(i=e(i)),i},E=function(e,t,i){for(var a=[],n=e.distance(t),s=10,o=n/(s+1);o<25&&s>0;)o=n/(--s+1);if(s>0)for(var r=1;r<=s;r++){var c=e.clone().add(i.clone().multiplyScalar(o*r));a.push(c)}else if((o=n/2)>=10){var l=y(e,t,.5);a.push(l)}return a},C=function(e,t,i){var a=Object(g.a)(e,4),n=a[0],s=a[1],o=a[2],r=a[3],c=null;try{var l=t.clone().add(i),h=l.x-t.x!==0?(l.y-t.y)/(l.x-t.x):NaN,d=isNaN(h)?NaN:t.y-h*t.x;if(o===h)return null;if(isNaN(o)||isNaN(h)){if(isNaN(o)){var u=n.x;c=[u,u*h+d]}else if(isNaN(h)){var v=t.x;c=[v,v*o+r]}}else{var f=(d-r)/(o-h);c=[f,o*f+r]}if(c){var b=c,p=Object(g.a)(b,2),m=p[0],y=p[1],j=[n.x,s.x].sort((function(e,t){return e-t})),O=[n.y,s.y].sort((function(e,t){return e-t}));if(m>=j[0]&&m<=j[1]&&y>=O[0]&&y<=O[1])return c}return null}catch(x){console.error(x)}return null},I=function(e){var t,i;if(0===(null===(t=e.e.type)||void 0===t?void 0:t.indexOf("touch"))){var a=e.e.touches[0];return{x:a.clientX,y:a.clientY}}if(0===(null===(i=e.e.type)||void 0===i?void 0:i.indexOf("mouse"))){var n=e.e;return{x:n.clientX,y:n.clientY}}},P=function(e,t){var i=arguments.length>2&&void 0!==arguments[2]&&arguments[2],a=i?0:3;return Math.abs(e[0]-t[0])<=a&&Math.abs(e[1]-t[1])<=a},z=i(183),T=i(1),B=Object(r.createContext)(void 0),A=function(e){var t=e.children,i=Object(r.useState)("note"),a=Object(g.a)(i,2),n=a[0],s=a[1],o=Object(r.useState)("A4"),c=Object(g.a)(o,2),l=c[0],h=c[1],d=Object(r.useState)(),u=Object(g.a)(d,2),v=u[0],f=u[1],b=Object(r.useRef)(null),p=Object(r.useRef)(null),m=Object(r.useRef)(),y=Object(r.useCallback)((function(e,t){s("canvas");var i=O(e);i.zoom=i.zoom*i.pageZoom,f(i),m.current=t}),[]),j=Object(r.useCallback)((function(){if(p.current){var e=p.current.getStructure();m.current&&m.current(e)}s("note"),f(void 0)}),[]);return Object(T.jsx)(B.Provider,{value:{mode:n,onChangeMode:s,pageSizeType:l,onChangePageSize:h,canvasProps:v,editCanvas:y,closeCanvas:j,noteRef:b,canvasRef:p},children:t})},D=Object(r.createContext)(void 0),J=function(e){var t=e.children,i=Object(r.useState)("pen"),a=Object(g.a)(i,2),n=a[0],s=a[1];return Object(T.jsx)(D.Provider,{value:{tool:n,setTool:s},children:t})},N=i(3),R=["free","pin","pinX","pinZ","fixX","fix"],_=function(e){if(e&&"object"===typeof e){var t=e;return"string"===typeof t.id&&"string"===typeof t.name&&"number"===typeof t.x&&"number"===typeof t.y}return!1},L=function(e){if(e&&"object"===typeof e){var t=e;return"string"===typeof t.id&&"string"===typeof t.name&&"string"===typeof t.nodeI&&"string"===typeof t.nodeJ}return!1},G=function(e){if(e&&"object"===typeof e){var t=e;return"string"===typeof t.id&&"string"===typeof t.name&&"string"===typeof t.beam&&"number"===typeof t.force&&"number"===typeof t.distanceI}return!1},W=function(e){if(e&&"object"===typeof e){var t=e;return"string"===typeof t.id&&"string"===typeof t.name&&"string"===typeof t.beam&&"number"===typeof t.moment&&"number"===typeof t.distanceI}return!1},F=function(e){if(e&&"object"===typeof e){var t=e;return"string"===typeof t.id&&"string"===typeof t.name&&"string"===typeof t.beam&&"number"===typeof t.forceI&&"number"===typeof t.distanceI&&"number"===typeof t.forceJ&&"number"===typeof t.distanceJ}return!1},V={version:"0.0.0",unit:{force:"kN",length:"m"},nodes:[],beams:[],forces:[],moments:[],trapezoids:[]},X=["select","edit"],Y={A3:{width:0,height:0},A4:{width:2970,height:2100},B4:{width:0,height:0},B5:{width:0,height:0}},Z=Object(N.a)(Object(N.a)({id:"Canvas_1",data:Object(N.a)({},V),x:100,y:100},{width:160,height:90}),{},{zoom:1}),H={stroke:"#000000",strokeWidth:4,eraser:!1},U={size:"A4",zoom:1,viewport:[1,0,0,1,0,0],structures:[Object(N.a)({},Z)]},q=Object(r.createContext)(void 0),K=function(e){var t=e.children,i=Object(r.useState)("select"),a=Object(g.a)(i,2),n=a[0],s=a[1],o=Object(r.useState)(H),c=Object(g.a)(o,2),l=c[0],h=c[1];return Object(T.jsx)(q.Provider,{value:{mode:n,settings:l,onChangeMode:s,onChangeDrawSettings:h},children:t})},Q=i(195),$=i(189),ee=i(191),te=i(188),ie=null!==(a=null===(n="3a29fe25606c5edebd90b960e65f97e9e9231b33\n")?void 0:n.substring(0,7))&&void 0!==a?a:"",ae=null!==(s="2022/02/14 16:32:35")?s:"",ne=null!==(o="0.1.0")?o:"",se=function(){return Object(T.jsx)(te.a,{variant:"caption",sx:{ml:2},children:"ver ".concat(ne," (").concat(ie,": ").concat(ae,")")})},oe=function(){return Object(T.jsx)($.a,{position:"static",children:Object(T.jsxs)(ee.a,{variant:"dense",children:[Object(T.jsx)(te.a,{component:"h1",variant:"h6",color:"inherit",children:"Drawing Sample"}),Object(T.jsx)(se,{})]})})},re=i(24),ce=i(16),le=i(19),he=i(20),de=i(12),ue="silver",ve={stroke:ue,strokeWidth:1},ge={width:8,height:8,stroke:ue,strokeWidth:1,fill:ue,originX:"center",originY:"center",centeredRotation:!0},fe={fill:ue,height:10,fontSize:10,fontFamily:"sans-serif",textAlign:"center",evented:!1,selectable:!1},be=function(e,t,i){var a=e.clone(),n=t.clone();if(a.x>n.x||a.x===n.x&&a.y>n.y){var s=[n,a];a=s[0],n=s[1]}var o=j(a,n);if(0!==i){var r=o.clone();m.dot(r)>=0&&r.invert(),r.multiplyScalar(i),a.add(r),n.add(r)}var c=a.distance(n),l=n.clone().subtract(a).normalize().angleDeg(),h=new de.fabric.Line([0,-7,0,7],ve),d=new de.fabric.Line([c,-7,c,7],ve),u=new de.fabric.Line([0,0,c,0],ve),v=new de.fabric.Triangle(Object(N.a)({top:0,left:4,angle:-90},ge)),g=new de.fabric.Triangle(Object(N.a)({top:0,left:c-4,angle:90},ge)),f=new de.fabric.Group([h,v,u,g,d],{top:a.y,left:a.x,originX:"left",originY:"center",angle:l}),b=l,y=o.invert(),O=a.clone().add(y.multiplyScalar(5));0===y.dot(m)&&(y=p.clone(),b=-90,O=n.clone().add(y.multiplyScalar(5)));var x=new de.fabric.Textbox("".concat(Math.round(c)," m"),Object(N.a)({top:O.y,left:O.x,width:c,angle:b},fe));return new de.fabric.Group([f,x],{selectable:!1,evented:!1,data:{type:"guide"}})},pe=function(e,t,i){var a=0;if(Array.isArray(e))return"number"===typeof t&&(a=t),function(e,t){var i=new b.a(e[0],e[1]),a=new b.a(e[2],e[3]);return be(i,a,t)}(e,a);if(t&&"number"!==typeof t)return"number"===typeof i&&(a=i),be(e,t,a);throw new Error("invalid parameters")},me=function(e){return pe(e,50)},ye=function(e,t,i){var a=[];if(0===e.size||0===t.size)return[];var n,s=Number.MAX_SAFE_INTEGER,o=Object(ce.a)(e).sort((function(e,t){return e-t}));s=o[0];var r=Object(ce.a)(t).sort((function(e,t){return e-t}));if(n=r[r.length-1],s!==o[o.length-1]){var c=Math.min(n+50,i-10),l=pe([s,c,o[o.length-1],c]);a.push(l);for(var h=c-25,d=0;d<o.length-1;d++){var u=o[d],v=o[d+1];if(u!==v){var g=pe([u,h,v,h]);a.push(g)}}}if(r[0]!==n){var f=Math.max(25,s-50),b=pe([f,r[0],f,n]);a.push(b);for(var p=f+25,m=0;m<r.length-1;m++){var y=r[m],j=r[m+1];if(y!==j){var O=pe([p,y,p,j]);a.push(O)}}}return a},je=function(e,t,i){if(Array.isArray(e)&&"number"===typeof t)return function(e,t){var i=new Set,a=new Set;return e.forEach((function(e){var t=e.x,n=e.y;i.add(t),a.add(n)})),ye(i,a,t)}(e,t);if(e instanceof Set&&t instanceof Set&&"number"===typeof i)return ye(e,t,i);throw new Error("invalid parameters")},Oe=["arrowWidth","arrowEdgeSize","onRotating","onScaling","onModified"],xe={evented:!1,selectable:!1},we={fontSize:10,fontFamily:"sans-serif",height:10},ke="black",Me={stroke:ke,strokeWidth:2,originX:"center",originY:"bottom",centeredRotation:!1},Se={width:8,height:8,stroke:ke,strokeWidth:1,fill:ke,originX:"center",originY:"center",centeredRotation:!0},Ee=function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},a=i.arrowWidth,n=i.arrowEdgeSize,s=(i.onRotating,i.onScaling,i.onModified,Object(re.a)(i,Oe)),o=e.distance(t),r=t.clone().subtract(e).normalize(),c=180-r.verticalAngleDeg(),l=new de.fabric.Line([0,0,0,-1*o],Object(N.a)(Object(N.a)({strokeWidth:a},Me),s)),h=null!==n&&void 0!==n?n:8,d=new de.fabric.Triangle(Object(N.a)(Object(N.a)({top:h/2*-1,left:0,angle:-180},Se),{},{width:h,height:h,stroke:s.stroke,fill:s.fill})),u=new de.fabric.Group([l,d],Object(N.a)(Object(N.a)({},s),{},{top:e.y,left:e.x,originX:"center",originY:"bottom",centeredRotation:!1,angle:c}));return u.setControlsVisibility({bl:!1,br:!1,mb:!1,ml:!1,mr:!1,mt:!0,tl:!1,tr:!1,mtr:!0}),u},Ce=function(e,t,i){if(Array.isArray(e))return function(e,t){var i=new b.a(e[0],e[1]),a=new b.a(e[2],e[3]);return Ee(i,a,t)}(e,t);if(t)return Ee(e,t,i);throw new Error("invalid parameters")},Ie="orange",Pe=(Object(N.a)(Object(N.a)(Object(N.a)({},xe),we),{},{fill:Ie,textAlign:"left"}),{fill:"transparent",originX:"center",originY:"center",lockRotation:!0,lockScalingX:!0,lockScalingY:!0,hasBorders:!1,hasControls:!1}),ze={originX:"center",originY:"center",selectable:!1,evented:!1},Te=Object(N.a)(Object(N.a)(Object(N.a)({},xe),we),{},{fill:"red",originX:"center",originY:"top",textAlign:"center"}),Be=function(){function e(t,i){Object(le.a)(this,e),this.data=void 0,this.moment=void 0,this.image=void 0,this.label=void 0,this.manager=void 0,this.longpressTimer=void 0,this.dragging=!1,this._readonly=!1,this.beam=void 0,this.vi=new b.a(0,0),this.vj=new b.a(0,0),this.position=new b.a(0,0),this.dragPoint=new b.a(0,0),this.draggableMin=Number.MIN_SAFE_INTEGER,this.draggableMax=Number.MAX_SAFE_INTEGER,this.manager=t,this.data=i,this._readonly=this.manager.readonly;var a=this.create(),n=Object(g.a)(a,2);this.moment=n[0],this.label=n[1],this.manager.canvas.add(this.moment,this.label),this.attachEvent()}return Object(he.a)(e,[{key:"readonly",get:function(){return this._readonly},set:function(e){this._readonly=e,this.moment.selectable=!e,this.moment.evented=!e}},{key:"visible",get:function(){var e;return null===(e=this.moment.visible)||void 0===e||e},set:function(e){this.moment.visible=e,this.label.visible=e,this.image&&(this.image.visible=e)}},{key:"create",value:function(){var e=this,t=this.data,i=t.id,a=t.beam,n=t.distanceI,s=this.manager.beamMap[a].points,o=new b.a(s[0],s[1]),r=new b.a(s[2],s[3]),c=y(o,r,n),l=new de.fabric.Circle(Object(N.a)(Object(N.a)({},Pe),{},{name:i,data:Object(N.a)({type:"moment"},this.data),top:c.y,left:c.x,radius:12,selectable:!this.readonly,evented:!this.readonly}));de.fabric.loadSVGFromURL("".concat("/drawing-sample").concat("/assets/images/moment.svg"),(function(t,i){var a=de.fabric.util.groupSVGElements(t,i);a.set({stroke:"red"}),"path"===a.type?e.image=new de.fabric.Group([a]):e.image=a,e.image.set(Object(N.a)(Object(N.a)({},ze),{},{name:"image/".concat(e.data.id),data:Object(N.a)({type:"moment/image"},e.data),top:c.y,left:c.x,scaleX:.375,scaleY:.375,flipY:e.data.moment<0})),e.manager.canvas.add(e.image)}));var h=c.clone().add(m.clone().multiplyScalar(17)),d=new de.fabric.Textbox("".concat(this.data.moment," kN"),Object(N.a)(Object(N.a)({},Te),{},{top:h.y,left:h.x,width:100,visible:!1}));return this.position.copy(c),[l,d]}},{key:"update",value:function(e){var t;e&&(this.data=e);var i=null!==(t=this.label.visible)&&void 0!==t&&t;this.remove(!0);var a=this.create(),n=Object(g.a)(a,2);this.moment=n[0],this.label=n[1],this.manager.canvas.add(this.moment,this.label),this.attachEvent(),i&&this.select()}},{key:"remove",value:function(){var e=this,t=arguments.length>0&&void 0!==arguments[0]&&arguments[0];if(this.moment.off(),this.manager.canvas.remove(this.moment,this.label),this.image&&this.manager.canvas.remove(this.image),!t){var i=this.manager.momentMap[this.data.beam];if(i){var a=i.filter((function(t){return t.data.id!==e.data.id}));this.manager.momentMap[this.data.beam]=a}}}},{key:"select",value:function(){this.manager.canvas.setActiveObject(this.moment)}},{key:"attachEvent",value:function(){this.moment.on("selected",this.onSelected.bind(this)),this.moment.on("deselected",this.onDeselected.bind(this)),this.moment.on("mousedown",this.onMouseDown.bind(this)),this.moment.on("mouseup",this.onMouseUp.bind(this)),this.moment.on("mousedblclick",this.onDblClick.bind(this)),this.moment.on("moving",this.onMoving.bind(this)),this.moment.on("moved",this.onMoved.bind(this))}},{key:"onSelected",value:function(){this.label.visible=!0}},{key:"onDeselected",value:function(){this.label.visible=!1}},{key:"onMouseDown",value:function(e){var t=this;if(!this.readonly)if("delete"!==this.manager.tool){if(["select","moment"].includes(this.manager.tool)&&e.target){this.longpressTimer&&(clearTimeout(this.longpressTimer),this.longpressTimer=void 0);var i=this.moment,a=i.getBoundingRect(!0,!0),n=a.top,s=a.left;this.longpressTimer=setTimeout((function(){var a=i.getBoundingRect(!0,!0),o=a.top,r=a.left;P([s,n],[r,o])&&t.manager.openMomentDialog(e,t),t.longpressTimer=void 0}),qe.LongpressInterval)}}else this.remove()}},{key:"onMouseUp",value:function(e){this.longpressTimer&&(clearTimeout(this.longpressTimer),this.longpressTimer=void 0)}},{key:"onDblClick",value:function(e){this.readonly||this.manager.openMomentDialog(e,this)}},{key:"calcMovedPosition",value:function(){if(this.beam){var e,t;this.dragPoint.x=null!==(e=this.moment.left)&&void 0!==e?e:0,this.dragPoint.y=null!==(t=this.moment.top)&&void 0!==t?t:0;var i=this.position.distance(this.dragPoint),a=180-this.dragPoint.clone().subtract(this.position).normalize().verticalAngleDeg(),n=(this.beam.angle-a)*Math.PI/180,s=i*Math.cos(n);this.draggableMin>s?s=this.draggableMin:this.draggableMax<s&&(s=this.draggableMax),this.dragPoint.copy(this.position).add(this.beam.direction.clone().multiplyScalar(s))}}},{key:"onMoving",value:function(e){if(["select","moment"].includes(this.manager.tool)){if(!this.dragging){this.label.visible=!1,this.beam=this.manager.beamMap[this.data.beam];var t=[this.beam.points[0],this.beam.points[1]];this.vi.x=t[0],this.vi.y=t[1];var i=[this.beam.points[2],this.beam.points[3]];this.vj.x=i[0],this.vj.y=i[1],this.draggableMin=-1*this.vi.distance(this.position),this.draggableMax=this.vj.distance(this.position),this.dragPoint.copy(this.position),this.dragging=!0}this.calcMovedPosition(),this.moment.left=this.dragPoint.x,this.moment.top=this.dragPoint.y,this.image&&(this.image.left=this.dragPoint.x,this.image.top=this.dragPoint.y)}}},{key:"onMoved",value:function(e){if(this.beam){this.calcMovedPosition();var t=this.vi.distance(this.dragPoint);this.data.distanceI=x(t/this.beam.length,2),this.position.copy(this.vi.clone().add(this.beam.direction.clone().multiplyScalar(this.beam.length*this.data.distanceI))),this.moment.left=this.position.x,this.moment.top=this.position.y,this.image&&(this.image.left=this.position.x,this.image.top=this.position.y);var i=this.position.clone().add(m.clone().multiplyScalar(17));this.label.left=i.x,this.label.top=i.y,this.label.visible=!0}this.beam=void 0,this.draggableMin=Number.MIN_SAFE_INTEGER,this.draggableMax=Number.MAX_SAFE_INTEGER,this.dragging=!1}}]),e}(),Ae=function(){function e(t,i){Object(le.a)(this,e),this.data=void 0,this.beam=void 0,this.guide=void 0,this.points=[0,0,0,0],this.direction=new b.a(0,0),this.length=1,this.angle=0,this.manager=void 0,this.dragging=!1,this._readonly=!1,this.vi=new b.a(0,0),this.vj=new b.a(0,0),this.nodeI=void 0,this.nodeJ=void 0,this.relationBeams=void 0,this.manager=t,this.data=i;var a=this.manager.nodeMap[i.nodeI],n=this.manager.nodeMap[i.nodeJ];this._readonly=this.manager.readonly,this.beam=this.create([a.data.x,a.data.y,n.data.x,n.data.y],i,{selectable:!this.readonly,evented:!this.readonly}),this.guide=me(this.points),this.guide.visible=!1,this.manager.canvas.add(this.beam,this.guide),this.attachEvents()}return Object(he.a)(e,[{key:"readonly",get:function(){return this._readonly},set:function(e){this._readonly=e,this.beam.selectable=!e,this.beam.evented=!e}},{key:"createBeamByVectors",value:function(e,t,i,a){this.direction=t.clone().subtract(e).normalize(),this.length=e.distance(t),this.angle=180-this.direction.verticalAngleDeg();var n=new de.fabric.Line([0,0,0,this.length],Object(N.a)(Object(N.a)({top:e.y,left:e.x,angle:this.angle,originX:"center",originY:"bottom",centeredRotation:!1,stroke:"black",strokeWidth:4},a),{},{name:i.id,data:Object(N.a)({type:"beam"},i)}));return n.setControlsVisibility({bl:!1,br:!1,mb:!1,ml:!1,mr:!1,mt:!0,tl:!1,tr:!1,mtr:!0}),this.points=[e.x,e.y,t.x,t.y],this.vi=e,this.vj=t,n}},{key:"createBeamByPoints",value:function(e,t,i){var a=new b.a(e[0],e[1]),n=new b.a(e[2],e[3]);return this.createBeamByVectors(a,n,t,i)}},{key:"create",value:function(e,t,i,a){if(Array.isArray(e)&&L(t))return this.createBeamByPoints(e,t,null!==i&&void 0!==i?i:{});if(L(i))return this.createBeamByVectors(e,t,i,null!==a&&void 0!==a?a:{});throw new Error("invalid parameters")}},{key:"updateGuide",value:function(){this.guide&&this.manager.canvas.remove(this.guide),this.guide=me(this.points),this.guide.visible=!1,this.manager.canvas.add(this.guide)}},{key:"updateBeamByVectors",value:function(e,t){var i=t.clone().subtract(e).normalize(),a=e.distance(t),n=180-i.verticalAngleDeg(),s=[e.x,e.y,t.x,t.y];this.beam.scaleX=1,this.beam.scaleY=1,this.beam.dirty=!0,this.beam.top=e.y,this.beam.left=e.x,this.beam.height=a,this.beam.rotate(n),this.direction=i,this.length=a,this.angle=n,this.points=s,this.vi=e,this.vj=t,this.updateGuide()}},{key:"updateBeamByPoints",value:function(e){var t=new b.a(e[0],e[1]),i=new b.a(e[2],e[3]);this.updateBeamByVectors(t,i)}},{key:"update",value:function(e,t){if(Array.isArray(e))this.updateBeamByPoints(e);else{if(!e||!t)throw this.updateBeamByPoints(this.points),new Error("invalid parameters");this.updateBeamByVectors(e,t)}}},{key:"remove",value:function(){var e=this.manager,t=e.canvas,i=e.forceMap,a=e.trapezoidMap,n=e.beamMap,s=e.nodeBeamMap,o=this.data.id,r=i[o];r&&(r.forEach((function(e){e.remove()})),delete i[o]);var c=a[o];c&&(c.forEach((function(e){e.remove()})),delete a[o]),[this.data.nodeI,this.data.nodeJ].forEach((function(e){var t=s[e];if(t){var i=t.filter((function(e){return e.data.id!==o}));s[e]=i}})),t.remove(this.beam),this.guide&&t.remove(this.guide),delete n[o]}},{key:"setVisibleParts",value:function(){var e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0],t=this.manager,i=t.forceMap,a=t.trapezoidMap,n=t.momentMap;this.guide&&(this.guide.visible=e);var s=i[this.data.id];s&&s.forEach((function(t){t.visible=e}));var o=a[this.data.id];o&&o.forEach((function(t){t.visible=e}));var r=n[this.data.id];r&&r.forEach((function(t){t.visible=e}))}},{key:"updateParts",value:function(){var e=this.manager,t=e.forceMap,i=e.trapezoidMap,a=e.momentMap;this.updateGuide();var n=t[this.data.id];n&&n.forEach((function(e){e.update()}));var s=i[this.data.id];s&&s.forEach((function(e){e.update()}));var o=a[this.data.id];o&&o.forEach((function(e){e.update()}))}},{key:"calcPoints",value:function(){var e=arguments.length>0&&void 0!==arguments[0]&&arguments[0],t=this.beam,i=t.top,a=void 0===i?0:i,n=t.left,s=void 0===n?0:n;if(e){var o=k([s,a],this.manager.snapSize),r=Object(g.a)(o,2);s=r[0],a=r[1]}return this.vi.x=s,this.vi.y=a,this.vj.copy(this.vi),this.vj.add(this.direction.clone().multiplyScalar(this.length)),[this.vi.x,this.vi.y,this.vj.x,this.vj.y]}},{key:"calcRatio",value:function(e){var t=this.vi.distance(e),i=180-e.clone().subtract(this.vi).normalize().verticalAngleDeg(),a=(this.angle-i)*(Math.PI/180),n=t*Math.cos(a),s=x(n/this.length,2);return s<0&&(s=0),s>1&&(s=1),s}},{key:"completeDrag",value:function(){var e=this;if(this.nodeI&&this.nodeJ){var t=this.nodeI,i=this.nodeJ,a=this.manager,n=a.nodeMap,s=a.nodeBeamMap,o=a.beamMap,r=Object(g.a)(this.points,4),c=r[0],l=r[1],h=r[2],d=r[3],u={},v=[],f=[this],b=[t.data.id,i.data.id];b.forEach((function(e){"undefined"===typeof s[e]&&(s[e]=[])})),Object.values(n).forEach((function(e){b.includes(e.data.id)||(e.data.x===c&&e.data.y===l?u[e.data.id]=t:e.data.x===h&&e.data.y===d&&(u[e.data.id]=i))})),Object.values(o).forEach((function(a){if(a.data.id!==e.data.id){var n=!1,s=!1;if(u[a.data.nodeI]&&(n=!0,a.data.nodeI=u[a.data.nodeI].data.id),u[a.data.nodeJ]&&(s=!0,a.data.nodeJ=u[a.data.nodeJ].data.id),n&&s)v.push(a);else{var o=a.points,r=!1;a.data.nodeI===t.data.id&&(o[0]=c,o[1]=l,r=!0),a.data.nodeI===i.data.id&&(o[0]=h,o[1]=d,r=!0),a.data.nodeJ===t.data.id&&(o[2]=c,o[3]=l,r=!0),a.data.nodeJ===i.data.id&&(o[2]=h,o[3]=d,r=!0),r&&(a.update(o),0===a.length?v.push(a):f.push(a))}}})),v.length>0&&(v.forEach((function(e){e.remove()})),this.manager.calcForceAverage(),this.manager.calcTrapezoidAverage()),Object.entries(u).forEach((function(e){var t=Object(g.a)(e,2),i=t[0],a=t[1],o=s[i];if(o){var r,c=null!==(r=s[a.data.id])&&void 0!==r?r:[];o.forEach((function(e){c.some((function(t){return t.data.id!==e.data.id}))&&c.push(e)})),s[a.data.id]=c}var l=n[i];l&&l.remove()})),f.forEach((function(e){e.updateParts()})),this.manager.updateGlobalGuidelines()}this.nodeI=void 0,this.nodeJ=void 0,this.relationBeams=void 0,this.dragging=!1}},{key:"attachEvents",value:function(){this.beam.on("selected",this.onSelect.bind(this)),this.beam.on("deselected",this.onDeselect.bind(this)),this.beam.on("mousedown",this.onMouseDown.bind(this)),this.beam.on("mousedown:before",this.onMouseDownBefore.bind(this)),this.beam.on("moving",this.onMoving.bind(this)),this.beam.on("moved",this.onMoved.bind(this)),this.beam.on("rotating",this.onRotating.bind(this)),this.beam.on("rotated",this.onRotated.bind(this)),this.beam.on("scaling",this.onScaling.bind(this)),this.beam.on("scaled",this.onScaled.bind(this))}},{key:"onSelect",value:function(e){this.guide&&(this.guide.visible=!0)}},{key:"onDeselect",value:function(e){this.guide&&(this.guide.visible=!1)}},{key:"onMouseDownBefore",value:function(){"trapezoid"===this.manager.tool&&(this.manager.currentBeam=this.data.id)}},{key:"onMouseDown",value:function(e){if(e.absolutePointer){var t=new b.a(e.absolutePointer.x,e.absolutePointer.y);if("force"===this.manager.tool){var i=this.calcRatio(t),a=Object(z.a)(),n={id:a,name:a,beam:this.data.id,force:10,distanceI:i},s=new Ne(this.manager,n);"undefined"===typeof this.manager.forceMap[this.data.id]&&(this.manager.forceMap[this.data.id]=[]),this.manager.forceMap[this.data.id].push(s),this.manager.calcForceAverage()}else if("moment"===this.manager.tool){var o=this.calcRatio(t),r=Object(z.a)(),c={id:r,name:r,beam:this.data.id,moment:10,distanceI:o},l=new Be(this.manager,c);"undefined"===typeof this.manager.momentMap[this.data.id]&&(this.manager.momentMap[this.data.id]=[]),this.manager.momentMap[this.data.id].push(l)}else"delete"===this.manager.tool&&(this.remove(),this.manager.removeUnconnectedNodes(),this.manager.updateGlobalGuidelines(),this.manager.calcForceAverage(),this.manager.calcTrapezoidAverage())}}},{key:"onMoving",value:function(e){var t=this;if("select"===this.manager.tool){if(!this.dragging)this.setVisibleParts(!1),this.nodeI=this.manager.nodeMap[this.data.nodeI],this.nodeJ=this.manager.nodeMap[this.data.nodeJ],this.relationBeams=[],[this.nodeI,this.nodeJ].forEach((function(e){e&&e.pin&&(e.pin.visible=!1),t.manager.nodeBeamMap[e.data.id].forEach((function(e){var i;e.data.id!==t.data.id&&(e.setVisibleParts(!1),null===(i=t.relationBeams)||void 0===i||i.push(e))}))}));var i,a=this.calcPoints(),n=Object(g.a)(a,4),s=n[0],o=n[1],r=n[2],c=n[3];if(this.nodeI&&this.nodeJ)this.nodeI.update(s,o,!1),this.nodeJ.update(r,c,!1),null===(i=this.relationBeams)||void 0===i||i.forEach((function(e){var i,a,n,l,h=e.points;e.data.nodeI===(null===(i=t.nodeI)||void 0===i?void 0:i.data.id)&&(h[0]=s,h[1]=o),e.data.nodeI===(null===(a=t.nodeJ)||void 0===a?void 0:a.data.id)&&(h[0]=r,h[1]=c),e.data.nodeJ===(null===(n=t.nodeI)||void 0===n?void 0:n.data.id)&&(h[2]=s,h[3]=o),e.data.nodeJ===(null===(l=t.nodeJ)||void 0===l?void 0:l.data.id)&&(h[2]=r,h[3]=c),e.update(h)}));this.dragging=!0}}},{key:"onMoved",value:function(e){if("select"===this.manager.tool&&this.dragging&&this.nodeI&&this.nodeJ){var t,i,a=this.calcPoints(!0),n=Object(g.a)(a,4),s=n[0],o=n[1],r=n[2],c=n[3];this.update([s,o,r,c]),null===(t=this.nodeI)||void 0===t||t.update(s,o),null===(i=this.nodeJ)||void 0===i||i.update(r,c),this.completeDrag()}}},{key:"onRotating",value:function(e){var t=this;if("select"===this.manager.tool){var i,a,n;if(!this.dragging)this.setVisibleParts(!1),this.nodeI=this.manager.nodeMap[this.data.nodeI],this.nodeJ=this.manager.nodeMap[this.data.nodeJ],this.relationBeams=[],this.nodeJ.pin&&(this.nodeJ.pin.visible=!1),this.manager.nodeBeamMap[this.nodeJ.data.id].forEach((function(e){var i;e.data.id!==t.data.id&&(e.setVisibleParts(!1),null===(i=t.relationBeams)||void 0===i||i.push(e))}));this.vj.copy(this.vi),this.vj.add(m.clone().invert().multiplyScalar(this.length).rotateDeg(null!==(i=this.beam.angle)&&void 0!==i?i:0));var s=[this.vj.x,this.vj.y],o=s[0],r=s[1];null===(a=this.nodeJ)||void 0===a||a.update(o,r),null===(n=this.relationBeams)||void 0===n||n.forEach((function(e){var i,a,n=e.points;e.data.nodeI===(null===(i=t.nodeJ)||void 0===i?void 0:i.data.id)&&(n[0]=o,n[1]=r),e.data.nodeJ===(null===(a=t.nodeJ)||void 0===a?void 0:a.data.id)&&(n[2]=o,n[3]=r),e.update(n)})),this.dragging=!0}}},{key:"onRotated",value:function(e){if("select"===this.manager.tool&&this.dragging){var t,i;this.vj.copy(this.vi),this.vj.add(m.clone().invert().multiplyScalar(this.length).rotateDeg(null!==(t=this.beam.angle)&&void 0!==t?t:0));var a=k([this.vj.x,this.vj.y],this.manager.snapSize),n=Object(g.a)(a,2),s=n[0],o=n[1];this.vj.x=s,this.vj.y=o,null===(i=this.nodeJ)||void 0===i||i.update(s,o),this.update([this.vi.x,this.vi.y,s,o]),this.completeDrag()}}},{key:"onScaling",value:function(e){var t=this;if("select"===this.manager.tool){var i,a,n,s;if(!this.dragging)this.setVisibleParts(!1),this.nodeI=this.manager.nodeMap[this.data.nodeI],this.nodeJ=this.manager.nodeMap[this.data.nodeJ],this.relationBeams=[],this.nodeJ.pin&&(this.nodeJ.pin.visible=!1),this.manager.nodeBeamMap[this.nodeJ.data.id].forEach((function(e){var i;e.data.id!==t.data.id&&(e.setVisibleParts(!1),null===(i=t.relationBeams)||void 0===i||i.push(e))}));var o=null!==(i=this.beam.scaleY)&&void 0!==i?i:1,r=null!==(a=this.beam.angle)&&void 0!==a?a:0;this.vj.copy(this.vi),this.vj.add(m.clone().invert().multiplyScalar(this.length*o).rotateDeg(r));var c=[this.vj.x,this.vj.y],l=c[0],h=c[1];null===(n=this.nodeJ)||void 0===n||n.update(l,h),null===(s=this.relationBeams)||void 0===s||s.forEach((function(e){var i,a,n=e.points;e.data.nodeI===(null===(i=t.nodeJ)||void 0===i?void 0:i.data.id)&&(n[0]=l,n[1]=h),e.data.nodeJ===(null===(a=t.nodeJ)||void 0===a?void 0:a.data.id)&&(n[2]=l,n[3]=h),e.update(n)})),this.dragging=!0}}},{key:"onScaled",value:function(e){if("select"===this.manager.tool&&this.dragging){var t,i,a,n=null!==(t=this.beam.scaleY)&&void 0!==t?t:1,s=null!==(i=this.beam.angle)&&void 0!==i?i:0;this.vj.copy(this.vi),this.vj.add(m.clone().invert().multiplyScalar(this.length*n).rotateDeg(s));var o=k([this.vj.x,this.vj.y],this.manager.snapSize),r=Object(g.a)(o,2),c=r[0],l=r[1];this.vj.x=c,this.vj.y=l,null===(a=this.nodeJ)||void 0===a||a.update(c,l),this.update([this.vi.x,this.vi.y,c,l]),this.completeDrag()}}}]),e}(),De="orange",Je=Object(N.a)(Object(N.a)(Object(N.a)({},xe),we),{},{fill:De,textAlign:"left"}),Ne=function(){function e(t,i){Object(le.a)(this,e),this.data=void 0,this.force=void 0,this.label=void 0,this.manager=void 0,this.longpressTimer=void 0,this.dragging=!1,this._readonly=!1,this.head=new b.a(0,0),this.direction=new b.a(0,1),this.length=0,this.beam=void 0,this.vi=new b.a(0,0),this.vj=new b.a(0,0),this.originalAngle=0,this.position=new b.a(0,0),this.draggableMin=Number.MIN_SAFE_INTEGER,this.draggableMax=Number.MAX_SAFE_INTEGER,this.manager=t,this.data=i,this._readonly=this.manager.readonly;var a=this.create(),n=Object(g.a)(a,2);this.force=n[0],this.label=n[1],this.manager.canvas.add(this.force,this.label),this.attachEvent()}return Object(he.a)(e,[{key:"readonly",get:function(){return this._readonly},set:function(e){this._readonly=e,this.force.selectable=!e,this.force.evented=!e}},{key:"visible",get:function(){var e;return null===(e=this.force.visible)||void 0===e||e},set:function(e){this.force.visible=e,this.label.visible=e}},{key:"calcForce",value:function(){return 0===this.manager.forceAverage?10:Math.round(this.length/30*this.manager.forceAverage)}},{key:"calcLength",value:function(){return 0===this.manager.forceAverage?30:30*(this.data.force/this.manager.forceAverage)}},{key:"create",value:function(){var e=this.data,t=e.id,i=e.beam,a=e.distanceI,n=e.angle,s=void 0===n?0:n,o=this.manager.beamMap[i],r=o.points,c=new b.a(r[0],r[1]),l=new b.a(r[2],r[3]),h=y(c,l,a),d=o.direction.clone().rotateDeg(s-90).normalize(),u=this.calcLength(),v=h.clone().add(d.clone().multiplyScalar(u)),g=Ce(h,v,{fill:De,stroke:De,name:t,data:Object(N.a)(Object(N.a)({},this.data),{},{type:"force"}),selectable:!this.readonly,evented:!this.readonly}),f=h.clone().add(o.direction.clone().multiplyScalar(5)),p=d.angleDeg(),m=new de.fabric.Textbox(" ".concat(this.data.force," kN"),Object(N.a)(Object(N.a)({},Je),{},{top:f.y,left:f.x,width:Math.max(u,140),angle:p,visible:!1}));return this.head.copy(h),this.direction.copy(d),this.length=u,[g,m]}},{key:"update",value:function(e){var t;e&&(this.data=e);var i=null!==(t=this.label.visible)&&void 0!==t&&t;this.manager.canvas.remove(this.force,this.label);var a=this.create(),n=Object(g.a)(a,2);this.force=n[0],this.label=n[1],this.manager.canvas.add(this.force,this.label),this.attachEvent(),i&&this.select()}},{key:"remove",value:function(){var e=this;this.manager.canvas.remove(this.force,this.label);var t=this.manager.forceMap[this.data.beam];if(t){var i=t.filter((function(t){return t.data.id!==e.data.id}));this.manager.forceMap[this.data.beam]=i}}},{key:"select",value:function(){this.manager.canvas.setActiveObject(this.force)}},{key:"attachEvent",value:function(){this.force.on("selected",this.onSelected.bind(this)),this.force.on("deselected",this.onDeselected.bind(this)),this.force.on("mousedown",this.onMouseDown.bind(this)),this.force.on("mouseup",this.onMouseUp.bind(this)),this.force.on("mousedblclick",this.onDblClick.bind(this)),this.force.on("moving",this.onMoving.bind(this)),this.force.on("moved",this.onMoved.bind(this)),this.force.on("rotating",this.onRotating.bind(this)),this.force.on("rotated",this.onRotated.bind(this)),this.force.on("scaling",this.onScaling.bind(this)),this.force.on("scaled",this.onScaled.bind(this))}},{key:"onSelected",value:function(){this.label.visible=!0}},{key:"onDeselected",value:function(){this.label.visible=!1}},{key:"onMouseDown",value:function(e){var t=this;if(!this.readonly){if("delete"===this.manager.tool)return this.remove(),void this.manager.calcForceAverage();if(["select","force"].includes(this.manager.tool)&&e.target){this.longpressTimer&&(clearTimeout(this.longpressTimer),this.longpressTimer=void 0);var i=this.force,a=i.getBoundingRect(!0,!0),n=a.top,s=a.left;this.longpressTimer=setTimeout((function(){var a=i.getBoundingRect(!0,!0),o=a.top,r=a.left;P([s,n],[r,o])&&t.manager.openForceDialog(e,t),t.longpressTimer=void 0}),qe.LongpressInterval)}}}},{key:"onMouseUp",value:function(e){this.longpressTimer&&(clearTimeout(this.longpressTimer),this.longpressTimer=void 0)}},{key:"onDblClick",value:function(e){this.readonly||this.manager.openForceDialog(e,this)}},{key:"onRotating",value:function(e){if(["select","force"].includes(this.manager.tool)){var t;if(!this.dragging)this.label.visible=!1,this.originalAngle=null!==(t=this.force.angle)&&void 0!==t?t:0;this.dragging=!0}}},{key:"onRotated",value:function(e){var t,i,a=null!==(t=this.force.angle)&&void 0!==t?t:0,n=0;if(this.originalAngle!==a){this.originalAngle<a?n=a-this.originalAngle:this.originalAngle>a&&(n=360-this.originalAngle+a),n=S(n),n=M(n,5);var s=this.originalAngle+n;s=S(s),this.force.angle=s,this.label.angle=s-90,this.label.visible=!0;var o=(null!==(i=this.data.angle)&&void 0!==i?i:0)+n;o=S(o),this.data.angle=o,this.dragging=!1}}},{key:"onScaling",value:function(e){["select","force"].includes(this.manager.tool)&&(this.dragging=!0)}},{key:"onScaled",value:function(e){if(this.dragging){var t,i=null!==(t=this.force.scaleY)&&void 0!==t?t:1,a=this.length*i;this.length=a;var n=this.calcForce();this.data.force=n,this.update(),this.select()}this.dragging=!1}},{key:"calcMovedPosition",value:function(){if(this.beam){var e,t;this.position.x=null!==(e=this.force.left)&&void 0!==e?e:0,this.position.y=null!==(t=this.force.top)&&void 0!==t?t:0;var i=this.head.distance(this.position),a=180-this.position.clone().subtract(this.head).normalize().verticalAngleDeg(),n=(this.beam.angle-a)*Math.PI/180,s=i*Math.cos(n);this.draggableMin>s?s=this.draggableMin:this.draggableMax<s&&(s=this.draggableMax),this.position.copy(this.head).add(this.beam.direction.clone().multiplyScalar(s))}}},{key:"onMoving",value:function(e){if(["select","force"].includes(this.manager.tool)){if(!this.dragging){this.label.visible=!1,this.beam=this.manager.beamMap[this.data.beam];var t=[this.beam.points[0],this.beam.points[1]];this.vi.x=t[0],this.vi.y=t[1];var i=[this.beam.points[2],this.beam.points[3]];this.vj.x=i[0],this.vj.y=i[1],this.draggableMin=-1*this.vi.distance(this.head),this.draggableMax=this.vj.distance(this.head),this.position.copy(this.head),this.dragging=!0}this.calcMovedPosition(),this.force.left=this.position.x,this.force.top=this.position.y}}},{key:"onMoved",value:function(e){if(this.beam){this.calcMovedPosition();var t=this.vi.distance(this.position);this.data.distanceI=x(t/this.beam.length,2),this.head.copy(this.vi.clone().add(this.beam.direction.clone().multiplyScalar(this.beam.length*this.data.distanceI))),this.force.left=this.head.x,this.force.top=this.head.y,this.label.left=this.head.x,this.label.top=this.head.y,this.label.visible=!0}this.beam=void 0,this.draggableMin=Number.MIN_SAFE_INTEGER,this.draggableMax=Number.MAX_SAFE_INTEGER,this.dragging=!1}}]),e}(),Re={free:"/assets/images/pins/pin_1.svg",pin:"/assets/images/pins/pin_1.svg",pinX:"/assets/images/pins/pin_2.svg",pinZ:"/assets/images/pins/pin_2.svg",fixX:"/assets/images/pins/pin_3.svg",fix:"/assets/images/pins/pin_4.svg"},_e=function(){function e(t,i){Object(le.a)(this,e),this.data=void 0,this.node=void 0,this.pin=void 0,this.manager=void 0,this.longpressTimer=void 0,this.dragging=!1,this._readonly=!1,this.manager=t,this.data=i,this.node=this.createNode(i),this.manager.canvas.add(this.node),this.loadPin(),this.attachEvents()}return Object(he.a)(e,[{key:"update",value:function(e,t,i){if("number"!==typeof e||"number"!==typeof t){if(!_(e)||"number"===typeof t){if("undefined"===typeof e){var a=this.data,n=a.x,s=a.y;this.updatePosition(n,s,!0)}throw new Error("invalid parameters")}this.updateByParams(e,t)}else this.updatePosition(e,t,i)}},{key:"updatePosition",value:function(e,t){var i=!(arguments.length>2&&void 0!==arguments[2])||arguments[2],a=Object(N.a)(Object(N.a)({},this.data),{},{x:e,y:t});this.updateByParams(a,i)}},{key:"updateByParams",value:function(e){var t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],i=e.x,a=e.y,n=e.pin;this.data=e,this.node.top=a,this.node.left=i,this.node.data=Object(N.a)(Object(N.a)({},e),{},{type:"node"}),n&&(this.pin&&this.pin.data.pin===n?("pinZ"===n?(this.pin.top=a+5,this.pin.left=i):(this.pin.top=a,this.pin.left=i+5),this.pin.visible=t):this.loadPin(t))}},{key:"remove",value:function(){this.manager.canvas.remove(this.node),this.pin&&this.manager.canvas.remove(this.pin);var e=this.manager.nodeBeamMap[this.data.id];e&&e.forEach((function(e){e.remove()})),delete this.manager.nodeMap[this.data.id],delete this.manager.nodeBeamMap[this.data.id]}},{key:"readonly",get:function(){return this._readonly},set:function(e){this._readonly=e,this.node.selectable=!e,this.node.evented=!e}},{key:"createNode",value:function(e){return new de.fabric.Circle({name:e.id,data:Object(N.a)({type:"node"},e),top:e.y,left:e.x,radius:5,fill:"black",originX:"center",originY:"center",hasBorders:!1,hasControls:!1,selectable:!this.manager.readonly,evented:!this.manager.readonly})}},{key:"setPinProperties",value:function(e){this.pin&&(this.pin.name="image/".concat(e.id),this.pin.data=Object(N.a)(Object(N.a)({},e),{},{type:"node/pin"}),this.pin.originX="center",this.pin.originY="top",this.pin.centeredRotation=!1,this.pin.top=e.y+5,this.pin.left=e.x,this.pin.scale(.15),this.pin.selectable=!1,this.pin.evented=!1,"pinZ"===e.pin&&(this.pin.top=e.y,this.pin.left=e.x+5,this.pin.rotate(-90)))}},{key:"loadPin",value:function(){var e=this,t=!(arguments.length>0&&void 0!==arguments[0])||arguments[0],i=this.data.pin;this.pin&&(this.manager.canvas.remove(this.pin),this.pin=void 0),"undefined"!==typeof i&&"free"!==i&&de.fabric.loadSVGFromURL("".concat("/drawing-sample").concat(Re[i]),(function(i,a){var n=de.fabric.util.groupSVGElements(i,a);"path"===n.type?e.pin=new de.fabric.Group([n]):e.pin=n,e.setPinProperties(e.data),e.pin.visible=t,e.manager.canvas.add(e.pin)}))}},{key:"attachEvents",value:function(){this.node.on("mousedown",this.onMouseDown.bind(this)),this.node.on("mouseup",this.onMouseUp.bind(this)),this.node.on("mousedblclick",this.onDblClick.bind(this)),this.node.on("moving",this.onMoving.bind(this)),this.node.on("moved",this.onMoved.bind(this))}},{key:"onMouseDown",value:function(e){var t=this;if(!this.readonly){if("delete"===this.manager.tool)return this.remove(),this.manager.removeUnconnectedNodes(),this.manager.updateGlobalGuidelines(),this.manager.calcForceAverage(),void this.manager.calcTrapezoidAverage();if(this.longpressTimer&&(clearTimeout(this.longpressTimer),this.longpressTimer=void 0),"select"===this.manager.tool){var i=this.node,a=i.getBoundingRect(!0,!0),n=a.top,s=a.left;this.longpressTimer=setTimeout((function(){var a=i.getBoundingRect(!0,!0),o=a.top,r=a.left;P([s,n],[r,o])&&t.manager.openNodeDialog(e,t),t.longpressTimer=void 0}),qe.LongpressInterval)}}}},{key:"onMouseUp",value:function(e){this.longpressTimer&&(clearTimeout(this.longpressTimer),this.longpressTimer=void 0)}},{key:"onDblClick",value:function(e){this.readonly||this.manager.openNodeDialog(e,this)}},{key:"onMoving",value:function(e){var t=this;if(!this.readonly&&e.pointer){var i=e.pointer,a=i.x,n=i.y,s=this.manager,o=s.nodeMap,r=s.nodeBeamMap;this.dragging||this.pin&&(this.pin.visible=!1);var c=r[this.data.id];c&&c.forEach((function(e){var i=o[e.data.nodeI],s=o[e.data.nodeJ],r=[i.data.x,i.data.y,s.data.x,s.data.y],c=r[0],l=r[1],h=r[2],d=r[3];e.data.nodeI===t.data.id?(c=a,l=n):e.data.nodeJ===t.data.id&&(h=a,d=n),e.update([c,l,h,d]),t.dragging||e.setVisibleParts(!1)})),this.dragging=!0}}},{key:"onMoved",value:function(e){var t=this;if(!this.readonly&&e.target){var i=e.target.getCenterPoint(),a=i.x,n=i.y,s=k([a,n],this.manager.snapSize),o=Object(g.a)(s,2),r=o[0],c=o[1];this.update(r,c);var l=this.manager,h=l.nodeBeamMap,d=l.nodeMap,u=h[this.data.id];if(u){var v=[];u.forEach((function(e){var t=d[e.data.nodeI],i=d[e.data.nodeJ],a=[t.data.x,t.data.y,i.data.x,i.data.y],n=a[0],s=a[1],o=a[2],r=a[3];n!==o||s!==r?(e.update([n,s,o,r]),e.updateParts()):v.push(e)})),v.length>0&&(v.forEach((function(e){e.remove()})),this.manager.calcForceAverage(),this.manager.calcTrapezoidAverage())}"undefined"===typeof this.manager.nodeBeamMap[this.data.id]&&(this.manager.nodeBeamMap[this.data.id]=[]),Object.values(this.manager.nodeMap).forEach((function(e){if(e.data.id!==t.data.id&&e.data.x===r&&e.data.y===c){t.manager.canvas.remove(e.node),e.pin&&t.manager.canvas.remove(e.pin);var i=t.manager.nodeBeamMap[e.data.id];i&&i.forEach((function(i){i.data.nodeI===e.data.id&&(i.data.nodeI=t.data.id),i.data.nodeJ===e.data.id&&(i.data.nodeJ=t.data.id),i.beam.data=Object(N.a)({type:"beam"},i.data),t.manager.nodeBeamMap[t.data.id].push(i)})),e.remove()}})),this.manager.updateGlobalGuidelines(),this.dragging=!1}}}]),e}(),Le="pink",Ge={stroke:Le,fill:Le,arrowWidth:2,arrowEdgeSize:8},We={stroke:Le,strokeWidth:2,hasControls:!1,hasBorders:!1,lockMovementX:!0,lockMovementY:!0,lockRotation:!0,lockScalingX:!0,lockScalingY:!0},Fe={fill:Le,fontSize:10,fontFamily:"sans-serif",height:10,selectable:!1,evented:!1},Ve=function(){function e(t,i){Object(le.a)(this,e),this.data=void 0,this.forceI=void 0,this.forceJ=void 0,this.arrows=void 0,this.line=void 0,this.labelI=void 0,this.labelJ=void 0,this.guide=void 0,this.manager=void 0,this.longpressTimer=void 0,this.dragging=!1,this._readonly=!1,this.selectedShapes=new Set,this.pi=new b.a(0,0),this.pj=new b.a(0,0),this.direction=new b.a(0,0),this.linePoints=[0,0,0,0],this.draggingEdge=void 0,this.beam=void 0,this.vi=new b.a(0,0),this.vj=new b.a(0,0),this.originalAngle=0,this.draggingDirection=new b.a(0,0),this.draggingPosition=new b.a(0,0),this.draggingLength=0,this.draggableMin=Number.MIN_SAFE_INTEGER,this.draggableMax=Number.MAX_SAFE_INTEGER,this.manager=t,this.data=i,this._readonly=this.manager.readonly;var a=this.create(),n=Object(g.a)(a,7);this.forceI=n[0],this.forceJ=n[1],this.arrows=n[2],this.line=n[3],this.labelI=n[4],this.labelJ=n[5],this.guide=n[6],this.addToCanvas(),this.attachEvents()}return Object(he.a)(e,[{key:"readonly",get:function(){return this._readonly},set:function(e){this._readonly=e,[this.forceI,this.forceJ].concat(Object(ce.a)(this.arrows),[this.line]).forEach((function(t){t&&(t.evented=e)}))}},{key:"visible",get:function(){var e;return null===(e=this.forceI.visible)||void 0===e||e},set:function(e){this.forceI.visible=e,this.forceJ.visible=e,this.arrows.forEach((function(t){return t.visible=e})),this.line.visible=e,this.labelI.visible=e,this.labelJ.visible=e,this.guide&&(this.guide.visible=e)}},{key:"evented",get:function(){var e;return null===(e=this.forceI.evented)||void 0===e||e},set:function(e){[this.forceI,this.forceJ].concat(Object(ce.a)(this.arrows),[this.line]).forEach((function(t){t.evented=e}))}},{key:"selectable",get:function(){var e;return null===(e=this.forceI.selectable)||void 0===e||e},set:function(e){[this.forceI,this.forceJ].concat(Object(ce.a)(this.arrows),[this.line]).forEach((function(t){t.selectable=e}))}},{key:"create",value:function(){var e,t=this,i=this.data,a=i.beam,n=i.forceI,s=i.forceJ,o=i.distanceI,r=i.distanceJ,c=i.angle,l=void 0===c?0:c,h=i.isGlobal,d=void 0!==h&&h,u=this.manager.trapezoidAverage,v=this.manager.beamMap[a],g=new b.a(v.points[0],v.points[1]);e=d?p.clone().rotateDeg(l-90).normalize():v.direction.clone().rotateDeg(l-90).normalize();var f=g.clone().add(v.direction.clone().multiplyScalar(v.length*o)),m=g.clone().add(v.direction.clone().multiplyScalar(v.length*(1-r))),y=f.clone().add(e.clone().multiplyScalar(this.calcLength(n,u))),j=m.clone().add(e.clone().multiplyScalar(this.calcLength(s,u))),O=E(f,m,v.direction),x=j.x-y.x!==0?(j.y-y.y)/(j.x-y.x):NaN,w=isNaN(x)?NaN:y.y-x*y.x,k=[];O.forEach((function(t){var i=C([y,j,x,w],t,e);if(i){var a=[t.x,t.y,i[0],i[1]];k.push(a)}}));var M=k.map((function(e){return Ce(e,Object(N.a)(Object(N.a)({},Ge),{},{hasControls:!1,hasBorders:!1,lockMovementX:!0,lockMovementY:!0,lockRotation:!0,lockScalingX:!0,lockScalingY:!0,selectable:!t.readonly,evented:!t.readonly}))})),S=Ce([f.x,f.y,y.x,y.y],Object(N.a)(Object(N.a)({},Ge),{},{name:"".concat(this.data.id,"/i"),data:Object(N.a)({type:"trapezoid/i"},this.data),selectable:!this.readonly,evented:!this.readonly})),I=Ce([m.x,m.y,j.x,j.y],Object(N.a)(Object(N.a)({},Ge),{},{name:"".concat(this.data.id,"/j"),data:Object(N.a)({type:"trapezoid/j"},this.data),selectable:!this.readonly,evented:!this.readonly})),P=this.createLine([y.x,y.y,j.x,j.y]),z=pe([f.x,f.y,m.x,m.y],50);z.visible=!1;var T=f.clone().add(v.direction.clone().multiplyScalar(5)),B=m.clone().add(v.direction.clone().multiplyScalar(5)),A=e.angleDeg(),D=this.createTrapezoidLabel("  ".concat(n," kN/m"),T,A);D.visible=!1;var J=this.createTrapezoidLabel("  ".concat(s," kN/m"),B,A);return J.visible=!1,this.pi.copy(f),this.pj.copy(m),this.direction.copy(e),[S,I,M,P,D,J,z]}},{key:"update",value:function(e){e&&(this.data=e),this.removeFromCanvas();var t=this.create(),i=Object(g.a)(t,7);this.forceI=i[0],this.forceJ=i[1],this.arrows=i[2],this.line=i[3],this.labelI=i[4],this.labelJ=i[5],this.guide=i[6],this.addToCanvas(),this.attachEvents()}},{key:"createLine",value:function(e){return this.linePoints=e,new de.fabric.Line(e,Object(N.a)(Object(N.a)({},We),{},{selectable:!this.readonly,evented:!this.readonly,name:this.data.id,data:Object(N.a)({type:"trapezoid"},this.data)}))}},{key:"updateLine",value:function(e){var t,i,a=this.manager.trapezoidAverage;e?(t=new b.a(e[0],e[1]),i=new b.a(e[2],e[3])):("i"===this.draggingEdge?(t=this.draggingPosition.clone().add(this.direction.clone().multiplyScalar(this.calcLength(this.data.forceI,a))),i=this.pj.clone().add(this.direction.clone().multiplyScalar(this.calcLength(this.data.forceJ,a)))):"j"===this.draggingEdge?(t=this.pi.clone().add(this.direction.clone().multiplyScalar(this.calcLength(this.data.forceI,a))),i=this.draggingPosition.clone().add(this.direction.clone().multiplyScalar(this.calcLength(this.data.forceJ,a)))):(t=this.pi.clone().add(this.direction.clone().multiplyScalar(this.calcLength(this.data.forceI,a))),i=this.pj.clone().add(this.direction.clone().multiplyScalar(this.calcLength(this.data.forceJ,a)))),this.linePoints=[t.x,t.y,i.x,i.y]),this.manager.canvas.remove(this.line),this.line=this.createLine([t.x,t.y,i.x,i.y]),this.manager.canvas.add(this.line)}},{key:"remove",value:function(){var e=this;this.removeFromCanvas();var t=this.manager.trapezoidMap[this.data.beam];if(t){var i=t.filter((function(t){return t.data.id!==e.data.id}));this.manager.trapezoidMap[this.data.beam]=i}}},{key:"addToCanvas",value:function(){var e;(e=this.manager.canvas).add.apply(e,[this.forceI,this.forceJ].concat(Object(ce.a)(this.arrows),[this.line,this.labelI,this.labelJ])),this.guide&&this.manager.canvas.add(this.guide),this.forceI.bringToFront(),this.forceJ.bringToFront()}},{key:"removeFromCanvas",value:function(){var e;(e=this.manager.canvas).remove.apply(e,[this.forceI,this.forceJ].concat(Object(ce.a)(this.arrows),[this.line,this.labelI,this.labelJ])),this.guide&&this.manager.canvas.remove(this.guide)}},{key:"calcForce",value:function(e){return 0===this.manager.trapezoidAverage?10:Math.round(e/25*this.manager.trapezoidAverage)}},{key:"calcLength",value:function(e,t){return isNaN(t)||0===t?25:e/t*25}},{key:"createTrapezoidLabel",value:function(e,t,i){return new de.fabric.Textbox(e,Object(N.a)(Object(N.a)({},Fe),{},{top:t.y,left:t.x,angle:i,width:140}))}},{key:"setVisibleParts",value:function(){var e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0],t=[this.labelI,this.labelJ].concat(Object(ce.a)(this.arrows));t.forEach((function(t){return t.visible=e})),this.guide&&(this.guide.visible=e)}},{key:"select",value:function(){var e=this.line;this.draggingEdge&&(e="i"===this.draggingEdge?this.forceI:this.forceJ),this.manager.canvas.setActiveObject(e)}},{key:"attachEvents",value:function(){var e=this,t=[this.forceI,this.forceJ];[this.forceI,this.forceJ].concat(Object(ce.a)(this.arrows),[this.line]).forEach((function(t){t.on("selected",e.onSelected.bind(e)),t.on("deselected",e.onDeselected.bind(e)),t.on("mousedown",e.onMouseDown.bind(e)),t.on("mouseup",e.onMouseUp.bind(e)),t.on("mousedblclick",e.onDblClick.bind(e))})),t.forEach((function(t){t.on("moving",e.onMoving.bind(e)),t.on("moved",e.onMoved.bind(e)),t.on("rotating",e.onRotating.bind(e)),t.on("rotated",e.onRotated.bind(e)),t.on("scaling",e.onScaling.bind(e)),t.on("scaled",e.onScaled.bind(e))}))}},{key:"onSelected",value:function(e){var t,i=null===(t=e.target)||void 0===t?void 0:t.name;i&&this.selectedShapes.add(i),this.labelI.visible=!0,this.labelJ.visible=!0,this.guide&&(this.guide.visible=!0)}},{key:"onDeselected",value:function(e){var t,i=null===(t=e.target)||void 0===t?void 0:t.name;i&&this.selectedShapes.delete(i),0===this.selectedShapes.size&&(this.labelI.visible=!1,this.labelJ.visible=!1,this.guide&&(this.guide.visible=!1))}},{key:"onMouseDown",value:function(e){var t=this;if(!this.readonly){if("delete"===this.manager.tool)return this.remove(),void this.manager.calcTrapezoidAverage();if(["select","trapezoid"].includes(this.manager.tool)&&e.target){this.longpressTimer&&(clearTimeout(this.longpressTimer),this.longpressTimer=void 0);var i=e.target,a=i.getBoundingRect(!0,!0),n=a.top,s=a.left;this.longpressTimer=setTimeout((function(){var a=i.getBoundingRect(!0,!0),o=a.top,r=a.left;P([s,n],[r,o])&&t.manager.openTrapezoidDialog(e,t),t.longpressTimer=void 0}),qe.LongpressInterval)}}}},{key:"onMouseUp",value:function(e){this.longpressTimer&&(clearTimeout(this.longpressTimer),this.longpressTimer=void 0)}},{key:"onDblClick",value:function(e){this.readonly||this.manager.openTrapezoidDialog(e,this)}},{key:"calcDraggableRange",value:function(){if(this.beam&&this.draggingEdge){var e=[this.beam.points[0],this.beam.points[1]];this.vi.x=e[0],this.vi.y=e[1];var t=[this.beam.points[2],this.beam.points[3]];if(this.vj.x=t[0],this.vj.y=t[1],"i"===this.draggingEdge)if(this.draggableMin=-1*this.vi.distance(this.pi),1-(this.data.distanceJ+.05)<this.data.distanceI)this.draggableMax=0;else{var i=1-(this.data.distanceJ+.05),a=y(this.vi,this.vj,i);this.draggableMax=this.pi.distance(a)}else if("j"===this.draggingEdge)if(this.draggableMax=this.vj.distance(this.pj),1-this.data.distanceJ<this.data.distanceI+.05)this.draggableMin=0;else{var n=y(this.vi,this.vj,this.data.distanceI+.05);this.draggableMin=-1*this.pj.distance(n)}}}},{key:"moveArrow",value:function(e,t){if(this.beam){var i,a;this.draggingPosition.x=null!==(i=e.left)&&void 0!==i?i:0,this.draggingPosition.y=null!==(a=e.top)&&void 0!==a?a:0;var n=t.distance(this.draggingPosition);this.draggingDirection.copy(this.draggingPosition.clone().subtract(t).normalize());var s=180-this.draggingDirection.verticalAngleDeg(),o=(this.beam.angle-s)*Math.PI/180,r=n*Math.cos(o);this.draggableMin>r?r=this.draggableMin:this.draggableMax<r&&(r=this.draggableMax),this.draggingPosition.copy(t).add(this.beam.direction.clone().multiplyScalar(r)),e.left=this.draggingPosition.x,e.top=this.draggingPosition.y,this.updateLine()}}},{key:"checkDraggingEdge",value:function(e){var t;if(e.transform)switch(null===(t=e.transform.target.data)||void 0===t?void 0:t.type){case"trapezoid/i":return"i";case"trapezoid/j":return"j"}}},{key:"onMoving",value:function(e){["select","trapezoid"].includes(this.manager.tool)&&e.transform&&(this.dragging||(this.setVisibleParts(!1),this.beam=this.manager.beamMap[this.data.beam],this.draggingEdge=this.checkDraggingEdge(e),this.draggingEdge&&(this.calcDraggableRange(),this.dragging=!0)),"i"===this.draggingEdge?this.moveArrow(this.forceI,this.pi):"j"===this.draggingEdge&&this.moveArrow(this.forceJ,this.pj))}},{key:"onMoved",value:function(e){if(this.beam&&this.dragging){if("i"===this.draggingEdge){this.moveArrow(this.forceI,this.pi);var t=this.vi.distance(this.draggingPosition);this.data.distanceI=x(t/this.beam.length,2)}else if("j"===this.draggingEdge){this.moveArrow(this.forceJ,this.pj);var i=this.vj.distance(this.draggingPosition);this.data.distanceJ=x(i/this.beam.length,2)}this.update(),this.select()}this.dragging=!1,this.beam=void 0,this.draggableMin=Number.MIN_SAFE_INTEGER,this.draggableMax=Number.MAX_SAFE_INTEGER,this.draggingEdge=void 0}},{key:"onScaling",value:function(e){if(["select","trapezoid"].includes(this.manager.tool)&&e.transform){if(!this.dragging){var t;if(this.setVisibleParts(!1),this.draggingEdge=this.checkDraggingEdge(e),"i"===this.draggingEdge)this.draggingLength=null!==(t=this.forceI.height)&&void 0!==t?t:0;else if("j"===this.draggingEdge){var i;this.draggingLength=null!==(i=this.forceJ.height)&&void 0!==i?i:0}this.dragging=!0}var a;if("i"===this.draggingEdge?(a=this.forceI,this.draggingPosition.copy(this.pi)):"j"===this.draggingEdge&&(a=this.forceJ,this.draggingPosition.copy(this.pj)),a){var n,s=null!==(n=a.scaleY)&&void 0!==n?n:1,o=this.draggingLength*s;this.draggingPosition.add(this.direction.clone().multiplyScalar(o)),"i"===this.draggingEdge?(this.linePoints[0]=this.draggingPosition.x,this.linePoints[1]=this.draggingPosition.y):"j"===this.draggingEdge&&(this.linePoints[2]=this.draggingPosition.x,this.linePoints[3]=this.draggingPosition.y),this.updateLine(this.linePoints)}}}},{key:"onScaled",value:function(e){var t;if(this.dragging&&("i"===this.draggingEdge?t=this.forceI:"j"===this.draggingEdge&&(t=this.forceJ),t)){var i,a=null!==(i=t.scaleY)&&void 0!==i?i:1,n=this.draggingLength*a,s=this.calcForce(n);"i"===this.draggingEdge?this.data.forceI=s:"j"===this.draggingEdge&&(this.data.forceJ=s),this.update(),this.select()}this.dragging=!1,this.draggingEdge=void 0}},{key:"onRotating",value:function(e){if(["select","trapezoid"].includes(this.manager.tool)&&e.transform){if(!this.dragging){var t;if(this.setVisibleParts(!1),this.draggingEdge=this.checkDraggingEdge(e),"i"===this.draggingEdge)this.originalAngle=null!==(t=this.forceI.angle)&&void 0!==t?t:0;else if("j"===this.draggingEdge){var i;this.originalAngle=null!==(i=this.forceJ.angle)&&void 0!==i?i:0}this.dragging=!0}if(this.draggingEdge){var a,n,s,o=0;if("i"===this.draggingEdge)o=null!==(s=this.forceI.angle)&&void 0!==s?s:0,this.forceJ.angle=o;else if("j"===this.draggingEdge){var r;o=null!==(r=this.forceJ.angle)&&void 0!==r?r:0,this.forceI.angle=o}var c=m.clone().invert(),l=this.pi.clone().add(c.clone().multiplyScalar(null!==(a=this.forceI.height)&&void 0!==a?a:0).rotateDeg(o)),h=this.pj.clone().add(c.clone().multiplyScalar(null!==(n=this.forceJ.height)&&void 0!==n?n:0).rotateDeg(o));this.linePoints=[l.x,l.y,h.x,h.y],this.updateLine(this.linePoints)}}}},{key:"onRotated",value:function(e){if(this.dragging){var t,i,a=0;if("i"===this.draggingEdge)a=null!==(i=this.forceI.angle)&&void 0!==i?i:0;else if("j"===this.draggingEdge){var n;a=null!==(n=this.forceJ.angle)&&void 0!==n?n:0}if(this.originalAngle===a)return;var s=0;s=a-this.originalAngle>0?a-this.originalAngle:360-this.originalAngle+a,s=M(s,5);var o=(null!==(t=this.data.angle)&&void 0!==t?t:0)+s;o=S(o),this.data.angle=o,this.update(),this.select()}this.dragging=!1,this.draggingEdge=void 0}}]),e}(),Xe=function(e){return!(!Array.isArray(e)||3!==e.length)&&(("M"===e[0]||"m"===e[0])&&"number"===typeof e[1]&&"number"===typeof e[2])},Ye=function(e){return!(!Array.isArray(e)||3!==e.length)&&(("L"===e[0]||"l"===e[0])&&"number"===typeof e[1]&&"number"===typeof e[2])},Ze={stroke:"#eee",strokeWidth:1,evented:!1,hasControls:!1,selectable:!1,excludeFromExport:!0,data:{type:"background",excludeExport:!0}},He=function(){function e(t,i,a){var n=this;Object(le.a)(this,e),this.canvas=void 0,this._tool="pen",this._readonly=!1,this.snapSize=25,this.gridSize=25,this._props=void 0,this._data=void 0,this.openPopup=void 0,this.eventType=void 0,this.hasSelected=!1,this.pinching=!1,this.panning=!1,this.lastPos=void 0,this.forceAverage=0,this.trapezoidAverage=0,this.nodeMap={},this.beamMap={},this.nodeBeamMap={},this.forceMap={},this.momentMap={},this.trapezoidMap={},this.globalGuideLines=[],this.zoomStartScale=1,this._initialized=!1,this.currentBeam=void 0;var s=i.data,o=i.zoom,r=i.viewport,c=i.tool,l=i.readonly,h=void 0!==l&&l,d=i.snapSize,u=void 0===d?25:d,v=i.gridSize,g=void 0===v?25:v,f=t.getBoundingClientRect(),b=f.width,p=f.height;this._props=i,this._data=s,this.canvas=new de.fabric.Canvas(t,{selection:!0,isDrawingMode:!1,fireRightClick:!0,stopContextMenu:!0}),this.canvas.setZoom(o),r&&this.canvas.setViewportTransform(r),this.resize({width:b,height:p}),this.snapSize=u,this.gridSize=g,this.openPopup=a,this.drawBackgroundGrid();var m=s.nodes,y=s.beams,j=s.forces,O=s.moments,x=s.trapezoids;this.calcForceAverage(j),this.calcTrapezoidAverage(x),m.forEach((function(e){var t=new _e(n,e);n.nodeMap[e.id]=t})),y.forEach((function(e){var t=new Ae(n,e);n.beamMap[e.id]=t,"undefined"===typeof n.nodeBeamMap[e.nodeI]?n.nodeBeamMap[e.nodeI]=[t]:n.nodeBeamMap[e.nodeI].push(t),"undefined"===typeof n.nodeBeamMap[e.nodeJ]?n.nodeBeamMap[e.nodeJ]=[t]:n.nodeBeamMap[e.nodeJ].push(t)})),j.forEach((function(e){var t=new Ne(n,e);"undefined"===typeof n.forceMap[e.beam]?n.forceMap[e.beam]=[t]:n.forceMap[e.beam].push(t)})),O.forEach((function(e){var t=new Be(n,e);"undefined"===typeof n.momentMap[e.beam]?n.momentMap[e.beam]=[t]:n.momentMap[e.beam].push(t)})),x.forEach((function(e){var t=new Ve(n,e);"undefined"===typeof n.trapezoidMap[e.beam]?n.trapezoidMap[e.beam]=[t]:n.trapezoidMap[e.beam].push(t)})),this.updateGlobalGuidelines(),this.attachEvent(),this.tool=c,this.readonly=h,this.canvas.renderAll(),this._initialized=!0}return Object(he.a)(e,[{key:"tool",get:function(){return this._tool},set:function(e){this._tool=e,this.canvas.discardActiveObject(),"select"===e||"force"===e||"delete"===e?this.canvas.selection="select"===e:(this.canvas.selection=!1,this.setBrush()),this.setSelectableShapes()}},{key:"readonly",get:function(){return this._readonly},set:function(e){this._readonly=e,this.setSelectableShapes()}},{key:"initialized",get:function(){return this._initialized}},{key:"resize",value:function(e){var t=e.width,i=e.height;this.canvas.setWidth(t),this.canvas.setHeight(i)}},{key:"toCanvasProps",value:function(){var e,t=Object.values(this.nodeMap).map((function(e){return e.data})),i=Object.values(this.beamMap).map((function(e){return e.data})),a=Object.values(this.forceMap).flatMap((function(e){return e.map((function(e){return e.data}))})),n=Object.values(this.momentMap).flatMap((function(e){return e.map((function(e){return e.data}))})),s=Object.values(this.trapezoidMap).flatMap((function(e){return e.map((function(e){return e.data}))})),o=this.canvas.toSVG({suppressPreamble:!0}),r=null!==(e=this.canvas.viewportTransform)&&void 0!==e?e:this._props.viewport,c=this.canvas.getZoom();return Object(N.a)(Object(N.a)({},this._props),{},{data:Object(N.a)(Object(N.a)({},this._data),{},{nodes:t,beams:i,forces:a,moments:n,trapezoids:s}),image:o,zoom:c,viewport:r})}},{key:"openNodeDialog",value:function(e,t){var i=I(e);if(i){var a=i.x,n=i.y;this.openPopup("nodes",{top:n,left:a},t.data,(function(e){_(e)&&t.update(e)}))}}},{key:"openForceDialog",value:function(e,t){var i=I(e);if(i){var a=i.x,n=i.y;this.openPopup("forces",{top:n,left:a},t.data,(function(e){G(e)&&t.update(e)}))}}},{key:"openTrapezoidDialog",value:function(e,t){var i=I(e);if(i){var a=i.x,n=i.y;this.openPopup("trapezoids",{top:n,left:a},t.data,(function(e){F(e)&&t.update(e)}))}}},{key:"openMomentDialog",value:function(e,t){var i=I(e);if(i){var a=i.x,n=i.y;this.openPopup("moments",{top:n,left:a},t.data,(function(e){W(e)&&t.update(e)}))}}},{key:"calcForceAverage",value:function(e){var t=null!==e&&void 0!==e?e:[];"undefined"===typeof e&&(t=Object.values(this.forceMap).flatMap((function(e){return e.map((function(e){return e.data}))})));var i=0;t.length>0&&(i=t.reduce((function(e,t){return Object(N.a)(Object(N.a)({},e),{},{force:e.force+t.force})})).force/t.length);this.forceAverage=i}},{key:"calcTrapezoidAverage",value:function(e){var t=null!==e&&void 0!==e?e:[];"undefined"===typeof e&&(t=Object.values(this.trapezoidMap).flatMap((function(e){return e.map((function(e){return e.data}))})));var i=0;t.length>0&&(i=t.map((function(e){return e.forceI+e.forceJ})).reduce((function(e,t){return e+t}))/(2*t.length));this.trapezoidAverage=i}},{key:"updateGlobalGuidelines",value:function(){var e,t,i;this.globalGuideLines.length>0&&((i=this.canvas).remove.apply(i,Object(ce.a)(this.globalGuideLines)),this.globalGuideLines.length=0);var a=Object.values(this.nodeMap).map((function(e){return e.data})),n=je(a,this._props.height);(e=this.globalGuideLines).push.apply(e,Object(ce.a)(n)),(t=this.canvas).add.apply(t,Object(ce.a)(n))}},{key:"removeUnconnectedNodes",value:function(){var e=this;Object.entries(this.nodeBeamMap).forEach((function(t){var i=Object(g.a)(t,2),a=i[0],n=i[1];if("undefined"===typeof n||0===n.length){var s=e.nodeMap[a];s&&s.remove(),delete e.nodeBeamMap[a]}}))}},{key:"drawBackgroundGrid",value:function(){for(var e,t=[],i=this._props,a=i.height,n=i.width,s=0;s<=a;s+=this.gridSize){var o=new de.fabric.Line([0,s,n,s],Object(N.a)({},Ze));t.push(o)}var r=new de.fabric.Line([0,a,n,a],Object(N.a)({},Ze));t.push(r);for(var c=0;c<=n;c+=this.gridSize){var l=new de.fabric.Line([c,0,c,a],Object(N.a)({},Ze));t.push(l)}var h=new de.fabric.Line([n,0,n,a],Object(N.a)({},Ze));t.push(h),(e=this.canvas).add.apply(e,t)}},{key:"addNodeIfNotExists",value:function(e,t){var i=Object.entries(this.nodeMap).find((function(i){var a=Object(g.a)(i,2)[1];return a.data.x===e&&a.data.y===t}));if(i)return Object(g.a)(i,1)[0];var a=Object(z.a)(),n=new _e(this,{id:a,name:a,x:e,y:t});return this.nodeMap[a]=n,a}},{key:"addBeamIfNotExists",value:function(e,t){var i=this,a=[e,t],n=Object.entries(this.beamMap).find((function(e){var t=Object(g.a)(e,2)[1];return a.includes(t.data.nodeI)&&a.includes(t.data.nodeJ)}));if(n)return Object(g.a)(n,1)[0];var s=Object(z.a)(),o=new Ae(this,{id:s,name:s,nodeI:e,nodeJ:t});return this.beamMap[s]=o,a.forEach((function(e){"undefined"===typeof i.nodeBeamMap[e]&&(i.nodeBeamMap[e]=[]),i.nodeBeamMap[e].push(o)})),s}},{key:"setSelectableShapes",value:function(){var e=this,t=!this.readonly,i="select"===this.tool,a=t&&["select","delete"].includes(this.tool),n="select"===this.tool,s=t,o=["select","force"].includes(this.tool),r=t&&["select","force","delete"].includes(this.tool),c=["select","moment"].includes(this.tool),l=t&&["select","moment","delete"].includes(this.tool),h=["select","trapezoid"].includes(this.tool),d=t&&["select","trapezoid","delete"].includes(this.tool);Object.values(this.nodeMap).forEach((function(e){e.node.selectable=i,e.node.evented=a})),Object.entries(this.beamMap).forEach((function(t){var i=Object(g.a)(t,2),a=i[0],u=i[1];u.beam.selectable=n,u.beam.evented=s;var v=e.forceMap[a];v&&v.forEach((function(e){e.force.selectable=o,e.force.evented=r}));var f=e.momentMap[a];f&&f.forEach((function(e){e.moment.selectable=c,e.moment.evented=l}));var b=e.trapezoidMap[a];b&&b.forEach((function(e){e.evented=d,e.selectable=h}))}))}},{key:"setBrush",value:function(){var e=this.canvas.freeDrawingBrush;switch(Boolean(e)||(e=new de.fabric.PencilBrush(this.canvas),this.canvas.freeDrawingBrush=e),this.tool){case"pen":e.color="#0000ff";break;case"trapezoid":e.color="#ff0000";break;default:e.color="#000"}e.width=2}},{key:"fitViewport",value:function(e,t){var i=this.canvas.viewportTransform,a=this.canvas.getZoom(),n=this.canvas.getWidth(),s=this.canvas.getHeight(),o=this._props,r=o.width,c=o.height;if(i){var l=i[4],h=i[5];n>=r*a?l=n/2-r*a/2:("number"===typeof e&&(l+=e),l>=0?l=0:l<n-r*a&&(l=n-r*a)),s>=c*a?h=s/2-c*a/2:("number"===typeof t&&(h+=t),h>=0?h=0:h<s-c*a&&(h=s-c*a)),i[4]=l,i[5]=h,this.canvas.requestRenderAll()}}},{key:"attachEvent",value:function(){this.canvas.on("mouse:down:before",this.onMouseDownBefore.bind(this)),this.canvas.on("mouse:down",this.onMouseDown.bind(this)),this.canvas.on("mouse:move",this.onMouseMove.bind(this)),this.canvas.on("mouse:up",this.onMouseUp.bind(this)),this.canvas.on("selection:created",this.onSelect.bind(this)),this.canvas.on("selection:updated",this.onSelect.bind(this)),this.canvas.on("selection:cleared",this.onDeselect.bind(this)),this.canvas.on("path:created",this.onCreatePath.bind(this)),this.canvas.on("object:added",this.onCreateObject.bind(this)),this.canvas.on("touch:drag",this.onTouchDrag.bind(this)),this.canvas.on("touch:gesture",this.onTouchGesture.bind(this)),this.canvas.on("mouse:wheel",this.onMouseWheel.bind(this))}},{key:"onMouseDownBefore",value:function(e){var t,i,a,n=null!==(t=null===(i=e.target)||void 0===i||null===(a=i.data)||void 0===a?void 0:a.type)&&void 0!==t?t:"canvas";if(0===e.e.type.indexOf("touch")){this.eventType="touch";var s=e.e.touches;s.length,1===s.length?"pen"===this.tool||"trapezoid"===this.tool&&"beam"===n?this.canvas.isDrawingMode=!0:(this.canvas.isDrawingMode=!1,this.hasSelected||Boolean(e.target)||(this.panning=!0)):this.canvas.isDrawingMode=!1,2===s.length&&(this.pinching=!0),s.length>2&&(this.panning=!0)}else if(0===e.e.type.indexOf("mouse")){this.eventType="mouse";var o=e.e.button;0===o&&("pen"===this.tool||"trapezoid"===this.tool&&"beam"===n?this.canvas.isDrawingMode=!0:(this.canvas.isDrawingMode=!1,this.hasSelected||Boolean(e.target)||(this.panning=!0))),2===o&&(this.panning=!0)}this.panning&&(this.canvas.selection=!1)}},{key:"onMouseDown",value:function(e){this.lastPos=I(e)}},{key:"onTouchGesture",value:function(e){if(this.pinching&&0===e.e.type.indexOf("touch")){var t=e.e.touches;if(t&&2===t.length&&e.self){"start"===e.self.state&&(this.zoomStartScale=this.canvas.getZoom());var i=this.zoomStartScale*e.self.scale;i>20&&(i=20),i<.1&&(i=.1);var a=new de.fabric.Point(e.self.x,e.self.y);this.canvas.zoomToPoint(a,i),this.fitViewport()}}}},{key:"onMouseWheel",value:function(e){if(0===e.e.type.indexOf("wheel")){var t=e.e,i=t.deltaY,a=t.offsetX,n=t.offsetY,s=this.canvas.getZoom();(s*=Math.pow(.999,i))>20&&(s=20),s<.1&&(s=.1);var o=new de.fabric.Point(a,n);this.canvas.zoomToPoint(o,s),t.preventDefault(),t.stopPropagation(),this.fitViewport()}}},{key:"onTouchDrag",value:function(e){if("touch"===this.eventType&&this.panning){var t=I(e);if(t&&this.lastPos){var i=t.x,a=t.y,n=i-this.lastPos.x,s=a-this.lastPos.y;this.fitViewport(n,s),this.lastPos=t}}}},{key:"onMouseMove",value:function(e){if("mouse"===this.eventType&&this.panning){var t=I(e);if(t&&this.lastPos){var i=t.x,a=t.y,n=i-this.lastPos.x,s=a-this.lastPos.y;this.fitViewport(n,s),this.lastPos=t}}}},{key:"onMouseUp",value:function(e){if(this.panning||this.pinching){var t=this.canvas.viewportTransform;t&&this.canvas.setViewportTransform(t)}this.canvas.selection="select"===this.tool,this.canvas.isDrawingMode=!1,this.panning=!1,this.pinching=!1,this.lastPos=void 0}},{key:"onSelect",value:function(){this.hasSelected=!0}},{key:"onDeselect",value:function(){this.hasSelected=!1}},{key:"onCreatePath",value:function(e){if((I=e)&&"object"===typeof I&&"object"===typeof I.path){var t=e.path.path;if(t&&function(e){if(Array.isArray(e)){if(e.length>0){var t=e[0],i=e[e.length-1];return Xe(t)&&Ye(i)}return!0}return!1}(t)&&t.length>=2){var i=t[0],a=t[t.length-1];if(Xe(i)&&Ye(a)){var n=Object(g.a)(i,3),s=n[1],o=n[2],r=Object(g.a)(a,3),c=r[1],l=r[2];if(s===c&&o===l)return;if(s>c||s===c&&o>l){var h=[c,s];s=h[0],c=h[1];var d=[l,o];o=d[0],l=d[1]}if("pen"===this.tool){var u=k([s,o],this.snapSize),v=Object(g.a)(u,2);s=v[0],o=v[1];var f=k([c,l],this.snapSize),p=Object(g.a)(f,2);c=p[0],l=p[1];var m=this.addNodeIfNotExists(s,o),y=this.addNodeIfNotExists(c,l);this.addBeamIfNotExists(m,y),this.updateGlobalGuidelines()}else if("trapezoid"===this.tool&&this.currentBeam){var j=this.beamMap[this.currentBeam];if(j){var O=new b.a(s,o),x=new b.a(c,l),w=j.calcRatio(O),M=1-j.calcRatio(x),S=Object(z.a)(),E={id:S,name:S,beam:j.data.id,forceI:10,forceJ:10,distanceI:w,distanceJ:M},C=new Ve(this,E);"undefined"===typeof this.trapezoidMap[j.data.id]&&(this.trapezoidMap[j.data.id]=[]),this.trapezoidMap[j.data.id].push(C),this.calcTrapezoidAverage()}this.canvas.isDrawingMode=!1,this.currentBeam=void 0}}}}var I}},{key:"onCreateObject",value:function(e){var t;"path"===(null===(t=e.target)||void 0===t?void 0:t.type)&&this.canvas.remove(e.target)}},{key:"dispose",value:function(){this._initialized&&(this.canvas.clear(),this.canvas.dispose())}}]),e}();He.LongpressInterval=1e3;var Ue,qe=He,Ke=Object(r.createContext)(void 0),Qe=function(e){var t=e.children,i=Object(r.useState)(),a=Object(g.a)(i,2),n=a[0],s=a[1],o=Object(r.useState)({top:0,left:0}),c=Object(g.a)(o,2),l=c[0],h=c[1],d=Object(r.useState)({}),u=Object(g.a)(d,2),v=u[0],f=u[1],b=Object(r.useRef)(),p=Object(r.useCallback)((function(e,t,i,a){s(e),h(t),f(null!==i&&void 0!==i?i:{}),b.current=a}),[]),m=Object(r.useCallback)((function(){s(void 0),h({top:0,left:0}),f({}),b.current=void 0}),[]),y=Object(r.useCallback)((function(e){b.current&&b.current(e)}),[]);return Object(T.jsx)(Ke.Provider,{value:{popupType:n,setPopupType:s,popupPosition:l,setPopupPosition:h,open:p,close:m,popupParams:v,callback:y},children:t})},$e=["canvasSize"],et=function(e,t){var i=e.canvasSize,a=Object(re.a)(e,$e),n=Object(r.useContext)(Ke).open,s=Object(r.useRef)(null),o=Object(r.useRef)();return Object(r.useImperativeHandle)(t,(function(){return{getStructure:function(){return o.current?o.current.toCanvasProps():Z}}})),Object(r.useLayoutEffect)((function(){s.current&&0!==i.width&&0!==i.height&&("undefined"===typeof o.current?o.current=new qe(s.current,a,n):o.current.resize(i))}),[i,n,a]),Object(r.useEffect)((function(){o.current&&o.current.tool!==a.tool&&(o.current.tool=a.tool)}),[a.tool]),Object(T.jsx)("canvas",{ref:s,width:i.width,height:i.height})},tt=Object(r.forwardRef)(et),it=i(190),at=i(166),nt=i(178),st=i(192),ot=i(185),rt=["values"],ct=function(e){var t=e.force,i=e.onChange,a=e.onClose,n=Object(r.useState)(""),s=Object(g.a)(n,2),o=s[0],c=s[1],l=Object(r.useState)(),h=Object(g.a)(l,2),d=h[0],u=h[1],v=Object(r.useCallback)((function(e){if(e.preventDefault(),e.currentTarget.checkValidity()&&"undefined"===typeof d){var n=parseFloat(o);isNaN(n)||(i&&i(Object(N.a)(Object(N.a)({},t),{},{force:n})),a())}}),[d,i,a,o,t]),f=Object(r.useCallback)((function(e){var t,i=e.currentTarget.value;c(i),0===i.length&&(t="\u6570\u5024\u3092\u5165\u529b\u3057\u3066\u304f\u3060\u3055\u3044");var a=parseFloat(i);isNaN(a)&&(t="\u6570\u5024\u3092\u5165\u529b\u3057\u3066\u304f\u3060\u3055\u3044"),(0>a||a>Number.MAX_SAFE_INTEGER)&&(t="0 \u3088\u308a\u5927\u304d\u3044\u5024\u3092\u5165\u529b\u3057\u3066\u304f\u3060\u3055\u3044"),u(t)}),[]);return Object(r.useEffect)((function(){c("".concat(t.force)),u(void 0)}),[t]),Object(T.jsx)(it.a,{children:Object(T.jsxs)(at.a,{direction:"column",spacing:1,sx:{p:1,width:240},component:"form",autoComplete:"off",noValidate:!0,onSubmit:v,children:[Object(T.jsx)(nt.a,{variant:"outlined",margin:"dense",size:"small",label:"\u96c6\u4e2d\u8377\u91cd",value:o,required:!0,fullWidth:!0,onChange:f,InputProps:{endAdornment:Object(T.jsx)(st.a,{position:"end",children:"kN"})},error:Boolean(d),helperText:d}),Object(T.jsxs)(at.a,{direction:"row",justifyContent:"flex-end",spacing:1,children:[Object(T.jsx)(ot.a,{size:"small",onClick:a,children:"\u30ad\u30e3\u30f3\u30bb\u30eb"}),Object(T.jsx)(ot.a,{type:"submit",size:"small",variant:"contained",children:"OK"})]})]})})},lt=function(e){var t=e.values,i=Object(re.a)(e,rt),a=Object(r.useMemo)((function(){return G(t)?t:{id:"",name:"",beam:"",force:0,distanceI:0}}),[t]);return Object(T.jsx)(ct,Object(N.a)(Object(N.a)({},i),{},{force:a}))},ht=["values"],dt=function(e){var t=e.moment,i=e.onChange,a=e.onClose,n=Object(r.useState)(""),s=Object(g.a)(n,2),o=s[0],c=s[1],l=Object(r.useState)(),h=Object(g.a)(l,2),d=h[0],u=h[1],v=Object(r.useCallback)((function(e){if(e.preventDefault(),e.currentTarget.checkValidity()&&"undefined"===typeof d){var n=parseFloat(o);isNaN(n)||(i&&i(Object(N.a)(Object(N.a)({},t),{},{moment:n})),a())}}),[d,o,i,t,a]),f=Object(r.useCallback)((function(e){var t,i=e.currentTarget.value;c(i),0===i.length&&(t="\u6570\u5024\u3092\u5165\u529b\u3057\u3066\u304f\u3060\u3055\u3044");var a=parseFloat(i);isNaN(a)&&(t="\u6570\u5024\u3092\u5165\u529b\u3057\u3066\u304f\u3060\u3055\u3044"),u(t)}),[]);return Object(r.useEffect)((function(){c("".concat(t.moment)),u(void 0)}),[t]),Object(T.jsx)(it.a,{children:Object(T.jsxs)(at.a,{direction:"column",spacing:1,sx:{p:1,width:240},component:"form",autoComplete:"off",noValidate:!0,onSubmit:v,children:[Object(T.jsx)(nt.a,{variant:"outlined",margin:"dense",size:"small",label:"\u30e2\u30fc\u30e1\u30f3\u30c8\u8377\u91cd",value:o,required:!0,fullWidth:!0,onChange:f,InputProps:{endAdornment:Object(T.jsx)(st.a,{position:"end",children:"kN"})},error:Boolean(d),helperText:d}),Object(T.jsxs)(at.a,{direction:"row",justifyContent:"flex-end",spacing:1,children:[Object(T.jsx)(ot.a,{size:"small",onClick:a,children:"\u30ad\u30e3\u30f3\u30bb\u30eb"}),Object(T.jsx)(ot.a,{type:"submit",size:"small",variant:"contained",children:"OK"})]})]})})},ut=function(e){var t=e.values,i=Object(re.a)(e,ht),a=Object(r.useMemo)((function(){return W(t)?t:{id:"",name:"",beam:"",moment:0,distanceI:0}}),[t]);return Object(T.jsx)(dt,Object(N.a)(Object(N.a)({},i),{},{moment:a}))},vt=i(87),gt=i.n(vt),ft=i(94),bt=i(186),pt=i(193),mt=["title","titleId"];function yt(){return yt=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var i=arguments[t];for(var a in i)Object.prototype.hasOwnProperty.call(i,a)&&(e[a]=i[a])}return e},yt.apply(this,arguments)}function jt(e,t){if(null==e)return{};var i,a,n=function(e,t){if(null==e)return{};var i,a,n={},s=Object.keys(e);for(a=0;a<s.length;a++)i=s[a],t.indexOf(i)>=0||(n[i]=e[i]);return n}(e,t);if(Object.getOwnPropertySymbols){var s=Object.getOwnPropertySymbols(e);for(a=0;a<s.length;a++)i=s[a],t.indexOf(i)>=0||Object.prototype.propertyIsEnumerable.call(e,i)&&(n[i]=e[i])}return n}function Ot(e,t){var i=e.title,a=e.titleId,n=jt(e,mt);return r.createElement("svg",yt({id:"svg",viewBox:"0 0 160 160",xmlns:"http://www.w3.org/2000/svg",ref:t,"aria-labelledby":a},n),i?r.createElement("title",{id:a},i):null,Ue||(Ue=r.createElement("path",{d:"M80 0 L30 80 L130 80 Z",strokeWidth:6,stroke:"gray",fill:"transparent"})))}var xt,wt,kt,Mt,St=r.forwardRef(Ot),Et=(i.p,["title","titleId"]);function Ct(){return Ct=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var i=arguments[t];for(var a in i)Object.prototype.hasOwnProperty.call(i,a)&&(e[a]=i[a])}return e},Ct.apply(this,arguments)}function It(e,t){if(null==e)return{};var i,a,n=function(e,t){if(null==e)return{};var i,a,n={},s=Object.keys(e);for(a=0;a<s.length;a++)i=s[a],t.indexOf(i)>=0||(n[i]=e[i]);return n}(e,t);if(Object.getOwnPropertySymbols){var s=Object.getOwnPropertySymbols(e);for(a=0;a<s.length;a++)i=s[a],t.indexOf(i)>=0||Object.prototype.propertyIsEnumerable.call(e,i)&&(n[i]=e[i])}return n}function Pt(e,t){var i=e.title,a=e.titleId,n=It(e,Et);return r.createElement("svg",Ct({id:"svg",viewBox:"0 0 160 160",xmlns:"http://www.w3.org/2000/svg",ref:t,"aria-labelledby":a},n),i?r.createElement("title",{id:a},i):null,xt||(xt=r.createElement("path",{d:"M80 0 L30 80 L130 80 Z",strokeWidth:6,stroke:"gray",fill:"transparent"})),wt||(wt=r.createElement("circle",{stroke:"gray",strokeWidth:6,fill:"transparent",cx:45,cy:115,r:20})),kt||(kt=r.createElement("circle",{stroke:"gray",strokeWidth:6,fill:"transparent",cx:115,cy:115,r:20})),Mt||(Mt=r.createElement("line",{x1:30,y1:150,x2:130,y2:150,stroke:"gray",strokeWidth:6})))}var zt,Tt,Bt,At,Dt=r.forwardRef(Pt),Jt=(i.p,["title","titleId"]);function Nt(){return Nt=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var i=arguments[t];for(var a in i)Object.prototype.hasOwnProperty.call(i,a)&&(e[a]=i[a])}return e},Nt.apply(this,arguments)}function Rt(e,t){if(null==e)return{};var i,a,n=function(e,t){if(null==e)return{};var i,a,n={},s=Object.keys(e);for(a=0;a<s.length;a++)i=s[a],t.indexOf(i)>=0||(n[i]=e[i]);return n}(e,t);if(Object.getOwnPropertySymbols){var s=Object.getOwnPropertySymbols(e);for(a=0;a<s.length;a++)i=s[a],t.indexOf(i)>=0||Object.prototype.propertyIsEnumerable.call(e,i)&&(n[i]=e[i])}return n}function _t(e,t){var i=e.title,a=e.titleId,n=Rt(e,Jt);return r.createElement("svg",Nt({id:"svg",viewBox:"0 0 160 160",xmlns:"http://www.w3.org/2000/svg",ref:t,"aria-labelledby":a},n),i?r.createElement("title",{id:a},i):null,zt||(zt=r.createElement("path",{d:"M30 3 L30 80 L130 80 L130 3 Z",strokeWidth:6,stroke:"gray",fill:"transparent"})),Tt||(Tt=r.createElement("circle",{stroke:"gray",strokeWidth:6,fill:"transparent",cx:45,cy:115,r:20})),Bt||(Bt=r.createElement("circle",{stroke:"gray",strokeWidth:6,fill:"transparent",cx:115,cy:115,r:20})),At||(At=r.createElement("line",{x1:30,y1:150,x2:130,y2:150,stroke:"gray",strokeWidth:6})))}var Lt,Gt,Wt,Ft,Vt,Xt=r.forwardRef(_t),Yt=(i.p,["title","titleId"]);function Zt(){return Zt=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var i=arguments[t];for(var a in i)Object.prototype.hasOwnProperty.call(i,a)&&(e[a]=i[a])}return e},Zt.apply(this,arguments)}function Ht(e,t){if(null==e)return{};var i,a,n=function(e,t){if(null==e)return{};var i,a,n={},s=Object.keys(e);for(a=0;a<s.length;a++)i=s[a],t.indexOf(i)>=0||(n[i]=e[i]);return n}(e,t);if(Object.getOwnPropertySymbols){var s=Object.getOwnPropertySymbols(e);for(a=0;a<s.length;a++)i=s[a],t.indexOf(i)>=0||Object.prototype.propertyIsEnumerable.call(e,i)&&(n[i]=e[i])}return n}function Ut(e,t){var i=e.title,a=e.titleId,n=Ht(e,Yt);return r.createElement("svg",Zt({id:"svg",viewBox:"0 0 160 160",xmlns:"http://www.w3.org/2000/svg",ref:t,"aria-labelledby":a},n),i?r.createElement("title",{id:a},i):null,Lt||(Lt=r.createElement("line",{x1:0,y1:3,x2:160,y2:3,stroke:"gray",strokeWidth:6})),Gt||(Gt=r.createElement("line",{x1:20,y1:0,x2:0,y2:60,stroke:"gray",strokeWidth:6})),Wt||(Wt=r.createElement("line",{x1:60,y1:0,x2:40,y2:60,stroke:"gray",strokeWidth:6})),Ft||(Ft=r.createElement("line",{x1:100,y1:0,x2:80,y2:60,stroke:"gray",strokeWidth:6})),Vt||(Vt=r.createElement("line",{x1:140,y1:0,x2:120,y2:60,stroke:"gray",strokeWidth:6})))}var qt=r.forwardRef(Ut),Kt=(i.p,["values"]),Qt={free:{type:"free",icon:Object(T.jsx)(gt.a,{}),label:"\u5b8c\u5168\u30d5\u30ea\u30fc"},pin:{type:"pin",icon:Object(T.jsx)(ft.a,{sx:{width:24},viewBox:"0 0 160 160",children:Object(T.jsx)(St,{})}),label:"\u5b8c\u5168\u30d4\u30f3"},pinX:{type:"pinX",icon:Object(T.jsx)(ft.a,{sx:{width:24},viewBox:"0 0 160 160",children:Object(T.jsx)(Dt,{})}),label:"\u30d4\u30f3X\u30ed\u30fc\u30e9\u30fc"},pinZ:{type:"pinZ",icon:Object(T.jsx)(ft.a,{sx:{width:24,transform:"rotate(-90deg)"},viewBox:"0 0 160 160",children:Object(T.jsx)(Dt,{})}),label:"\u30d4\u30f3Z\u30ed\u30fc\u30e9\u30fc"},fixX:{type:"fixX",icon:Object(T.jsx)(ft.a,{sx:{width:24},viewBox:"0 0 160 160",children:Object(T.jsx)(Xt,{})}),label:"\u56fa\u5b9aX\u30ed\u30fc\u30e9\u30fc"},fix:{type:"fix",icon:Object(T.jsx)(ft.a,{sx:{width:24},viewBox:"0 0 160 160",children:Object(T.jsx)(qt,{})}),label:"\u5b8c\u5168\u56fa\u5b9a"}},$t={sx:{justifyContent:"flex-start",alignItems:"center"}},ei=function(e){var t=e.node,i=e.onChange,a=e.onClose,n=Object(r.useState)(),s=Object(g.a)(n,2),o=s[0],c=s[1],l=Object(r.useCallback)((function(e){e.preventDefault();var n=Object(N.a)(Object(N.a)({},t),{},{pin:o});i&&i(n),a()}),[t,i,a,o]),h=Object(r.useCallback)((function(e,t){var i;null!==t&&("string"===typeof(i=t)&&R.some((function(e){return e===i})))&&c(t)}),[]);return Object(r.useEffect)((function(){var e;c(null!==(e=t.pin)&&void 0!==e?e:"free")}),[t.pin]),Object(T.jsx)(it.a,{children:Object(T.jsxs)(at.a,{direction:"column",spacing:1,sx:{p:1,width:240},component:"form",autoComplete:"off",noValidate:!0,onSubmit:l,children:[Object(T.jsx)(bt.a,{orientation:"vertical",value:o,size:"small",exclusive:!0,fullWidth:!0,onChange:h,children:Object.entries(Qt).map((function(e){var t=Object(g.a)(e,2),i=t[0],a=t[1],n=a.icon,s=a.label;return Object(T.jsxs)(pt.a,Object(N.a)(Object(N.a)({value:i},$t),{},{children:[n,Object(T.jsx)(te.a,{variant:"caption",sx:{ml:1},children:s})]}),i)}))}),Object(T.jsxs)(at.a,{direction:"row",justifyContent:"flex-end",spacing:1,children:[Object(T.jsx)(ot.a,{size:"small",onClick:a,children:"\u30ad\u30e3\u30f3\u30bb\u30eb"}),Object(T.jsx)(ot.a,{type:"submit",size:"small",variant:"contained",children:"OK"})]})]})})},ti=function(e){var t=e.values,i=Object(re.a)(e,Kt),a=Object(r.useMemo)((function(){return _(t)?t:{id:"",name:"",x:0,y:0}}),[t]);return Object(T.jsx)(ei,Object(N.a)(Object(N.a)({},i),{},{node:a}))},ii=i(5),ai=i(194),ni=i(180),si=["values"],oi=function(e){if(0===e.length)return[NaN,!1,"\u6570\u5024\u3092\u5165\u529b\u3057\u3066\u304f\u3060\u3055\u3044"];var t=parseFloat(e);return isNaN(t)?[NaN,!1,"\u6570\u5024\u3092\u5165\u529b\u3057\u3066\u304f\u3060\u3055\u3044"]:0>=t&&t>Number.MAX_SAFE_INTEGER?[t,!1,"0 \u4ee5\u4e0a\u306e\u6570\u5024\u3092\u5165\u529b\u3057\u3066\u304f\u3060\u3055\u3044"]:[x(t,3),!0,""]},ri=function(e){if(e.length>0){var t=parseInt(e,10);return isNaN(t)||e.indexOf(".")>=0?[NaN,!1,"\u6574\u6570\u3092\u5165\u529b\u3057\u3066\u304f\u3060\u3055\u3044"]:-180>t||180<t?[t,!1,"-180 \u301c 180 \u3067\u5165\u529b\u3057\u3066\u304f\u3060\u3055\u3044"]:(-180===t&&(t=180),[t,!0,""])}return[90,!0,""]},ci=function(e){var t,i,a,n,s,o,c,l=e.trapezoid,h=e.onChange,d=e.onClose,u=Object(r.useState)({}),v=Object(g.a)(u,2),f=v[0],b=v[1],p=Object(r.useState)({}),m=Object(g.a)(p,2),y=m[0],j=m[1],O=Object(r.useCallback)((function(e){if((e.preventDefault(),e.currentTarget.checkValidity())&&!Object.values(y).some((function(e){return e.length>0}))){var t=function(e){var t,i,a,n,s={forceI:0,forceJ:0,angle:90,isGlobal:!1},o=oi(null!==(t=e.forceI)&&void 0!==t?t:""),r=Object(g.a)(o,2),c=r[0],l=r[1],h=oi(null!==(i=e.forceJ)&&void 0!==i?i:""),d=Object(g.a)(h,2),u=d[0],v=d[1],f=ri(null!==(a=e.angle)&&void 0!==a?a:""),b=Object(g.a)(f,2),p=b[0],m=b[1],y=l&&v&&m;return s.forceI=c,s.forceJ=u,s.angle=p,s.isGlobal=null!==(n=e.isGlobal)&&void 0!==n&&n,[y,s]}(f),i=Object(g.a)(t,2),a=i[0],n=i[1];a&&h&&h(Object(N.a)(Object(N.a)({},l),n)),d()}}),[y,h,d,l,f]),x=Object(r.useCallback)((function(e){var t=e.target,i=t.name,a=t.value,n="";switch(i){case"forceI":case"forceJ":var s=oi(a),o=Object(g.a)(s,3),r=o[1],c=o[2];r||(n=c);break;case"angle":var l=ri(a),h=Object(g.a)(l,3),d=h[1],u=h[2];d||(n=u)}j((function(e){return Object(N.a)(Object(N.a)({},e),{},Object(ii.a)({},i,n))})),b((function(e){return Object(N.a)(Object(N.a)({},e),{},Object(ii.a)({},i,a))}))}),[]),w=Object(r.useCallback)((function(e){var t=e.target.checked;b((function(e){return Object(N.a)(Object(N.a)({},e),{},{isGlobal:t})}))}),[]);return Object(r.useEffect)((function(){b(function(e){var t,i={};return i.forceI="".concat(e.forceI),i.forceJ="".concat(e.forceJ),i.angle="".concat(null!==(t=e.angle)&&void 0!==t?t:""),i.isGlobal=e.isGlobal,i}(l)),j({})}),[l]),Object(T.jsx)(it.a,{children:Object(T.jsxs)(at.a,{direction:"column",spacing:1,sx:{p:1,width:240},component:"form",autoComplete:"off",noValidate:!0,onSubmit:O,children:[Object(T.jsx)(nt.a,{variant:"outlined",margin:"dense",size:"small",label:"I\u7aef\u5074\u306e\u8377\u91cd",name:"forceI",value:null!==(t=f.forceI)&&void 0!==t?t:"",required:!0,fullWidth:!0,onChange:x,InputProps:{endAdornment:Object(T.jsx)(st.a,{position:"end",children:"kN/m"})},error:Boolean(y.forceI),helperText:null!==(i=y.forceI)&&void 0!==i?i:""}),Object(T.jsx)(nt.a,{variant:"outlined",margin:"dense",size:"small",label:"J\u7aef\u5074\u306e\u8377\u91cd",name:"forceJ",value:null!==(a=f.forceJ)&&void 0!==a?a:"",required:!0,fullWidth:!0,onChange:x,InputProps:{endAdornment:Object(T.jsx)(st.a,{position:"end",children:"kN/m"})},error:Boolean(y.forceJ),helperText:null!==(n=y.forceJ)&&void 0!==n?n:""}),Object(T.jsx)(nt.a,{variant:"outlined",margin:"dense",size:"small",label:"\u89d2\u5ea6",name:"angle",value:null!==(s=f.angle)&&void 0!==s?s:"",fullWidth:!0,onChange:x,InputProps:{endAdornment:Object(T.jsx)(st.a,{position:"end",children:"\xb0"})},error:Boolean(y.angle),helperText:null!==(o=y.angle)&&void 0!==o?o:""}),Object(T.jsx)(ai.a,{label:"\u5168\u4f53\u5ea7\u6a19\u7cfb",control:Object(T.jsx)(ni.a,{name:"isGlobal",size:"small",checked:null!==(c=f.isGlobal)&&void 0!==c&&c,onChange:w})}),Object(T.jsxs)(at.a,{direction:"row",justifyContent:"flex-end",spacing:1,children:[Object(T.jsx)(ot.a,{size:"small",onClick:d,children:"\u30ad\u30e3\u30f3\u30bb\u30eb"}),Object(T.jsx)(ot.a,{type:"submit",size:"small",variant:"contained",children:"OK"})]})]})})},li=function(e){var t=e.values,i=Object(re.a)(e,si),a=Object(r.useMemo)((function(){return F(t)?t:{id:"",name:"",beam:"",forceI:0,distanceI:0,forceJ:0,distanceJ:0}}),[t]);return Object(T.jsx)(ci,Object(N.a)(Object(N.a)({},i),{},{trapezoid:a}))},hi=function(){var e=Object(r.useContext)(Ke),t=e.popupType,i=e.popupPosition,a=e.popupParams,n=e.close,s=e.callback;return"undefined"===typeof t?null:Object(T.jsxs)(Q.a,{sx:Object(N.a)({position:"fixed",zIndex:5e3},i),children:["forces"===t&&Object(T.jsx)(lt,{values:null!==a&&void 0!==a?a:{},onClose:n,onChange:s}),"trapezoids"===t&&Object(T.jsx)(li,{values:null!==a&&void 0!==a?a:{},onClose:n,onChange:s}),"nodes"===t&&Object(T.jsx)(ti,{values:null!==a&&void 0!==a?a:{},onClose:n,onChange:s}),"moments"===t&&Object(T.jsx)(ut,{values:null!==a&&void 0!==a?a:{},onClose:n,onChange:s})]})},di=["tool","readonly","children"],ui=function(e,t){var i=e.tool,a=void 0===i?"select":i,n=e.readonly,s=void 0!==n&&n,o=(e.children,Object(re.a)(e,di)),c=Object(r.useState)({width:0,height:0}),l=Object(g.a)(c,2),h=l[0],d=l[1],u=Object(r.useRef)(null),v=Object(r.useRef)(null);return Object(r.useImperativeHandle)(t,(function(){return{getStructure:function(){return v.current?v.current.getStructure():Z}}}),[]),Object(r.useEffect)((function(){var e=new ResizeObserver((function(e){var t=e[0].contentRect,i=t.width,a=t.height;d({width:i,height:a})}));return u.current&&e.observe(u.current),function(){e.disconnect()}}),[]),Object(T.jsx)(Q.a,{ref:u,sx:{width:"auto",height:"100%",backgroundColor:"#ffffff",overscrollBehavior:"contain"},children:Object(T.jsxs)(Qe,{children:[Object(T.jsx)(tt,Object(N.a)({ref:v,tool:a,readonly:s,canvasSize:h},o)),Object(T.jsx)(hi,{})]})})},vi=Object(r.forwardRef)(ui),gi=["select","pen","force","moment","trapezoid","delete"],fi=function(e){if(e&&"object"===typeof e){var t=e;return"number"===typeof t.x&&"number"===typeof t.y}return!1},bi={lockRotation:!0,fill:"#fff",stroke:"#000",strokeWidth:1,hasRotatingPoint:!1,erasable:!1},pi={selectable:!1,evented:!1,erasable:!1},mi=function(){function e(t,i){Object(le.a)(this,e),this.manager=void 0,this.data=void 0,this.layer=void 0,this.image=void 0,this.dragging=!1,this.manager=t,this.data=i,this.layer=this.createLayer(),this.manager.canvas.add(this.layer),this.loadImage(),this.attachEvents()}return Object(he.a)(e,[{key:"coordinates",get:function(){return this.layer.calcCoords()}},{key:"update",value:function(e){e&&(this.data=e),this.remove(),this.layer=this.createLayer(),this.manager.canvas.add(this.layer),this.loadImage(),this.attachEvents()}},{key:"remove",value:function(){this.layer.off(),this.manager.canvas.remove(this.layer),this.image&&this.manager.canvas.remove(this.image)}},{key:"getCanvasProps",value:function(){return this.data}},{key:"hideControls",value:function(){this.layer.hasControls=!1,this.manager.canvas.renderAll()}},{key:"select",value:function(){this.manager.canvas.setActiveObject(this.layer),this.manager.selectedCanvasId=this.data.id}},{key:"createLayer",value:function(){var e=new de.fabric.Rect(Object(N.a)(Object(N.a)({top:this.data.y,left:this.data.x,height:this.data.height,width:this.data.width},bi),{},{name:this.data.id,data:{type:"layer"}}));return e.setControlsVisibility({bl:!0,br:!0,mb:!0,ml:!0,mr:!0,mt:!0,tl:!0,tr:!0,mtr:!1}),e}},{key:"loadImage",value:function(){var e=this;this.image&&(this.manager.canvas.remove(this.image),this.image=void 0),this.data.image&&de.fabric.loadSVGFromString(this.data.image,(function(t,i){e.image=de.fabric.util.groupSVGElements(t,i);var a=1;"number"===typeof i.width&&(a=e.data.width/i.width),e.image.setOptions(Object(N.a)(Object(N.a)({},pi),{},{top:e.layer.top,left:e.layer.left,scaleX:a,scaleY:a})),e.manager.canvas.add(e.image),e.layer.opacity=e.data.data.nodes.length>0?0:1,e.layer.bringToFront()}))}},{key:"attachEvents",value:function(){this.layer.on("selected",this.onSelected.bind(this)),this.layer.on("deselected",this.onDeselected.bind(this)),this.layer.on("scaling",this.onScaling.bind(this)),this.layer.on("scaled",this.onScaled.bind(this)),this.layer.on("moving",this.onMoving.bind(this)),this.layer.on("moved",this.onMoved.bind(this))}},{key:"onSelected",value:function(e){this.manager.updateCanvasState(this.data.id)}},{key:"onDeselected",value:function(e){}},{key:"onScaling",value:function(e){this.dragging||(this.layer.opacity=this.image?.1:1,this.dragging=!0)}},{key:"onScaled",value:function(e){if(this.dragging){var t,i,a=null!==(t=this.layer.scaleX)&&void 0!==t?t:1,n=null!==(i=this.layer.scaleY)&&void 0!==i?i:1,s=this.data.width*a,o=this.data.height*n;this.layer.scaleX=1,this.layer.scaleY=1,this.layer.width=s,this.layer.height=o,this.data.width=s,this.data.height=o,this.layer.opacity=this.image?0:1,this.dragging=!1,this.onSelected(e)}}},{key:"onMoving",value:function(e){this.dragging||(this.manager.clearCanvasState(),this.dragging=!0),this.image&&(this.image.top=this.layer.top,this.image.left=this.layer.left)}},{key:"onMoved",value:function(e){if(this.dragging){var t=this.layer.calcCoords(!0);(function(e){if(e&&"object"===typeof e){var t=e;return fi(t.tl)&&fi(t.tr)&&fi(t.bl)&&fi(t.br)}return!1})(t)&&(this.data.x=t.tl.x,this.data.y=t.tl.y),this.onSelected(e),this.dragging=!1}}}]),e}(),yi={stroke:"#eee",strokeWidth:1,evented:!1,hasControls:!1,selectable:!1,excludeFromExport:!0,erasable:!1,data:{type:"background",excludeExport:!0}},ji=function(){function e(t,i){var a=this,n=i.size,s=i.zoom,o=i.viewport,r=i.drawData,c=i.structures,l=i.setCanvasState,h=i.clearCanvasState;Object(le.a)(this,e),this.canvas=void 0,this._mode="edit",this._readonly=!1,this.pageWidth=0,this.pageHeight=0,this.gridSize=25,this._settings=H,this.eventType=void 0,this.hasSelected=!1,this.pinching=!1,this.panning=!1,this.lastPos=void 0,this.forceRenderTimer=void 0,this.zoomStartScale=1,this.structures={},this.selectedCanvasId=void 0,this.setCanvasState=void 0,this.clearCanvasState=void 0,this.canvas=new de.fabric.Canvas(t,{selection:!0,isDrawingMode:!1,fireRightClick:!0,stopContextMenu:!0}),this.canvas.setZoom(s),this.canvas.setViewportTransform(o),this.readonly=!1,this.mode="select";var d=Y[n];this.pageHeight=d.height,this.pageWidth=d.width,this.gridSize=25,this.setCanvasState=l,this.clearCanvasState=h,this.drawBackgroundGrid(),r&&this.canvas.loadFromJSON(r,this.canvas.renderAll.bind(this.canvas)),c.forEach((function(e){var t=new mi(a,e);a.structures[e.id]=t})),this.attachEvents()}return Object(he.a)(e,[{key:"mode",get:function(){return this._mode},set:function(e){this._mode=e,this.canvas.selection="select"===this._mode}},{key:"readonly",get:function(){return this._readonly},set:function(e){this._readonly=e,this.canvas.selection=!e&&"select"===this._mode}},{key:"drawSettings",get:function(){return this._settings},set:function(e){var t=this.canvas.freeDrawingBrush;Boolean(t)&&this._settings.eraser===e.eraser||(t=e.eraser?new de.fabric.EraserBrush(this.canvas):new de.fabric.PencilBrush(this.canvas),this.canvas.freeDrawingBrush=t);var i=e.stroke,a=e.strokeWidth;t.color=i,t.width=a,this._settings=Object(N.a)({},e)}},{key:"activeStructure",get:function(){return this.selectedCanvasId?this.structures[this.selectedCanvasId].getCanvasProps():Z},set:function(e){var t=this.structures[e.id];if(t){var i=this.canvas.getZoom(),a=O(e);a.zoom=a.zoom/i,t.update(a),this.updateCanvasState()}}},{key:"activeCanvas",get:function(){if(this.selectedCanvasId)return this.structures[this.selectedCanvasId]}},{key:"save",value:function(){}},{key:"load",value:function(){}},{key:"clear",value:function(){}},{key:"undo",value:function(){}},{key:"redo",value:function(){}},{key:"updateCanvasState",value:function(e){if(e&&(this.selectedCanvasId=e),this.selectedCanvasId){var t=this.structures[this.selectedCanvasId].getCanvasProps(),i=this.structures[this.selectedCanvasId].coordinates,a=this.canvas.getZoom(),n=Object(N.a)(Object(N.a)({},t),{},{coordinates:i,pageZoom:a});this.setCanvasState(n)}}},{key:"resize",value:function(e){var t=e.width,i=e.height,a=this.canvas.getZoom();this.canvas.setWidth(t*a),this.canvas.setHeight(i*a)}},{key:"addCanvas",value:function(e){var t=O(null!==e&&void 0!==e?e:Z);t.id=Object(z.a)();for(var i=Object.values(this.structures),a={x:t.x,y:t.y};i.some((function(e){return t=a,i=e.coordinates.tl,t.x===i.x&&t.y===i.y;var t,i}));)a.x+=20,a.y+=20;t.x=a.x,t.y=a.y;var n=new mi(this,t);this.structures[t.id]=n,n.select()}},{key:"removeCanvas",value:function(e){var t;t="string"===typeof e?e:e.id;var i=this.structures[t];i&&(i.remove(),delete this.structures[t],this.selectedCanvasId=void 0)}},{key:"drawBackgroundGrid",value:function(){for(var e,t=[],i=0;i<=this.pageHeight;i+=this.gridSize){var a=new de.fabric.Line([0,i,this.pageWidth,i],Object(N.a)({},yi));t.push(a)}var n=new de.fabric.Line([0,this.pageHeight,this.pageWidth,this.pageHeight],Object(N.a)({},yi));t.push(n);for(var s=0;s<=this.pageWidth;s+=this.gridSize){var o=new de.fabric.Line([s,0,s,this.pageHeight],Object(N.a)({},yi));t.push(o)}var r=new de.fabric.Line([this.pageWidth,0,this.pageWidth,this.pageHeight],Object(N.a)({},yi));t.push(r),(e=this.canvas).add.apply(e,t)}},{key:"fitViewport",value:function(e,t){var i=this.canvas.viewportTransform,a=this.canvas.getZoom(),n=this.canvas.getWidth(),s=this.canvas.getHeight();if(i){var o=i[4],r=i[5];n>=this.pageWidth*a?o=n/2-this.pageWidth*a/2:("number"===typeof e&&(o+=e),o>=0?o=0:o<n-this.pageWidth*a&&(o=n-this.pageWidth*a)),s>=this.pageHeight*a?r=s/2-this.pageHeight*a/2:("number"===typeof t&&(r+=t),r>=0?r=0:r<s-this.pageHeight*a&&(r=s-this.pageHeight*a)),i[4]=o,i[5]=r,this.canvas.requestRenderAll()}}},{key:"attachEvents",value:function(){this.canvas.on("mouse:down",this.onMouseDown.bind(this)),this.canvas.on("mouse:down:before",this.onMouseDownBefore.bind(this)),this.canvas.on("mouse:move",this.onMouseMove.bind(this)),this.canvas.on("mouse:up",this.onMouseUp.bind(this)),this.canvas.on("selection:created",this.onSelect.bind(this)),this.canvas.on("selection:updated",this.onSelect.bind(this)),this.canvas.on("selection:cleared",this.onDeselect.bind(this)),this.canvas.on("object:added",this.onCreateObject.bind(this)),this.canvas.on("touch:gesture",this.onTouchGesture.bind(this)),this.canvas.on("mouse:wheel",this.onMouseWheel.bind(this)),this.canvas.on("touch:drag",this.onTouchDrag.bind(this))}},{key:"onSelect",value:function(){this.hasSelected=!0}},{key:"onDeselect",value:function(){this.hasSelected=!1,this.selectedCanvasId&&(this.clearCanvasState(!1),this.selectedCanvasId=void 0)}},{key:"onMouseDownBefore",value:function(e){var t=this;if(0===e.e.type.indexOf("touch")){this.eventType="touch";var i=e.e.touches;i.length,1===i.length?("edit"===this.mode&&(this.canvas.isDrawingMode=!0),"select"!==this.mode||this.hasSelected||Boolean(e.target)||(this.panning=!0)):(this.canvas.isDrawingMode=!1,this.forceRenderTimer&&clearTimeout(this.forceRenderTimer),this.forceRenderTimer=setTimeout((function(){console.log("here!"),t.canvas.renderAll(),t.forceRenderTimer=void 0}),100)),2===i.length&&(this.pinching=!0),i.length>2&&(this.panning=!0)}else if(0===e.e.type.indexOf("mouse")){this.eventType="mouse";var a=e.e.button;0===a&&("edit"===this.mode&&(this.canvas.isDrawingMode=!0),"select"!==this.mode||this.hasSelected||Boolean(e.target)||(this.panning=!0)),2===a&&(this.panning=!0)}this.panning&&(this.canvas.selection=!1,this.clearCanvasState())}},{key:"onMouseDown",value:function(e){this.lastPos=I(e)}},{key:"onTouchGesture",value:function(e){if(this.pinching&&0===e.e.type.indexOf("touch")){var t=e.e.touches;if(t&&2===t.length&&e.self){"start"===e.self.state&&(this.zoomStartScale=this.canvas.getZoom());var i=this.zoomStartScale*e.self.scale;i>20&&(i=20),i<.1&&(i=.1);var a=new de.fabric.Point(e.self.x,e.self.y);this.canvas.zoomToPoint(a,i),this.fitViewport()}}}},{key:"onMouseWheel",value:function(e){if(!this.readonly&&0===e.e.type.indexOf("wheel")&&e.pointer){var t=e.e,i=t.deltaY,a=this.canvas.getZoom();(a*=Math.pow(.999,i))>20&&(a=20),a<.1&&(a=.1);var n=e.pointer;this.canvas.zoomToPoint(n,a),t.preventDefault(),t.stopPropagation(),this.fitViewport(),this.updateCanvasState()}}},{key:"onTouchDrag",value:function(e){if("touch"===this.eventType&&this.panning){var t=I(e);if(t&&this.lastPos){var i=t.x,a=t.y,n=i-this.lastPos.x,s=a-this.lastPos.y;this.fitViewport(n,s),this.lastPos=t}}}},{key:"onMouseMove",value:function(e){if("mouse"===this.eventType&&this.panning){var t=I(e);if(t&&this.lastPos){var i=t.x,a=t.y,n=i-this.lastPos.x,s=a-this.lastPos.y;this.fitViewport(n,s),this.lastPos=t}}}},{key:"onMouseUp",value:function(e){if(this.panning||this.pinching){var t=this.canvas.viewportTransform;t&&this.canvas.setViewportTransform(t),this.updateCanvasState()}this.canvas.selection="select"===this.mode,this.canvas.isDrawingMode=!1,this.panning=!1,this.pinching=!1,this.lastPos=void 0}},{key:"onCreateObject",value:function(e){}},{key:"dispose",value:function(){this.canvas.clear(),this.canvas.dispose()}}]),e}(),Oi=i(88),xi=i.n(Oi),wi=i(89),ki=i.n(wi),Mi=i(90),Si=i.n(Mi),Ei=i(7),Ci=i(196),Ii=i(91),Pi=i(181),zi=Object(Ei.a)("div")({display:"flex",alignItems:"center",width:"100%",padding:"0 8"}),Ti=Object(Ei.a)("div")({flex:1}),Bi=function(e){var t=e.mode,i=e.coordinates,a=e.width,n=e.pageZoom,s=e.onEdit,o=e.onCopy,c=e.onDelete,l=e.onCancel,h=Object(r.useState)(null),d=Object(g.a)(h,2),u=d[0],v=d[1],f=Object(r.useCallback)((function(e){v(e.currentTarget)}),[]),b=Object(r.useCallback)((function(){v(null)}),[]),p=Object(r.useCallback)((function(){o&&o(),v(null)}),[o]),m=Object(r.useCallback)((function(){c&&c(),v(null)}),[c]),y=Object(r.useMemo)((function(){var e=i.tl.y-34,t=i.tl.x;return e<0&&(e=i.bl.y),[e,t]}),[i.bl.y,i.tl.x,i.tl.y]),j=Object(g.a)(y,2),O=j[0],x=j[1];return Object(T.jsxs)(Q.a,{sx:{position:"absolute",top:O,left:x,width:a*n},children:[Object(T.jsxs)(zi,{children:["canvas"===t&&Object(T.jsx)(Ci.a,{size:"small",onClick:l,children:Object(T.jsx)(xi.a,{})}),"note"===t&&Object(T.jsxs)(T.Fragment,{children:[Object(T.jsx)(Ci.a,{size:"small",onClick:s,children:Object(T.jsx)(ki.a,{})}),Object(T.jsx)(Ti,{}),Object(T.jsx)(Ci.a,{size:"small",onClick:f,children:Object(T.jsx)(Si.a,{})})]})]}),Object(T.jsxs)(Ii.a,{anchorEl:u,open:Boolean(u),onClose:b,children:[Object(T.jsx)(Pi.a,{onClick:p,children:"\u30b3\u30d4\u30fc"}),Object(T.jsx)(Pi.a,{onClick:m,children:"\u524a\u9664"})]})]})},Ai=["mode","tool","viewSize","drawSettings","onEditCanvas","onCloseCanvas"],Di=function(e,t){var i=e.mode,a=e.tool,n=e.viewSize,s=e.drawSettings,o=e.onEditCanvas,c=e.onCloseCanvas,l=Object(re.a)(e,Ai),h=Object(r.useRef)(null),d=Object(r.useRef)(),u=Object(r.useState)(),v=Object(g.a)(u,2),f=v[0],b=v[1];Object(r.useImperativeHandle)(t,(function(){return{getActiveStructure:function(){if(d.current)return d.current.activeStructure},setActiveStructure:function(e){d.current&&(d.current.activeStructure=e)},addStructureCanvas:function(e){d.current&&d.current.addCanvas(e)},removeStructureCanvas:function(e){d.current&&d.current.removeCanvas(e.id)}}}));var p=Object(r.useCallback)((function(e){b(e)}),[]),m=Object(r.useCallback)((function(){var e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];b(void 0),e&&c&&c()}),[c]),y=Object(r.useCallback)((function(){if(o&&f){var e;if(d.current)null===(e=d.current.activeCanvas)||void 0===e||e.hideControls();o(f,(function(e){d.current&&(d.current.activeStructure=e)}))}}),[f,o]),j=Object(r.useCallback)((function(){if(d.current){var e=d.current.activeCanvas;e&&d.current.addCanvas(e.getCanvasProps())}}),[]),O=Object(r.useCallback)((function(){if(d.current){var e=d.current.activeCanvas;e&&d.current.removeCanvas(e.getCanvasProps()),b(void 0)}}),[]);return Object(r.useLayoutEffect)((function(){h.current&&0!==n.width&&0!==n.height&&"undefined"===typeof d.current&&(d.current=new ji(h.current,Object(N.a)(Object(N.a)({},l),{},{setCanvasState:p,clearCanvasState:m})))}),[m,l,p,n.height,n.width]),Object(r.useEffect)((function(){d.current&&(d.current.readonly="canvas"===i)}),[i]),Object(r.useEffect)((function(){d.current&&(d.current.mode=a)}),[a]),Object(r.useEffect)((function(){d.current&&(d.current.drawSettings=s)}),[s]),Object(r.useEffect)((function(){d.current&&d.current.resize(n)}),[n]),Object(T.jsxs)(T.Fragment,{children:[Object(T.jsx)("canvas",{ref:h,width:n.width,height:n.height}),f&&Object(T.jsx)(Bi,Object(N.a)(Object(N.a)({mode:i},f),{},{onEdit:y,onCopy:j,onDelete:O,onCancel:m}))]})},Ji=Object(r.forwardRef)(Di),Ni=function(e,t){var i=Object(r.useRef)(null),a=Object(r.useState)(),n=Object(g.a)(a,2),s=n[0],o=n[1],c=Object(r.useContext)(B),l=c.mode,h=c.editCanvas,d=c.closeCanvas,u=Object(r.useContext)(q),v=u.mode,f=u.settings;return Object(r.useEffect)((function(){var e=new ResizeObserver((function(e){var t=e[0].target.getBoundingClientRect();o(t)}));return i.current&&e.observe(i.current),function(){e.disconnect()}}),[]),Object(T.jsx)(Q.a,{ref:i,sx:{width:"auto",height:"100%",backgroundColor:"#ffffff",overscrollBehavior:"contain",overflow:"hidden"},children:s&&Object(T.jsx)(Ji,Object(N.a)({ref:t,mode:l,tool:v,viewSize:s,drawSettings:f,onEditCanvas:h,onCloseCanvas:d},U))})},Ri=Object(r.forwardRef)(Ni),_i=function(){var e=Object(r.useContext)(B),t=e.mode,i=e.canvasProps,a=e.canvasRef,n=e.noteRef,s=Object(r.useContext)(D).tool;return Object(T.jsxs)(Q.a,{sx:{position:"relative",boxSizing:"border-box",ml:1,mb:1,flex:1,border:function(e){return"1px solid ".concat(e.palette.divider)},borderRadius:1,overflow:"hidden"},children:[Object(T.jsx)(Ri,{ref:n}),i&&Object(T.jsx)(Q.a,{sx:{position:"absolute",top:i.coordinates.tl.y,left:i.coordinates.tl.x,width:i.width*i.pageZoom,height:i.height*i.pageZoom},children:Object(T.jsx)(vi,Object(N.a)({ref:a,tool:s,readonly:"note"===t},i))})]})},Li=i(169),Gi=i(170),Wi=i(171),Fi=i(172),Vi=i(173),Xi=i(174),Yi={select:{tool:"select",icon:Object(T.jsx)(Li.a,{}),label:"\u9078\u629e"},pen:{tool:"pen",icon:Object(T.jsx)(Gi.a,{}),label:"\u6881\u8981\u7d20\u306e\u63cf\u753b"},force:{tool:"force",icon:Object(T.jsx)(Wi.a,{}),label:"\u96c6\u4e2d\u8377\u91cd\u306e\u8ffd\u52a0"},moment:{tool:"moment",icon:Object(T.jsx)(Fi.a,{}),label:"\u30e2\u30fc\u30e1\u30f3\u30c8\u8377\u91cd"},trapezoid:{tool:"trapezoid",icon:Object(T.jsx)(Vi.a,{}),label:"\u5206\u5e03\u8377\u91cd\u306e\u8ffd\u52a0"},delete:{tool:"delete",icon:Object(T.jsx)(Xi.a,{}),label:"\u8981\u7d20\u306e\u524a\u9664"}},Zi=function(e){var t=e.tool,i=e.onChange,a=Object(r.useCallback)((function(e,t){var a;null!==t&&("string"===typeof(a=t)&&gi.some((function(e){return e===a})))&&i(t)}),[i]);return Object(T.jsxs)(at.a,{sx:{width:160},alignItems:"flex-start",children:[Object(T.jsx)(te.a,{variant:"caption",children:"Toolbox"}),Object(T.jsx)(bt.a,{orientation:"vertical",value:t,exclusive:!0,fullWidth:!0,onChange:a,children:Object.entries(Yi).map((function(e){var t=Object(g.a)(e,2),i=t[0],a=t[1],n=a.icon,s=a.label;return Object(T.jsxs)(pt.a,{value:i,sx:{justifyContent:"flex-start",alignItems:"center"},children:[n,Object(T.jsx)(te.a,{variant:"caption",sx:{ml:1},children:s})]},i)}))})]})},Hi=function(){var e=Object(r.useContext)(D),t=e.tool,i=e.setTool;return Object(T.jsx)(Zi,{tool:t,onChange:i})},Ui=i(175),qi=i(176),Ki=i(182),Qi=["pen","eraser"],$i={select:{mode:"select",icon:Object(T.jsx)(Li.a,{}),label:"\u9078\u629e"},edit:{mode:"edit",icon:Object(T.jsx)(Gi.a,{}),label:"\u63cf\u753b"}},ea={pen:{mode:"pen",icon:Object(T.jsx)(Gi.a,{}),label:"\u30da\u30f3\u30c4\u30fc\u30eb"},eraser:{mode:"eraser",icon:Object(T.jsx)(Ui.a,{}),label:"\u6d88\u3057\u30b4\u30e0"}},ta=function(e){var t=e.mode,i=e.settings,a=e.onChangeMode,n=e.onChangeDrawSettings,s=e.onClickAddCanvas,o=Object(r.useCallback)((function(e,t){var i;null!==t&&("string"===typeof(i=t)&&X.some((function(e){return e===i})))&&a(t)}),[a]),c=Object(r.useCallback)((function(e,t){var i;null!==t&&("string"===typeof(i=t)&&Qi.some((function(e){return e===i})))&&n((function(e){return Object(N.a)(Object(N.a)({},e),{},{eraser:"eraser"===t})}))}),[n]),l=Object(r.useCallback)((function(e,t){"number"===typeof t&&n((function(e){return Object(N.a)(Object(N.a)({},e),{},{strokeWidth:t})}))}),[n]),h=Object(r.useCallback)((function(e){if(e.target.checkValidity()){var t=e.target.value;n((function(e){return Object(N.a)(Object(N.a)({},e),{},{stroke:t})}))}}),[n]);return Object(T.jsxs)(at.a,{sx:{width:160},alignItems:"flex-start",children:[Object(T.jsx)(te.a,{variant:"caption",children:"Toolbox"}),Object(T.jsx)(bt.a,{orientation:"vertical",value:t,exclusive:!0,fullWidth:!0,onChange:o,children:Object.entries($i).map((function(e){var t=Object(g.a)(e,2),i=t[0],a=t[1],n=a.icon,s=a.label;return Object(T.jsxs)(pt.a,{value:i,sx:{justifyContent:"flex-start",alignItems:"center"},children:[n,Object(T.jsx)(te.a,{variant:"caption",sx:{ml:1},children:s})]},i)}))}),Object(T.jsx)(te.a,{variant:"caption",sx:{mt:1},children:"\u63cf\u753b\u30c4\u30fc\u30eb"}),Object(T.jsx)(bt.a,{orientation:"vertical",value:i.eraser?"eraser":"pen",exclusive:!0,fullWidth:!0,disabled:"edit"!==t,onChange:c,children:Object.entries(ea).map((function(e){var t=Object(g.a)(e,2),i=t[0],a=t[1],n=a.icon,s=a.label;return Object(T.jsxs)(pt.a,{value:i,sx:{justifyContent:"flex-start",alignItems:"center"},children:[n,Object(T.jsx)(te.a,{variant:"caption",sx:{ml:1},children:s})]},i)}))}),Object(T.jsx)(te.a,{variant:"caption",sx:{mt:1},children:"\u592a\u3055"}),Object(T.jsx)(Ki.a,{sx:{ml:1,mb:2,boxSizing:"border-box",width:140},value:i.strokeWidth,min:1,max:20,step:1,valueLabelDisplay:"auto",disabled:"edit"!==t,onChange:l}),Object(T.jsx)(nt.a,{type:"color",label:"\u30da\u30f3\u306e\u8272",value:i.stroke,disabled:"edit"!==t||i.eraser,fullWidth:!0,margin:"dense",size:"small",onChange:h}),Object(T.jsx)(ot.a,{startIcon:Object(T.jsx)(qi.a,{}),variant:"contained",fullWidth:!0,sx:{mt:2},onClick:s,children:"\u69cb\u9020\u30c7\u30fc\u30bf\u8ffd\u52a0"})]})},ia=function(){var e=Object(r.useContext)(B).noteRef,t=Object(r.useContext)(q),i=Object(r.useCallback)((function(){var t;null===(t=e.current)||void 0===t||t.addStructureCanvas()}),[e]);return Object(T.jsx)(ta,Object(N.a)(Object(N.a)({},t),{},{onClickAddCanvas:i}))},aa=function(){return"canvas"===Object(r.useContext)(B).mode?Object(T.jsx)(Hi,{}):Object(T.jsx)(ia,{})},na=function(){var e=Object(r.useState)({width:0,height:0}),t=Object(g.a)(e,2),i=t[0],a=t[1],n=Object(r.useCallback)((function(){var e=window,t=e.innerHeight,i=e.innerWidth;a({height:t,width:i})}),[]);return Object(r.useEffect)((function(){return n(),window.addEventListener("resize",n),function(){window.removeEventListener("resize",n)}}),[n]),Object(T.jsxs)(Q.a,{sx:Object(N.a)(Object(N.a)({},i),{},{overflow:"hidden"}),children:[Object(T.jsx)(oe,{}),Object(T.jsxs)(Q.a,{sx:{boxSizing:"border-box",width:"auto",height:"calc(100% - 48px)",display:"flex",flexDirection:"row",flexWrap:"nowrap",alignItems:"stretch",pt:1,px:1},children:[Object(T.jsx)(aa,{}),Object(T.jsx)(_i,{})]})]})},sa=Object(d.a)(),oa=function(){return Object(T.jsx)(u.a,{theme:sa,children:Object(T.jsx)(A,{children:Object(T.jsx)(J,{children:Object(T.jsxs)(K,{children:[Object(T.jsx)(v.a,{}),Object(T.jsx)(na,{})]})})})})},ra=function(e){e&&e instanceof Function&&i.e(3).then(i.bind(null,197)).then((function(t){var i=t.getCLS,a=t.getFID,n=t.getFCP,s=t.getLCP,o=t.getTTFB;i(e),a(e),n(e),s(e),o(e)}))};h.a.render(Object(T.jsx)(c.a.StrictMode,{children:Object(T.jsx)(oa,{})}),document.getElementById("root")),ra()}},[[125,1,2]]]);
//# sourceMappingURL=main.cb3229f3.chunk.js.map