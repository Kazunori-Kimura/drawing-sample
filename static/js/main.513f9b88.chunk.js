(this["webpackJsonpdrawing-sample"]=this["webpackJsonpdrawing-sample"]||[]).push([[0],{121:function(e,t){},122:function(e,t){},123:function(e,t){},125:function(e,t,i){"use strict";i.r(t);var a,n,s,o,r=i(0),c=i.n(r),l=i(35),h=i.n(l),d=i(92),u=i(185),g=i(175),v=i(5),f=i(1),b=Object(r.createContext)(void 0),p=function(e){var t=e.children,i=Object(r.useState)("note"),a=Object(v.a)(i,2),n=a[0],s=a[1],o=Object(r.useState)("A4"),c=Object(v.a)(o,2),l=c[0],h=c[1],d=Object(r.useState)(),u=Object(v.a)(d,2),g=u[0],p=u[1],m=Object(r.useRef)(null),j=Object(r.useRef)(),y=Object(r.useCallback)((function(e,t){s("canvas"),p(e),j.current=t}),[]),O=Object(r.useCallback)((function(){if(m.current){var e=m.current.getStructure();j.current&&j.current(e)}s("note"),p(void 0)}),[]);return Object(f.jsx)(b.Provider,{value:{mode:n,onChangeMode:s,pageSizeType:l,onChangePageSize:h,canvasProps:g,editCanvas:y,closeCanvas:O,canvasRef:m},children:t})},m=Object(r.createContext)(void 0),j=function(e){var t=e.children,i=Object(r.useState)("select"),a=Object(v.a)(i,2),n=a[0],s=a[1];return Object(f.jsx)(m.Provider,{value:{tool:n,setTool:s},children:t})},y=i(3),O=["free","pin","pinX","pinZ","fixX","fix"],x=function(e){if(e&&"object"===typeof e){var t=e;return"string"===typeof t.id&&"string"===typeof t.name&&"number"===typeof t.x&&"number"===typeof t.y}return!1},w=function(e){if(e&&"object"===typeof e){var t=e;return"string"===typeof t.id&&"string"===typeof t.name&&"string"===typeof t.nodeI&&"string"===typeof t.nodeJ}return!1},k=function(e){if(e&&"object"===typeof e){var t=e;return"string"===typeof t.id&&"string"===typeof t.name&&"string"===typeof t.beam&&"number"===typeof t.force&&"number"===typeof t.distanceI}return!1},M=function(e){if(e&&"object"===typeof e){var t=e;return"string"===typeof t.id&&"string"===typeof t.name&&"string"===typeof t.beam&&"number"===typeof t.forceI&&"number"===typeof t.distanceI&&"number"===typeof t.forceJ&&"number"===typeof t.distanceJ}return!1},E={version:"0.0.0",unit:{force:"kN",length:"m"},nodes:[],beams:[],forces:[],trapezoids:[]},S=["select","edit"],I={A3:{width:0,height:0},A4:{width:2970,height:2100},B4:{width:0,height:0},B5:{width:0,height:0}},C=Object(y.a)(Object(y.a)({id:"Canvas_1",data:E,x:100,y:100},{width:160,height:90}),{},{zoom:1,viewport:[1,0,0,1,0,0]}),z={stroke:"#000000",strokeWidth:4,eraser:!1},P={size:"A4",zoom:1,viewport:[1,0,0,1,0,0],structures:[Object(y.a)({},C)]},J=Object(r.createContext)(void 0),B=function(e){var t=e.children,i=Object(r.useState)("select"),a=Object(v.a)(i,2),n=a[0],s=a[1],o=Object(r.useState)(z),c=Object(v.a)(o,2),l=c[0],h=c[1];return Object(f.jsx)(J.Provider,{value:{mode:n,settings:l,onChangeMode:s,onChangeDrawSettings:h},children:t})},A=i(193),T=i(187),N=i(189),D=i(186),_=null!==(a=null===(n="c867c7808357d8aa680700e5f1c29023eb6e1d86\n")?void 0:n.substring(0,7))&&void 0!==a?a:"",R=null!==(s="2022/02/03 17:26:59")?s:"",L=null!==(o="0.1.0")?o:"",W=function(){return Object(f.jsx)(D.a,{variant:"caption",sx:{ml:2},children:"ver ".concat(L," (").concat(_,": ").concat(R,")")})},G=function(){return Object(f.jsx)(T.a,{position:"static",children:Object(f.jsxs)(N.a,{variant:"dense",children:[Object(f.jsx)(D.a,{component:"h1",variant:"h6",color:"inherit",children:"Drawing Sample"}),Object(f.jsx)(W,{})]})})},F=i(26),X=i(16),V=i(21),Y=i(22),H=i(15),Z=i(181),U=i(52),q=i.n(U),K=new q.a(1,0),Q=new q.a(0,1),$=function(e,t,i){if(i>=1)return t;if(i<=0)return e;var a=t.clone().subtract(e).normalize(),n=e.distance(t),s=a.multiplyScalar(n*i);return e.clone().add(s)},ee=function(e,t){var i=t.clone().subtract(e).normalize(),a=new q.a(i.y,-1*i.x).normalize();return Q.dot(a)>0&&a.invert(),a},te=function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:3,i=Math.pow(10,t),a=Math.round(e*i)/i;return a},ie=function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:25,i=e/t,a=Math.round(i)*t;return a},ae=function(e){var t=Object(v.a)(e,2),i=t[0],a=t[1],n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:25;return[ie(i,n),ie(a,n)]},ne=function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:5;return ie(e,t)},se=function e(t){var i=t;return 0>i&&(i+=360),i>=360&&(i-=360),(0>i||i>=360)&&(i=e(i)),i},oe=function(e,t,i){for(var a=[],n=e.distance(t),s=10,o=n/(s+1);o<25&&s>0;)o=n/(--s+1);if(s>0)for(var r=1;r<=s;r++){var c=e.clone().add(i.clone().multiplyScalar(o*r));a.push(c)}else if((o=n/2)>=10){var l=$(e,t,.5);a.push(l)}return a},re=function(e,t,i){var a=Object(v.a)(e,4),n=a[0],s=a[1],o=a[2],r=a[3],c=null;try{var l=t.clone().add(i),h=l.x-t.x!==0?(l.y-t.y)/(l.x-t.x):NaN,d=isNaN(h)?NaN:t.y-h*t.x;if(o===h)return null;if(isNaN(o)||isNaN(h)){if(isNaN(o)){var u=n.x;c=[u,u*h+d]}else if(isNaN(h)){var g=t.x;c=[g,g*o+r]}}else{var f=(d-r)/(o-h);c=[f,o*f+r]}if(c){var b=c,p=Object(v.a)(b,2),m=p[0],j=p[1],y=[n.x,s.x].sort((function(e,t){return e-t})),O=[n.y,s.y].sort((function(e,t){return e-t}));if(m>=y[0]&&m<=y[1]&&j>=O[0]&&j<=O[1])return c}return null}catch(x){console.error(x)}return null},ce=function(e){if(0===e.e.type.indexOf("touch")){var t=e.e.touches[0];return{clientX:t.clientX,clientY:t.clientY}}var i=e.e;return{clientX:i.clientX,clientY:i.clientY}},le=function(e,t){var i=arguments.length>2&&void 0!==arguments[2]&&arguments[2],a=i?0:3;return Math.abs(e[0]-t[0])<=a&&Math.abs(e[1]-t[1])<=a},he="silver",de={stroke:he,strokeWidth:1},ue={width:8,height:8,stroke:he,strokeWidth:1,fill:he,originX:"center",originY:"center",centeredRotation:!0},ge={fill:he,height:10,fontSize:10,fontFamily:"sans-serif",textAlign:"center",evented:!1,selectable:!1},ve=function(e,t,i){var a=e.clone(),n=t.clone();if(a.x>n.x||a.x===n.x&&a.y>n.y){var s=[n,a];a=s[0],n=s[1]}var o=ee(a,n);if(0!==i){var r=o.clone();Q.dot(r)>=0&&r.invert(),r.multiplyScalar(i),a.add(r),n.add(r)}var c=a.distance(n),l=n.clone().subtract(a).normalize().angleDeg(),h=new H.fabric.Line([0,-7,0,7],de),d=new H.fabric.Line([c,-7,c,7],de),u=new H.fabric.Line([0,0,c,0],de),g=new H.fabric.Triangle(Object(y.a)({top:0,left:4,angle:-90},ue)),v=new H.fabric.Triangle(Object(y.a)({top:0,left:c-4,angle:90},ue)),f=new H.fabric.Group([h,g,u,v,d],{top:a.y,left:a.x,originX:"left",originY:"center",angle:l}),b=l,p=o.invert(),m=a.clone().add(p.multiplyScalar(5));0===p.dot(Q)&&(p=K.clone(),b=-90,m=n.clone().add(p.multiplyScalar(5)));var j=new H.fabric.Textbox("".concat(Math.round(c)," m"),Object(y.a)({top:m.y,left:m.x,width:c,angle:b},ge));return new H.fabric.Group([f,j],{selectable:!1,evented:!1,data:{type:"guide"}})},fe=function(e,t,i){var a=0;if(Array.isArray(e))return"number"===typeof t&&(a=t),function(e,t){var i=new q.a(e[0],e[1]),a=new q.a(e[2],e[3]);return ve(i,a,t)}(e,a);if(t&&"number"!==typeof t)return"number"===typeof i&&(a=i),ve(e,t,a);throw new Error("invalid parameters")},be=function(e){return fe(e,50)},pe=function(e,t,i){var a=[];if(0===e.size||0===t.size)return[];var n,s=Number.MAX_SAFE_INTEGER,o=Object(X.a)(e).sort((function(e,t){return e-t}));s=o[0];var r=Object(X.a)(t).sort((function(e,t){return e-t}));n=r[r.length-1];var c=Math.min(n+50,i-10),l=fe([s,c,o[o.length-1],c]);a.push(l);for(var h=c-25,d=0;d<o.length-1;d++){var u=o[d],g=o[d+1],v=fe([u,h,g,h]);a.push(v)}var f=Math.max(25,s-50),b=fe([f,r[0],f,n]);a.push(b);for(var p=f+25,m=0;m<r.length-1;m++){var j=r[m],y=r[m+1],O=fe([p,j,p,y]);a.push(O)}return a},me=function(e,t,i){if(Array.isArray(e)&&"number"===typeof t)return function(e,t){var i=new Set,a=new Set;return e.forEach((function(e){var t=e.x,n=e.y;i.add(t),a.add(n)})),pe(i,a,t)}(e,t);if(e instanceof Set&&t instanceof Set&&"number"===typeof i)return pe(e,t,i);throw new Error("invalid parameters")},je=["arrowWidth","arrowEdgeSize","onRotating","onScaling","onModified"],ye={evented:!1,selectable:!1},Oe={fontSize:10,fontFamily:"sans-serif",height:10},xe="black",we={stroke:xe,strokeWidth:2,originX:"center",originY:"bottom",centeredRotation:!1},ke={width:8,height:8,stroke:xe,strokeWidth:1,fill:xe,originX:"center",originY:"center",centeredRotation:!0},Me=function(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},a=i.arrowWidth,n=i.arrowEdgeSize,s=(i.onRotating,i.onScaling,i.onModified,Object(F.a)(i,je)),o=e.distance(t),r=t.clone().subtract(e).normalize(),c=180-r.verticalAngleDeg(),l=new H.fabric.Line([0,0,0,-1*o],Object(y.a)(Object(y.a)({strokeWidth:a},we),s)),h=null!==n&&void 0!==n?n:8,d=new H.fabric.Triangle(Object(y.a)(Object(y.a)({top:h/2*-1,left:0,angle:-180},ke),{},{width:h,height:h,stroke:s.stroke,fill:s.fill})),u=new H.fabric.Group([l,d],Object(y.a)(Object(y.a)({},s),{},{top:e.y,left:e.x,originX:"center",originY:"bottom",centeredRotation:!1,angle:c}));return u.setControlsVisibility({bl:!1,br:!1,mb:!1,ml:!1,mr:!1,mt:!0,tl:!1,tr:!1,mtr:!0}),u},Ee=function(e,t,i){if(Array.isArray(e))return function(e,t){var i=new q.a(e[0],e[1]),a=new q.a(e[2],e[3]);return Me(i,a,t)}(e,t);if(t)return Me(e,t,i);throw new Error("invalid parameters")},Se="orange",Ie=(Object(y.a)(Object(y.a)(Object(y.a)({},ye),Oe),{},{fill:Se,textAlign:"left"}),function(){function e(t,i){Object(V.a)(this,e),this.data=void 0,this.beam=void 0,this.guide=void 0,this.points=[0,0,0,0],this.direction=new q.a(0,0),this.length=1,this.angle=0,this.manager=void 0,this.dragging=!1,this._readonly=!1,this.vi=new q.a(0,0),this.vj=new q.a(0,0),this.nodeI=void 0,this.nodeJ=void 0,this.relationBeams=void 0,this.manager=t,this.data=i;var a=this.manager.nodeMap[i.nodeI],n=this.manager.nodeMap[i.nodeJ];this._readonly=this.manager.readonly,this.beam=this.create([a.data.x,a.data.y,n.data.x,n.data.y],i,{selectable:!this.readonly,evented:!this.readonly}),this.guide=be(this.points),this.guide.visible=!1,this.manager.canvas.add(this.beam,this.guide),this.attachEvents()}return Object(Y.a)(e,[{key:"readonly",get:function(){return this._readonly},set:function(e){this._readonly=e,this.beam.selectable=!e,this.beam.evented=!e}},{key:"createBeamByVectors",value:function(e,t,i,a){this.direction=t.clone().subtract(e).normalize(),this.length=e.distance(t),this.angle=180-this.direction.verticalAngleDeg();var n=new H.fabric.Line([0,0,0,this.length],Object(y.a)(Object(y.a)({top:e.y,left:e.x,angle:this.angle,originX:"center",originY:"bottom",centeredRotation:!1,stroke:"black",strokeWidth:4},a),{},{name:i.id,data:Object(y.a)({type:"beam"},i)}));return n.setControlsVisibility({bl:!1,br:!1,mb:!1,ml:!1,mr:!1,mt:!0,tl:!1,tr:!1,mtr:!0}),this.points=[e.x,e.y,t.x,t.y],this.vi=e,this.vj=t,n}},{key:"createBeamByPoints",value:function(e,t,i){var a=new q.a(e[0],e[1]),n=new q.a(e[2],e[3]);return this.createBeamByVectors(a,n,t,i)}},{key:"create",value:function(e,t,i,a){if(Array.isArray(e)&&w(t))return this.createBeamByPoints(e,t,null!==i&&void 0!==i?i:{});if(w(i))return this.createBeamByVectors(e,t,i,null!==a&&void 0!==a?a:{});throw new Error("invalid parameters")}},{key:"updateGuide",value:function(){this.guide&&this.manager.canvas.remove(this.guide),this.guide=be(this.points),this.guide.visible=!1,this.manager.canvas.add(this.guide)}},{key:"updateBeamByVectors",value:function(e,t){var i=t.clone().subtract(e).normalize(),a=e.distance(t),n=180-i.verticalAngleDeg(),s=[e.x,e.y,t.x,t.y];this.beam.scaleX=1,this.beam.scaleY=1,this.beam.dirty=!0,this.beam.top=e.y,this.beam.left=e.x,this.beam.height=a,this.beam.rotate(n),this.direction=i,this.length=a,this.angle=n,this.points=s,this.vi=e,this.vj=t,this.updateGuide()}},{key:"updateBeamByPoints",value:function(e){var t=new q.a(e[0],e[1]),i=new q.a(e[2],e[3]);this.updateBeamByVectors(t,i)}},{key:"update",value:function(e,t){if(Array.isArray(e))this.updateBeamByPoints(e);else{if(!e||!t)throw this.updateBeamByPoints(this.points),new Error("invalid parameters");this.updateBeamByVectors(e,t)}}},{key:"remove",value:function(){var e=this.manager,t=e.canvas,i=e.forceMap,a=e.trapezoidMap,n=e.beamMap,s=e.nodeBeamMap,o=this.data.id,r=i[o];r&&(r.forEach((function(e){e.remove()})),delete i[o]);var c=a[o];c&&(c.forEach((function(e){e.remove()})),delete a[o]),[this.data.nodeI,this.data.nodeJ].forEach((function(e){var t=s[e];if(t){var i=t.filter((function(e){return e.data.id!==o}));s[e]=i}})),t.remove(this.beam),this.guide&&t.remove(this.guide),delete n[o]}},{key:"setVisibleParts",value:function(){var e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0],t=this.manager,i=t.forceMap,a=t.trapezoidMap;this.guide&&(this.guide.visible=e);var n=i[this.data.id];n&&n.forEach((function(t){t.visible=e}));var s=a[this.data.id];s&&s.forEach((function(t){t.visible=e}))}},{key:"updateParts",value:function(){var e=this.manager,t=e.forceMap,i=e.trapezoidMap;this.updateGuide();var a=t[this.data.id];a&&a.forEach((function(e){e.update()}));var n=i[this.data.id];n&&n.forEach((function(e){e.update()}))}},{key:"calcPoints",value:function(){var e=arguments.length>0&&void 0!==arguments[0]&&arguments[0],t=this.beam,i=t.top,a=void 0===i?0:i,n=t.left,s=void 0===n?0:n;if(e){var o=ae([s,a],this.manager.snapSize),r=Object(v.a)(o,2);s=r[0],a=r[1]}return this.vi.x=s,this.vi.y=a,this.vj.copy(this.vi),this.vj.add(this.direction.clone().multiplyScalar(this.length)),[this.vi.x,this.vi.y,this.vj.x,this.vj.y]}},{key:"calcRatio",value:function(e){var t=this.vi.distance(e),i=180-e.clone().subtract(this.vi).normalize().verticalAngleDeg(),a=(this.angle-i)*(Math.PI/180),n=t*Math.cos(a),s=te(n/this.length,2);return s<0&&(s=0),s>1&&(s=1),s}},{key:"completeDrag",value:function(){var e=this;if(this.nodeI&&this.nodeJ){var t=this.nodeI,i=this.nodeJ,a=this.manager,n=a.nodeMap,s=a.nodeBeamMap,o=a.beamMap,r=Object(v.a)(this.points,4),c=r[0],l=r[1],h=r[2],d=r[3],u={},g=[],f=[this],b=[t.data.id,i.data.id];b.forEach((function(e){"undefined"===typeof s[e]&&(s[e]=[])})),Object.values(n).forEach((function(e){b.includes(e.data.id)||(e.data.x===c&&e.data.y===l?u[e.data.id]=t:e.data.x===h&&e.data.y===d&&(u[e.data.id]=i))})),Object.values(o).forEach((function(a){if(a.data.id!==e.data.id){var n=!1,s=!1;if(u[a.data.nodeI]&&(n=!0,a.data.nodeI=u[a.data.nodeI].data.id),u[a.data.nodeJ]&&(s=!0,a.data.nodeJ=u[a.data.nodeJ].data.id),n&&s)g.push(a);else{var o=a.points,r=!1;a.data.nodeI===t.data.id&&(o[0]=c,o[1]=l,r=!0),a.data.nodeI===i.data.id&&(o[0]=h,o[1]=d,r=!0),a.data.nodeJ===t.data.id&&(o[2]=c,o[3]=l,r=!0),a.data.nodeJ===i.data.id&&(o[2]=h,o[3]=d,r=!0),r&&(a.update(o),0===a.length?g.push(a):f.push(a))}}})),g.length>0&&(g.forEach((function(e){e.remove()})),this.manager.calcForceAverage(),this.manager.calcTrapezoidAverage()),Object.entries(u).forEach((function(e){var t=Object(v.a)(e,2),i=t[0],a=t[1],o=s[i];if(o){var r,c=null!==(r=s[a.data.id])&&void 0!==r?r:[];o.forEach((function(e){c.some((function(t){return t.data.id!==e.data.id}))&&c.push(e)})),s[a.data.id]=c}var l=n[i];l&&l.remove()})),f.forEach((function(e){e.updateParts()})),this.manager.updateGlobalGuidelines()}this.nodeI=void 0,this.nodeJ=void 0,this.relationBeams=void 0,this.dragging=!1}},{key:"attachEvents",value:function(){this.beam.on("selected",this.onSelect.bind(this)),this.beam.on("deselected",this.onDeselect.bind(this)),this.beam.on("mousedown",this.onMouseDown.bind(this)),this.beam.on("mousedown:before",this.onMouseDownBefore.bind(this)),this.beam.on("moving",this.onMoving.bind(this)),this.beam.on("moved",this.onMoved.bind(this)),this.beam.on("rotating",this.onRotating.bind(this)),this.beam.on("rotated",this.onRotated.bind(this)),this.beam.on("scaling",this.onScaling.bind(this)),this.beam.on("scaled",this.onScaled.bind(this))}},{key:"onSelect",value:function(e){this.guide&&(this.guide.visible=!0)}},{key:"onDeselect",value:function(e){this.guide&&(this.guide.visible=!1)}},{key:"onMouseDownBefore",value:function(){"trapezoid"===this.manager.tool&&(this.manager.currentBeam=this.data.id,this.manager.canvas.isDrawingMode=!0)}},{key:"onMouseDown",value:function(e){if(e.pointer){var t=new q.a(e.pointer.x,e.pointer.y);if("force"===this.manager.tool){var i=this.calcRatio(t),a=Object(Z.a)(),n={id:a,name:a,beam:this.data.id,force:10,distanceI:i},s=new Pe(this.manager,n);"undefined"===typeof this.manager.forceMap[this.data.id]&&(this.manager.forceMap[this.data.id]=[]),this.manager.forceMap[this.data.id].push(s),this.manager.calcForceAverage()}else"delete"===this.manager.tool&&(this.remove(),this.manager.removeUnconnectedNodes(),this.manager.updateGlobalGuidelines(),this.manager.calcForceAverage(),this.manager.calcTrapezoidAverage())}}},{key:"onMoving",value:function(e){var t=this;if("select"===this.manager.tool){if(!this.dragging)this.setVisibleParts(!1),this.nodeI=this.manager.nodeMap[this.data.nodeI],this.nodeJ=this.manager.nodeMap[this.data.nodeJ],this.relationBeams=[],[this.nodeI,this.nodeJ].forEach((function(e){e&&e.pin&&(e.pin.visible=!1),t.manager.nodeBeamMap[e.data.id].forEach((function(e){var i;e.data.id!==t.data.id&&(e.setVisibleParts(!1),null===(i=t.relationBeams)||void 0===i||i.push(e))}))}));var i,a=this.calcPoints(),n=Object(v.a)(a,4),s=n[0],o=n[1],r=n[2],c=n[3];if(this.nodeI&&this.nodeJ)this.nodeI.update(s,o,!1),this.nodeJ.update(r,c,!1),null===(i=this.relationBeams)||void 0===i||i.forEach((function(e){var i,a,n,l,h=e.points;e.data.nodeI===(null===(i=t.nodeI)||void 0===i?void 0:i.data.id)&&(h[0]=s,h[1]=o),e.data.nodeI===(null===(a=t.nodeJ)||void 0===a?void 0:a.data.id)&&(h[0]=r,h[1]=c),e.data.nodeJ===(null===(n=t.nodeI)||void 0===n?void 0:n.data.id)&&(h[2]=s,h[3]=o),e.data.nodeJ===(null===(l=t.nodeJ)||void 0===l?void 0:l.data.id)&&(h[2]=r,h[3]=c),e.update(h)}));this.dragging=!0}}},{key:"onMoved",value:function(e){if("select"===this.manager.tool&&this.dragging&&this.nodeI&&this.nodeJ){var t,i,a=this.calcPoints(!0),n=Object(v.a)(a,4),s=n[0],o=n[1],r=n[2],c=n[3];this.update([s,o,r,c]),null===(t=this.nodeI)||void 0===t||t.update(s,o),null===(i=this.nodeJ)||void 0===i||i.update(r,c),this.completeDrag()}}},{key:"onRotating",value:function(e){var t=this;if("select"===this.manager.tool){var i,a,n;if(!this.dragging)this.setVisibleParts(!1),this.nodeI=this.manager.nodeMap[this.data.nodeI],this.nodeJ=this.manager.nodeMap[this.data.nodeJ],this.relationBeams=[],this.nodeJ.pin&&(this.nodeJ.pin.visible=!1),this.manager.nodeBeamMap[this.nodeJ.data.id].forEach((function(e){var i;e.data.id!==t.data.id&&(e.setVisibleParts(!1),null===(i=t.relationBeams)||void 0===i||i.push(e))}));this.vj.copy(this.vi),this.vj.add(Q.clone().invert().multiplyScalar(this.length).rotateDeg(null!==(i=this.beam.angle)&&void 0!==i?i:0));var s=[this.vj.x,this.vj.y],o=s[0],r=s[1];null===(a=this.nodeJ)||void 0===a||a.update(o,r),null===(n=this.relationBeams)||void 0===n||n.forEach((function(e){var i,a,n=e.points;e.data.nodeI===(null===(i=t.nodeJ)||void 0===i?void 0:i.data.id)&&(n[0]=o,n[1]=r),e.data.nodeJ===(null===(a=t.nodeJ)||void 0===a?void 0:a.data.id)&&(n[2]=o,n[3]=r),e.update(n)})),this.dragging=!0}}},{key:"onRotated",value:function(e){if("select"===this.manager.tool&&this.dragging){var t,i;this.vj.copy(this.vi),this.vj.add(Q.clone().invert().multiplyScalar(this.length).rotateDeg(null!==(t=this.beam.angle)&&void 0!==t?t:0));var a=ae([this.vj.x,this.vj.y],this.manager.snapSize),n=Object(v.a)(a,2),s=n[0],o=n[1];this.vj.x=s,this.vj.y=o,null===(i=this.nodeJ)||void 0===i||i.update(s,o),this.update([this.vi.x,this.vi.y,s,o]),this.completeDrag()}}},{key:"onScaling",value:function(e){var t=this;if("select"===this.manager.tool){var i,a,n,s;if(!this.dragging)this.setVisibleParts(!1),this.nodeI=this.manager.nodeMap[this.data.nodeI],this.nodeJ=this.manager.nodeMap[this.data.nodeJ],this.relationBeams=[],this.nodeJ.pin&&(this.nodeJ.pin.visible=!1),this.manager.nodeBeamMap[this.nodeJ.data.id].forEach((function(e){var i;e.data.id!==t.data.id&&(e.setVisibleParts(!1),null===(i=t.relationBeams)||void 0===i||i.push(e))}));var o=null!==(i=this.beam.scaleY)&&void 0!==i?i:1,r=null!==(a=this.beam.angle)&&void 0!==a?a:0;this.vj.copy(this.vi),this.vj.add(Q.clone().invert().multiplyScalar(this.length*o).rotateDeg(r));var c=[this.vj.x,this.vj.y],l=c[0],h=c[1];null===(n=this.nodeJ)||void 0===n||n.update(l,h),null===(s=this.relationBeams)||void 0===s||s.forEach((function(e){var i,a,n=e.points;e.data.nodeI===(null===(i=t.nodeJ)||void 0===i?void 0:i.data.id)&&(n[0]=l,n[1]=h),e.data.nodeJ===(null===(a=t.nodeJ)||void 0===a?void 0:a.data.id)&&(n[2]=l,n[3]=h),e.update(n)})),this.dragging=!0}}},{key:"onScaled",value:function(e){if("select"===this.manager.tool&&this.dragging){var t,i,a,n=null!==(t=this.beam.scaleY)&&void 0!==t?t:1,s=null!==(i=this.beam.angle)&&void 0!==i?i:0;this.vj.copy(this.vi),this.vj.add(Q.clone().invert().multiplyScalar(this.length*n).rotateDeg(s));var o=ae([this.vj.x,this.vj.y],this.manager.snapSize),r=Object(v.a)(o,2),c=r[0],l=r[1];this.vj.x=c,this.vj.y=l,null===(a=this.nodeJ)||void 0===a||a.update(c,l),this.update([this.vi.x,this.vi.y,c,l]),this.completeDrag()}}}]),e}()),Ce="orange",ze=Object(y.a)(Object(y.a)(Object(y.a)({},ye),Oe),{},{fill:Ce,textAlign:"left"}),Pe=function(){function e(t,i){Object(V.a)(this,e),this.data=void 0,this.force=void 0,this.label=void 0,this.manager=void 0,this.longpressTimer=void 0,this.dragging=!1,this._readonly=!1,this.head=new q.a(0,0),this.direction=new q.a(0,1),this.length=0,this.beam=void 0,this.vi=new q.a(0,0),this.vj=new q.a(0,0),this.originalAngle=0,this.position=new q.a(0,0),this.draggableMin=Number.MIN_SAFE_INTEGER,this.draggableMax=Number.MAX_SAFE_INTEGER,this.manager=t,this.data=i,this._readonly=this.manager.readonly;var a=this.create(),n=Object(v.a)(a,2);this.force=n[0],this.label=n[1],this.manager.canvas.add(this.force,this.label),this.attachEvent()}return Object(Y.a)(e,[{key:"readonly",get:function(){return this._readonly},set:function(e){this._readonly=e,this.force.selectable=!e,this.force.evented=!e}},{key:"visible",get:function(){var e;return null===(e=this.force.visible)||void 0===e||e},set:function(e){this.force.visible=e,this.label.visible=e}},{key:"calcForce",value:function(){return 0===this.manager.forceAverage?10:Math.round(this.length/30*this.manager.forceAverage)}},{key:"calcLength",value:function(){return 0===this.manager.forceAverage?30:30*(this.data.force/this.manager.forceAverage)}},{key:"create",value:function(){var e=this.data,t=e.id,i=e.beam,a=e.distanceI,n=e.angle,s=void 0===n?0:n,o=this.manager.beamMap[i],r=o.points,c=new q.a(r[0],r[1]),l=new q.a(r[2],r[3]),h=$(c,l,a),d=o.direction.clone().rotateDeg(s-90).normalize(),u=this.calcLength(),g=h.clone().add(d.clone().multiplyScalar(u)),v=Ee(h,g,{fill:Ce,stroke:Ce,name:t,data:Object(y.a)(Object(y.a)({},this.data),{},{type:"force"}),selectable:!this.readonly,evented:!this.readonly}),f=h.clone().add(o.direction.clone().multiplyScalar(5)),b=d.angleDeg(),p=new H.fabric.Textbox(" ".concat(this.data.force," kN"),Object(y.a)(Object(y.a)({},ze),{},{top:f.y,left:f.x,width:Math.max(u,140),angle:b,visible:!1}));return this.head.copy(h),this.direction.copy(d),this.length=u,[v,p]}},{key:"update",value:function(e){var t;e&&(this.data=e);var i=null!==(t=this.label.visible)&&void 0!==t&&t;this.manager.canvas.remove(this.force,this.label);var a=this.create(),n=Object(v.a)(a,2);this.force=n[0],this.label=n[1],this.manager.canvas.add(this.force,this.label),this.attachEvent(),i&&this.select()}},{key:"remove",value:function(){var e=this;this.manager.canvas.remove(this.force,this.label);var t=this.manager.forceMap[this.data.beam];if(t){var i=t.filter((function(t){return t.data.id!==e.data.id}));this.manager.forceMap[this.data.beam]=i}}},{key:"select",value:function(){this.manager.canvas.setActiveObject(this.force)}},{key:"attachEvent",value:function(){this.force.on("selected",this.onSelected.bind(this)),this.force.on("deselected",this.onDeselected.bind(this)),this.force.on("mousedown",this.onMouseDown.bind(this)),this.force.on("mouseup",this.onMouseUp.bind(this)),this.force.on("mousedblclick",this.onDblClick.bind(this)),this.force.on("moving",this.onMoving.bind(this)),this.force.on("moved",this.onMoved.bind(this)),this.force.on("rotating",this.onRotating.bind(this)),this.force.on("rotated",this.onRotated.bind(this)),this.force.on("scaling",this.onScaling.bind(this)),this.force.on("scaled",this.onScaled.bind(this))}},{key:"onSelected",value:function(){this.label.visible=!0}},{key:"onDeselected",value:function(){this.label.visible=!1}},{key:"onMouseDown",value:function(e){var t=this;if(!this.readonly){if("delete"===this.manager.tool)return this.remove(),void this.manager.calcForceAverage();if(["select","force"].includes(this.manager.tool)&&e.target){this.longpressTimer&&(clearTimeout(this.longpressTimer),this.longpressTimer=void 0);var i=this.force,a=i.getBoundingRect(!0,!0),n=a.top,s=a.left;this.longpressTimer=setTimeout((function(){var a=i.getBoundingRect(!0,!0),o=a.top,r=a.left;le([s,n],[r,o])&&t.manager.openForceDialog(e,t),t.longpressTimer=void 0}),Xe.LongpressInterval)}}}},{key:"onMouseUp",value:function(e){this.longpressTimer&&(clearTimeout(this.longpressTimer),this.longpressTimer=void 0)}},{key:"onDblClick",value:function(e){this.readonly||this.manager.openForceDialog(e,this)}},{key:"onRotating",value:function(e){if(["select","force"].includes(this.manager.tool)){var t;if(!this.dragging)this.label.visible=!1,this.originalAngle=null!==(t=this.force.angle)&&void 0!==t?t:0;this.dragging=!0}}},{key:"onRotated",value:function(e){var t,i,a=null!==(t=this.force.angle)&&void 0!==t?t:0,n=0;if(this.originalAngle!==a){this.originalAngle<a?n=a-this.originalAngle:this.originalAngle>a&&(n=360-this.originalAngle+a),n=se(n),n=ne(n,5);var s=this.originalAngle+n;s=se(s),this.force.angle=s,this.label.angle=s-90,this.label.visible=!0;var o=(null!==(i=this.data.angle)&&void 0!==i?i:0)+n;o=se(o),this.data.angle=o,this.dragging=!1}}},{key:"onScaling",value:function(e){["select","force"].includes(this.manager.tool)&&(this.dragging=!0)}},{key:"onScaled",value:function(e){if(this.dragging){var t,i=null!==(t=this.force.scaleY)&&void 0!==t?t:1,a=this.length*i;this.length=a;var n=this.calcForce();this.data.force=n,this.update(),this.select()}this.dragging=!1}},{key:"calcMovedPosition",value:function(){if(this.beam){var e,t;this.position.x=null!==(e=this.force.left)&&void 0!==e?e:0,this.position.y=null!==(t=this.force.top)&&void 0!==t?t:0;var i=this.head.distance(this.position),a=180-this.position.clone().subtract(this.head).normalize().verticalAngleDeg(),n=(this.beam.angle-a)*Math.PI/180,s=i*Math.cos(n);this.draggableMin>s?s=this.draggableMin:this.draggableMax<s&&(s=this.draggableMax),this.position.copy(this.head).add(this.beam.direction.clone().multiplyScalar(s))}}},{key:"onMoving",value:function(e){if(["select","force"].includes(this.manager.tool)){if(!this.dragging){this.label.visible=!1,this.beam=this.manager.beamMap[this.data.beam];var t=[this.beam.points[0],this.beam.points[1]];this.vi.x=t[0],this.vi.y=t[1];var i=[this.beam.points[2],this.beam.points[3]];this.vj.x=i[0],this.vj.y=i[1],this.draggableMin=-1*this.vi.distance(this.head),this.draggableMax=this.vj.distance(this.head),this.position.copy(this.head),this.dragging=!0}this.calcMovedPosition(),this.force.left=this.position.x,this.force.top=this.position.y}}},{key:"onMoved",value:function(e){if(this.beam){this.calcMovedPosition();var t=this.vi.distance(this.position);this.data.distanceI=te(t/this.beam.length,2),this.head.copy(this.vi.clone().add(this.beam.direction.clone().multiplyScalar(this.beam.length*this.data.distanceI))),this.force.left=this.head.x,this.force.top=this.head.y,this.label.left=this.head.x,this.label.top=this.head.y,this.label.visible=!0}this.beam=void 0,this.draggableMin=Number.MIN_SAFE_INTEGER,this.draggableMax=Number.MAX_SAFE_INTEGER,this.dragging=!1}}]),e}(),Je={free:"/assets/images/pins/pin_1.svg",pin:"/assets/images/pins/pin_1.svg",pinX:"/assets/images/pins/pin_2.svg",pinZ:"/assets/images/pins/pin_2.svg",fixX:"/assets/images/pins/pin_3.svg",fix:"/assets/images/pins/pin_4.svg"},Be=function(){function e(t,i){Object(V.a)(this,e),this.data=void 0,this.node=void 0,this.pin=void 0,this.manager=void 0,this.longpressTimer=void 0,this.dragging=!1,this._readonly=!1,this.manager=t,this.data=i,this.node=this.createNode(i),this.manager.canvas.add(this.node),this.loadPin(),this.attachEvents()}return Object(Y.a)(e,[{key:"update",value:function(e,t,i){if("number"!==typeof e||"number"!==typeof t){if(!x(e)||"number"===typeof t){if("undefined"===typeof e){var a=this.data,n=a.x,s=a.y;this.updatePosition(n,s,!0)}throw new Error("invalid parameters")}this.updateByParams(e,t)}else this.updatePosition(e,t,i)}},{key:"updatePosition",value:function(e,t){var i=!(arguments.length>2&&void 0!==arguments[2])||arguments[2],a=Object(y.a)(Object(y.a)({},this.data),{},{x:e,y:t});this.updateByParams(a,i)}},{key:"updateByParams",value:function(e){var t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1],i=e.x,a=e.y,n=e.pin;this.data=e,this.node.top=a,this.node.left=i,this.node.data=Object(y.a)(Object(y.a)({},e),{},{type:"node"}),n&&(this.pin&&this.pin.data.pin===n?("pinZ"===n?(this.pin.top=a+5,this.pin.left=i):(this.pin.top=a,this.pin.left=i+5),this.pin.visible=t):this.loadPin(t))}},{key:"remove",value:function(){this.manager.canvas.remove(this.node),this.pin&&this.manager.canvas.remove(this.pin);var e=this.manager.nodeBeamMap[this.data.id];e&&e.forEach((function(e){e.remove()})),delete this.manager.nodeMap[this.data.id],delete this.manager.nodeBeamMap[this.data.id]}},{key:"readonly",get:function(){return this._readonly},set:function(e){this._readonly=e,this.node.selectable=!e,this.node.evented=!e}},{key:"createNode",value:function(e){return new H.fabric.Circle({name:e.id,data:Object(y.a)({type:"node"},e),top:e.y,left:e.x,radius:5,fill:"black",originX:"center",originY:"center",hasBorders:!1,hasControls:!1,selectable:!this.manager.readonly,evented:!this.manager.readonly})}},{key:"setPinProperties",value:function(e){this.pin&&(this.pin.name="image/".concat(e.id),this.pin.data=Object(y.a)(Object(y.a)({},e),{},{type:"node/pin"}),this.pin.originX="center",this.pin.originY="top",this.pin.centeredRotation=!1,this.pin.top=e.y+5,this.pin.left=e.x,this.pin.scale(.15),this.pin.selectable=!1,this.pin.evented=!1,"pinZ"===e.pin&&(this.pin.top=e.y,this.pin.left=e.x+5,this.pin.rotate(-90)))}},{key:"loadPin",value:function(){var e=this,t=!(arguments.length>0&&void 0!==arguments[0])||arguments[0],i=this.data.pin;this.pin&&(this.manager.canvas.remove(this.pin),this.pin=void 0),"undefined"!==typeof i&&"free"!==i&&H.fabric.loadSVGFromURL("".concat("/drawing-sample").concat(Je[i]),(function(i,a){var n=H.fabric.util.groupSVGElements(i,a);"path"===n.type?e.pin=new H.fabric.Group([n]):e.pin=n,e.setPinProperties(e.data),e.pin.visible=t,e.manager.canvas.add(e.pin)}))}},{key:"attachEvents",value:function(){this.node.on("mousedown",this.onMouseDown.bind(this)),this.node.on("mouseup",this.onMouseUp.bind(this)),this.node.on("mousedblclick",this.onDblClick.bind(this)),this.node.on("moving",this.onMoving.bind(this)),this.node.on("moved",this.onMoved.bind(this))}},{key:"onMouseDown",value:function(e){var t=this;if(!this.readonly){if("delete"===this.manager.tool)return this.remove(),this.manager.removeUnconnectedNodes(),this.manager.updateGlobalGuidelines(),this.manager.calcForceAverage(),void this.manager.calcTrapezoidAverage();if(this.longpressTimer&&(clearTimeout(this.longpressTimer),this.longpressTimer=void 0),"select"===this.manager.tool){var i=this.node,a=i.getBoundingRect(!0,!0),n=a.top,s=a.left;this.longpressTimer=setTimeout((function(){var a=i.getBoundingRect(!0,!0),o=a.top,r=a.left;le([s,n],[r,o])&&t.manager.openNodeDialog(e,t),t.longpressTimer=void 0}),Xe.LongpressInterval)}}}},{key:"onMouseUp",value:function(e){this.longpressTimer&&(clearTimeout(this.longpressTimer),this.longpressTimer=void 0)}},{key:"onDblClick",value:function(e){this.readonly||this.manager.openNodeDialog(e,this)}},{key:"onMoving",value:function(e){var t=this;if(!this.readonly&&e.pointer){var i=e.pointer,a=i.x,n=i.y,s=this.manager,o=s.nodeMap,r=s.nodeBeamMap;this.dragging||this.pin&&(this.pin.visible=!1);var c=r[this.data.id];c&&c.forEach((function(e){var i=o[e.data.nodeI],s=o[e.data.nodeJ],r=[i.data.x,i.data.y,s.data.x,s.data.y],c=r[0],l=r[1],h=r[2],d=r[3];e.data.nodeI===t.data.id?(c=a,l=n):e.data.nodeJ===t.data.id&&(h=a,d=n),e.update([c,l,h,d]),t.dragging||e.setVisibleParts(!1)})),this.dragging=!0}}},{key:"onMoved",value:function(e){var t=this;if(!this.readonly&&e.target){var i=e.target.getCenterPoint(),a=i.x,n=i.y,s=ae([a,n],this.manager.snapSize),o=Object(v.a)(s,2),r=o[0],c=o[1];this.update(r,c);var l=this.manager,h=l.nodeBeamMap,d=l.nodeMap,u=h[this.data.id];if(u){var g=[];u.forEach((function(e){var t=d[e.data.nodeI],i=d[e.data.nodeJ],a=[t.data.x,t.data.y,i.data.x,i.data.y],n=a[0],s=a[1],o=a[2],r=a[3];n!==o||s!==r?(e.update([n,s,o,r]),e.updateParts()):g.push(e)})),g.length>0&&(g.forEach((function(e){e.remove()})),this.manager.calcForceAverage(),this.manager.calcTrapezoidAverage())}"undefined"===typeof this.manager.nodeBeamMap[this.data.id]&&(this.manager.nodeBeamMap[this.data.id]=[]),Object.values(this.manager.nodeMap).forEach((function(e){if(e.data.id!==t.data.id&&e.data.x===r&&e.data.y===c){t.manager.canvas.remove(e.node),e.pin&&t.manager.canvas.remove(e.pin);var i=t.manager.nodeBeamMap[e.data.id];i&&i.forEach((function(i){i.data.nodeI===e.data.id&&(i.data.nodeI=t.data.id),i.data.nodeJ===e.data.id&&(i.data.nodeJ=t.data.id),i.beam.data=Object(y.a)({type:"beam"},i.data),t.manager.nodeBeamMap[t.data.id].push(i)})),e.remove()}})),this.manager.updateGlobalGuidelines(),this.dragging=!1}}}]),e}(),Ae="pink",Te={stroke:Ae,fill:Ae,arrowWidth:2,arrowEdgeSize:8},Ne={stroke:Ae,strokeWidth:2,hasControls:!1,hasBorders:!1,lockMovementX:!0,lockMovementY:!0},De={fill:Ae,fontSize:10,fontFamily:"sans-serif",height:10,selectable:!1,evented:!1},_e=function(){function e(t,i){Object(V.a)(this,e),this.data=void 0,this.forceI=void 0,this.forceJ=void 0,this.arrows=void 0,this.line=void 0,this.labelI=void 0,this.labelJ=void 0,this.guide=void 0,this.manager=void 0,this.longpressTimer=void 0,this.dragging=!1,this._readonly=!1,this.selectedShapes=new Set,this.pi=new q.a(0,0),this.pj=new q.a(0,0),this.direction=new q.a(0,0),this.linePoints=[0,0,0,0],this.draggingEdge=void 0,this.beam=void 0,this.vi=new q.a(0,0),this.vj=new q.a(0,0),this.originalAngle=0,this.draggingDirection=new q.a(0,0),this.draggingPosition=new q.a(0,0),this.draggingLength=0,this.draggableMin=Number.MIN_SAFE_INTEGER,this.draggableMax=Number.MAX_SAFE_INTEGER,this.manager=t,this.data=i,this._readonly=this.manager.readonly;var a=this.create(),n=Object(v.a)(a,7);this.forceI=n[0],this.forceJ=n[1],this.arrows=n[2],this.line=n[3],this.labelI=n[4],this.labelJ=n[5],this.guide=n[6],this.addToCanvas(),this.attachEvents()}return Object(Y.a)(e,[{key:"readonly",get:function(){return this._readonly},set:function(e){this._readonly=e,[this.forceI,this.forceJ].concat(Object(X.a)(this.arrows),[this.line]).forEach((function(t){t&&(t.evented=e)}))}},{key:"visible",get:function(){var e;return null===(e=this.forceI.visible)||void 0===e||e},set:function(e){this.forceI.visible=e,this.forceJ.visible=e,this.arrows.forEach((function(t){return t.visible=e})),this.line.visible=e,this.labelI.visible=e,this.labelJ.visible=e,this.guide&&(this.guide.visible=e)}},{key:"evented",get:function(){var e;return null===(e=this.forceI.evented)||void 0===e||e},set:function(e){[this.forceI,this.forceJ].concat(Object(X.a)(this.arrows),[this.line]).forEach((function(t){t.evented=e}))}},{key:"selectable",get:function(){var e;return null===(e=this.forceI.selectable)||void 0===e||e},set:function(e){[this.forceI,this.forceJ].concat(Object(X.a)(this.arrows),[this.line]).forEach((function(t){t.selectable=e}))}},{key:"create",value:function(){var e,t=this,i=this.data,a=i.beam,n=i.forceI,s=i.forceJ,o=i.distanceI,r=i.distanceJ,c=i.angle,l=void 0===c?0:c,h=i.isGlobal,d=void 0!==h&&h,u=this.manager.trapezoidAverage,g=this.manager.beamMap[a],v=new q.a(g.points[0],g.points[1]);e=d?K.clone().rotateDeg(l-90).normalize():g.direction.clone().rotateDeg(l-90).normalize();var f=v.clone().add(g.direction.clone().multiplyScalar(g.length*o)),b=v.clone().add(g.direction.clone().multiplyScalar(g.length*(1-r))),p=f.clone().add(e.clone().multiplyScalar(this.calcLength(n,u))),m=b.clone().add(e.clone().multiplyScalar(this.calcLength(s,u))),j=oe(f,b,g.direction),O=m.x-p.x!==0?(m.y-p.y)/(m.x-p.x):NaN,x=isNaN(O)?NaN:p.y-O*p.x,w=[];j.forEach((function(t){var i=re([p,m,O,x],t,e);if(i){var a=[t.x,t.y,i[0],i[1]];w.push(a)}}));var k=w.map((function(e){return Ee(e,Object(y.a)(Object(y.a)({},Te),{},{hasControls:!1,hasBorders:!1,lockMovementX:!0,lockMovementY:!0,selectable:!t.readonly,evented:!t.readonly}))})),M=Ee([f.x,f.y,p.x,p.y],Object(y.a)(Object(y.a)({},Te),{},{name:"".concat(this.data.id,"/i"),data:Object(y.a)({type:"trapezoid/i"},this.data),selectable:!this.readonly,evented:!this.readonly})),E=Ee([b.x,b.y,m.x,m.y],Object(y.a)(Object(y.a)({},Te),{},{name:"".concat(this.data.id,"/j"),data:Object(y.a)({type:"trapezoid/j"},this.data),selectable:!this.readonly,evented:!this.readonly})),S=this.createLine([p.x,p.y,m.x,m.y]),I=fe([f.x,f.y,b.x,b.y],50);I.visible=!1;var C=f.clone().add(g.direction.clone().multiplyScalar(5)),z=b.clone().add(g.direction.clone().multiplyScalar(5)),P=e.angleDeg(),J=this.createTrapezoidLabel("  ".concat(n," kN/m"),C,P);J.visible=!1;var B=this.createTrapezoidLabel("  ".concat(s," kN/m"),z,P);return B.visible=!1,this.pi.copy(f),this.pj.copy(b),this.direction.copy(e),[M,E,k,S,J,B,I]}},{key:"update",value:function(e){e&&(this.data=e),this.removeFromCanvas();var t=this.create(),i=Object(v.a)(t,7);this.forceI=i[0],this.forceJ=i[1],this.arrows=i[2],this.line=i[3],this.labelI=i[4],this.labelJ=i[5],this.guide=i[6],this.addToCanvas(),this.attachEvents()}},{key:"createLine",value:function(e){return this.linePoints=e,new H.fabric.Line(e,Object(y.a)(Object(y.a)({},Ne),{},{selectable:!this.readonly,evented:!this.readonly,name:this.data.id,data:Object(y.a)({type:"trapezoid"},this.data)}))}},{key:"updateLine",value:function(e){var t,i,a=this.manager.trapezoidAverage;e?(t=new q.a(e[0],e[1]),i=new q.a(e[2],e[3])):("i"===this.draggingEdge?(t=this.draggingPosition.clone().add(this.direction.clone().multiplyScalar(this.calcLength(this.data.forceI,a))),i=this.pj.clone().add(this.direction.clone().multiplyScalar(this.calcLength(this.data.forceJ,a)))):"j"===this.draggingEdge?(t=this.pi.clone().add(this.direction.clone().multiplyScalar(this.calcLength(this.data.forceI,a))),i=this.draggingPosition.clone().add(this.direction.clone().multiplyScalar(this.calcLength(this.data.forceJ,a)))):(t=this.pi.clone().add(this.direction.clone().multiplyScalar(this.calcLength(this.data.forceI,a))),i=this.pj.clone().add(this.direction.clone().multiplyScalar(this.calcLength(this.data.forceJ,a)))),this.linePoints=[t.x,t.y,i.x,i.y]),this.manager.canvas.remove(this.line),this.line=this.createLine([t.x,t.y,i.x,i.y]),this.manager.canvas.add(this.line)}},{key:"remove",value:function(){var e=this;this.removeFromCanvas();var t=this.manager.trapezoidMap[this.data.beam];if(t){var i=t.filter((function(t){return t.data.id!==e.data.id}));this.manager.trapezoidMap[this.data.beam]=i}}},{key:"addToCanvas",value:function(){var e;(e=this.manager.canvas).add.apply(e,[this.forceI,this.forceJ].concat(Object(X.a)(this.arrows),[this.line,this.labelI,this.labelJ])),this.guide&&this.manager.canvas.add(this.guide),this.forceI.bringToFront(),this.forceJ.bringToFront()}},{key:"removeFromCanvas",value:function(){var e;(e=this.manager.canvas).remove.apply(e,[this.forceI,this.forceJ].concat(Object(X.a)(this.arrows),[this.line,this.labelI,this.labelJ])),this.guide&&this.manager.canvas.remove(this.guide)}},{key:"calcForce",value:function(e){return 0===this.manager.trapezoidAverage?10:Math.round(e/25*this.manager.trapezoidAverage)}},{key:"calcLength",value:function(e,t){return isNaN(t)||0===t?25:e/t*25}},{key:"createTrapezoidLabel",value:function(e,t,i){return new H.fabric.Textbox(e,Object(y.a)(Object(y.a)({},De),{},{top:t.y,left:t.x,angle:i,width:140}))}},{key:"setVisibleParts",value:function(){var e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0],t=[this.labelI,this.labelJ].concat(Object(X.a)(this.arrows));t.forEach((function(t){return t.visible=e})),this.guide&&(this.guide.visible=e)}},{key:"select",value:function(){var e=this.line;this.draggingEdge&&(e="i"===this.draggingEdge?this.forceI:this.forceJ),this.manager.canvas.setActiveObject(e)}},{key:"attachEvents",value:function(){var e=this,t=[this.forceI,this.forceJ];[this.forceI,this.forceJ].concat(Object(X.a)(this.arrows),[this.line]).forEach((function(t){t.on("selected",e.onSelected.bind(e)),t.on("deselected",e.onDeselected.bind(e)),t.on("mousedown",e.onMouseDown.bind(e)),t.on("mouseup",e.onMouseUp.bind(e)),t.on("mousedblclick",e.onDblClick.bind(e))})),t.forEach((function(t){t.on("moving",e.onMoving.bind(e)),t.on("moved",e.onMoved.bind(e)),t.on("rotating",e.onRotating.bind(e)),t.on("rotated",e.onRotated.bind(e)),t.on("scaling",e.onScaling.bind(e)),t.on("scaled",e.onScaled.bind(e))}))}},{key:"onSelected",value:function(e){var t,i=null===(t=e.target)||void 0===t?void 0:t.name;i&&this.selectedShapes.add(i),this.labelI.visible=!0,this.labelJ.visible=!0,this.guide&&(this.guide.visible=!0)}},{key:"onDeselected",value:function(e){var t,i=null===(t=e.target)||void 0===t?void 0:t.name;i&&this.selectedShapes.delete(i),0===this.selectedShapes.size&&(this.labelI.visible=!1,this.labelJ.visible=!1,this.guide&&(this.guide.visible=!1))}},{key:"onMouseDown",value:function(e){var t=this;if(!this.readonly){if("delete"===this.manager.tool)return this.remove(),void this.manager.calcTrapezoidAverage();if(["select","trapezoid"].includes(this.manager.tool)&&e.target){this.longpressTimer&&(clearTimeout(this.longpressTimer),this.longpressTimer=void 0);var i=e.target,a=i.getBoundingRect(!0,!0),n=a.top,s=a.left;this.longpressTimer=setTimeout((function(){var a=i.getBoundingRect(!0,!0),o=a.top,r=a.left;le([s,n],[r,o])&&t.manager.openTrapezoidDialog(e,t),t.longpressTimer=void 0}),Xe.LongpressInterval)}}}},{key:"onMouseUp",value:function(e){this.longpressTimer&&(clearTimeout(this.longpressTimer),this.longpressTimer=void 0)}},{key:"onDblClick",value:function(e){this.readonly||this.manager.openTrapezoidDialog(e,this)}},{key:"calcDraggableRange",value:function(){if(this.beam&&this.draggingEdge){var e=[this.beam.points[0],this.beam.points[1]];this.vi.x=e[0],this.vi.y=e[1];var t=[this.beam.points[2],this.beam.points[3]];if(this.vj.x=t[0],this.vj.y=t[1],"i"===this.draggingEdge)if(this.draggableMin=-1*this.vi.distance(this.pi),1-(this.data.distanceJ+.05)<this.data.distanceI)this.draggableMax=0;else{var i=1-(this.data.distanceJ+.05),a=$(this.vi,this.vj,i);this.draggableMax=this.pi.distance(a)}else if("j"===this.draggingEdge)if(this.draggableMax=this.vj.distance(this.pj),1-this.data.distanceJ<this.data.distanceI+.05)this.draggableMin=0;else{var n=$(this.vi,this.vj,this.data.distanceI+.05);this.draggableMin=-1*this.pj.distance(n)}}}},{key:"moveArrow",value:function(e,t){if(this.beam){var i,a;this.draggingPosition.x=null!==(i=e.left)&&void 0!==i?i:0,this.draggingPosition.y=null!==(a=e.top)&&void 0!==a?a:0;var n=t.distance(this.draggingPosition);this.draggingDirection.copy(this.draggingPosition.clone().subtract(t).normalize());var s=180-this.draggingDirection.verticalAngleDeg(),o=(this.beam.angle-s)*Math.PI/180,r=n*Math.cos(o);this.draggableMin>r?r=this.draggableMin:this.draggableMax<r&&(r=this.draggableMax),this.draggingPosition.copy(t).add(this.beam.direction.clone().multiplyScalar(r)),e.left=this.draggingPosition.x,e.top=this.draggingPosition.y,this.updateLine()}}},{key:"checkDraggingEdge",value:function(e){var t;if(e.transform)switch(null===(t=e.transform.target.data)||void 0===t?void 0:t.type){case"trapezoid/i":return"i";case"trapezoid/j":return"j"}}},{key:"onMoving",value:function(e){["select","trapezoid"].includes(this.manager.tool)&&e.transform&&(this.dragging||(this.setVisibleParts(!1),this.beam=this.manager.beamMap[this.data.beam],this.draggingEdge=this.checkDraggingEdge(e),this.draggingEdge&&(this.calcDraggableRange(),this.dragging=!0)),"i"===this.draggingEdge?this.moveArrow(this.forceI,this.pi):"j"===this.draggingEdge&&this.moveArrow(this.forceJ,this.pj))}},{key:"onMoved",value:function(e){if(this.beam&&this.dragging){if("i"===this.draggingEdge){this.moveArrow(this.forceI,this.pi);var t=this.vi.distance(this.draggingPosition);this.data.distanceI=te(t/this.beam.length,2)}else if("j"===this.draggingEdge){this.moveArrow(this.forceJ,this.pj);var i=this.vj.distance(this.draggingPosition);this.data.distanceJ=te(i/this.beam.length,2)}this.update(),this.select()}this.dragging=!1,this.beam=void 0,this.draggableMin=Number.MIN_SAFE_INTEGER,this.draggableMax=Number.MAX_SAFE_INTEGER,this.draggingEdge=void 0}},{key:"onScaling",value:function(e){if(["select","trapezoid"].includes(this.manager.tool)&&e.transform){if(!this.dragging){var t;if(this.setVisibleParts(!1),this.draggingEdge=this.checkDraggingEdge(e),"i"===this.draggingEdge)this.draggingLength=null!==(t=this.forceI.height)&&void 0!==t?t:0;else if("j"===this.draggingEdge){var i;this.draggingLength=null!==(i=this.forceJ.height)&&void 0!==i?i:0}this.dragging=!0}var a;if("i"===this.draggingEdge?(a=this.forceI,this.draggingPosition.copy(this.pi)):"j"===this.draggingEdge&&(a=this.forceJ,this.draggingPosition.copy(this.pj)),a){var n,s=null!==(n=a.scaleY)&&void 0!==n?n:1,o=this.draggingLength*s;this.draggingPosition.add(this.direction.clone().multiplyScalar(o)),"i"===this.draggingEdge?(this.linePoints[0]=this.draggingPosition.x,this.linePoints[1]=this.draggingPosition.y):"j"===this.draggingEdge&&(this.linePoints[2]=this.draggingPosition.x,this.linePoints[3]=this.draggingPosition.y),this.updateLine(this.linePoints)}}}},{key:"onScaled",value:function(e){var t;if(this.dragging&&("i"===this.draggingEdge?t=this.forceI:"j"===this.draggingEdge&&(t=this.forceJ),t)){var i,a=null!==(i=t.scaleY)&&void 0!==i?i:1,n=this.draggingLength*a,s=this.calcForce(n);"i"===this.draggingEdge?this.data.forceI=s:"j"===this.draggingEdge&&(this.data.forceJ=s),this.update(),this.select()}this.dragging=!1,this.draggingEdge=void 0}},{key:"onRotating",value:function(e){if(["select","trapezoid"].includes(this.manager.tool)&&e.transform){if(!this.dragging){var t;if(this.setVisibleParts(!1),this.draggingEdge=this.checkDraggingEdge(e),"i"===this.draggingEdge)this.originalAngle=null!==(t=this.forceI.angle)&&void 0!==t?t:0;else if("j"===this.draggingEdge){var i;this.originalAngle=null!==(i=this.forceJ.angle)&&void 0!==i?i:0}this.dragging=!0}if(this.draggingEdge){var a,n,s,o=0;if("i"===this.draggingEdge)o=null!==(s=this.forceI.angle)&&void 0!==s?s:0,this.forceJ.angle=o;else if("j"===this.draggingEdge){var r;o=null!==(r=this.forceJ.angle)&&void 0!==r?r:0,this.forceI.angle=o}var c=Q.clone().invert(),l=this.pi.clone().add(c.clone().multiplyScalar(null!==(a=this.forceI.height)&&void 0!==a?a:0).rotateDeg(o)),h=this.pj.clone().add(c.clone().multiplyScalar(null!==(n=this.forceJ.height)&&void 0!==n?n:0).rotateDeg(o));this.linePoints=[l.x,l.y,h.x,h.y],this.updateLine(this.linePoints)}}}},{key:"onRotated",value:function(e){if(this.dragging){var t,i,a=0;if("i"===this.draggingEdge)a=null!==(i=this.forceI.angle)&&void 0!==i?i:0;else if("j"===this.draggingEdge){var n;a=null!==(n=this.forceJ.angle)&&void 0!==n?n:0}if(this.originalAngle===a)return;var s=0;s=a-this.originalAngle>0?a-this.originalAngle:360-this.originalAngle+a,s=ne(s,5);var o=(null!==(t=this.data.angle)&&void 0!==t?t:0)+s;o=se(o),this.data.angle=o,this.update(),this.select()}this.dragging=!1,this.draggingEdge=void 0}}]),e}(),Re=function(e){return!(!Array.isArray(e)||3!==e.length)&&(("M"===e[0]||"m"===e[0])&&"number"===typeof e[1]&&"number"===typeof e[2])},Le=function(e){return!(!Array.isArray(e)||3!==e.length)&&(("L"===e[0]||"l"===e[0])&&"number"===typeof e[1]&&"number"===typeof e[2])},We={stroke:"#eee",strokeWidth:1,evented:!1,hasControls:!1,selectable:!1,excludeFromExport:!0,data:{type:"background",excludeExport:!0}},Ge=function(){function e(t,i,a){var n=this;Object(V.a)(this,e),this.canvas=void 0,this._tool="select",this._readonly=!1,this.pageWidth=0,this.pageHeight=0,this.snapSize=25,this.gridSize=25,this._props=void 0,this._data=void 0,this.openPopup=void 0,this.enablePan=!1,this.isCanvasDragging=!1,this.lastPos={x:0,y:0},this.forceAverage=0,this.trapezoidAverage=0,this.nodeMap={},this.beamMap={},this.nodeBeamMap={},this.forceMap={},this.trapezoidMap={},this.globalGuideLines=[],this._initialized=!1,this.currentBeam=void 0;var s=i.data,o=i.zoom,r=i.viewport,c=i.width,l=i.height,h=i.readonly,d=void 0!==h&&h,u=i.snapSize,g=void 0===u?25:u,v=i.gridSize,f=void 0===v?25:v;this._props=i,this._data=s,this.canvas=new H.fabric.Canvas(t,{selection:!0,isDrawingMode:!1,stopContextMenu:!0}),this.canvas.setZoom(o),this.canvas.setViewportTransform(r),this.setTool("select"),this.pageHeight=l,this.pageWidth=c,this._readonly=d,this.snapSize=g,this.gridSize=f,this.openPopup=a,this.drawBackgroundGrid();var b=s.nodes,p=s.beams,m=s.forces,j=s.trapezoids;this.calcForceAverage(m),this.calcTrapezoidAverage(j),b.forEach((function(e){var t=new Be(n,e);n.nodeMap[e.id]=t})),p.forEach((function(e){var t=new Ie(n,e);n.beamMap[e.id]=t,"undefined"===typeof n.nodeBeamMap[e.nodeI]?n.nodeBeamMap[e.nodeI]=[t]:n.nodeBeamMap[e.nodeI].push(t),"undefined"===typeof n.nodeBeamMap[e.nodeJ]?n.nodeBeamMap[e.nodeJ]=[t]:n.nodeBeamMap[e.nodeJ].push(t)})),m.forEach((function(e){var t=new Pe(n,e);"undefined"===typeof n.forceMap[e.beam]?n.forceMap[e.beam]=[t]:n.forceMap[e.beam].push(t)})),j.forEach((function(e){var t=new _e(n,e);"undefined"===typeof n.trapezoidMap[e.beam]?n.trapezoidMap[e.beam]=[t]:n.trapezoidMap[e.beam].push(t)})),this.updateGlobalGuidelines(),this.attachEvent(),this._initialized=!0}return Object(Y.a)(e,[{key:"tool",get:function(){return this._tool}},{key:"readonly",get:function(){return this._readonly}},{key:"initialized",get:function(){return this._initialized}},{key:"setTool",value:function(e){this._tool=e,this.canvas.discardActiveObject(),"select"===e||"force"===e||"delete"===e?(this.canvas.isDrawingMode=!1,this.canvas.selection="select"===e,this.enablePan=!0):(this.canvas.isDrawingMode="pen"===e,this.canvas.selection=!1,this.enablePan=!1),this.setSelectableShapes()}},{key:"setSelectableShapes",value:function(){var e=this,t="select"===this.tool,i=["select","delete"].includes(this.tool),a="select"===this.tool,n=["select","force"].includes(this.tool),s=["select","force","delete"].includes(this.tool),o=["select","trapezoid"].includes(this.tool),r=["select","trapezoid","delete"].includes(this.tool);Object.values(this.nodeMap).forEach((function(e){e.node.selectable=t,e.node.evented=i})),Object.entries(this.beamMap).forEach((function(t){var i=Object(v.a)(t,2),c=i[0],l=i[1];l.beam.selectable=a,l.beam.evented=true;var h=e.forceMap[c];h&&h.forEach((function(e){e.force.selectable=n,e.force.evented=s}));var d=e.trapezoidMap[c];d&&d.forEach((function(e){e.evented=r,e.selectable=o}))}))}},{key:"toCanvasProps",value:function(){var e,t=Object.values(this.nodeMap).map((function(e){return e.data})),i=Object.values(this.beamMap).map((function(e){return e.data})),a=Object.values(this.forceMap).flatMap((function(e){return e.map((function(e){return e.data}))})),n=Object.values(this.trapezoidMap).flatMap((function(e){return e.map((function(e){return e.data}))})),s=this.canvas.toSVG({suppressPreamble:!0}),o=null!==(e=this.canvas.viewportTransform)&&void 0!==e?e:this._props.viewport,r=this.canvas.getZoom();return Object(y.a)(Object(y.a)({},this._props),{},{data:Object(y.a)(Object(y.a)({},this._data),{},{nodes:t,beams:i,forces:a,trapezoids:n}),image:s,zoom:r,viewport:o})}},{key:"openNodeDialog",value:function(e,t){var i=ce(e),a=i.clientX,n=i.clientY;this.openPopup("nodes",{top:n,left:a},t.data,(function(e){x(e)&&t.update(e)}))}},{key:"openForceDialog",value:function(e,t){var i=ce(e),a=i.clientX,n=i.clientY;this.openPopup("forces",{top:n,left:a},t.data,(function(e){k(e)&&t.update(e)}))}},{key:"openTrapezoidDialog",value:function(e,t){var i=ce(e),a=i.clientX,n=i.clientY;this.openPopup("trapezoids",{top:n,left:a},t.data,(function(e){M(e)&&t.update(e)}))}},{key:"calcForceAverage",value:function(e){var t=null!==e&&void 0!==e?e:[];"undefined"===typeof e&&(t=Object.values(this.forceMap).flatMap((function(e){return e.map((function(e){return e.data}))})));var i=0;t.length>0&&(i=t.reduce((function(e,t){return Object(y.a)(Object(y.a)({},e),{},{force:e.force+t.force})})).force/t.length);this.forceAverage=i}},{key:"calcTrapezoidAverage",value:function(e){var t=null!==e&&void 0!==e?e:[];"undefined"===typeof e&&(t=Object.values(this.trapezoidMap).flatMap((function(e){return e.map((function(e){return e.data}))})));var i=0;t.length>0&&(i=t.map((function(e){return e.forceI+e.forceJ})).reduce((function(e,t){return e+t}))/(2*t.length));this.trapezoidAverage=i}},{key:"updateGlobalGuidelines",value:function(){var e,t,i;this.globalGuideLines.length>0&&((i=this.canvas).remove.apply(i,Object(X.a)(this.globalGuideLines)),this.globalGuideLines.length=0);var a=Object.values(this.nodeMap).map((function(e){return e.data})),n=me(a,this.pageHeight);(e=this.globalGuideLines).push.apply(e,Object(X.a)(n)),(t=this.canvas).add.apply(t,Object(X.a)(n))}},{key:"removeUnconnectedNodes",value:function(){var e=this;Object.entries(this.nodeBeamMap).forEach((function(t){var i=Object(v.a)(t,2),a=i[0],n=i[1];if("undefined"===typeof n||0===n.length){var s=e.nodeMap[a];s&&s.remove(),delete e.nodeBeamMap[a]}}))}},{key:"drawBackgroundGrid",value:function(){for(var e,t=[],i=0;i<=this.pageHeight;i+=this.gridSize){var a=new H.fabric.Line([0,i,this.pageWidth,i],Object(y.a)({},We));t.push(a)}for(var n=0;n<=this.pageWidth;n+=this.gridSize){var s=new H.fabric.Line([n,0,n,this.pageHeight],Object(y.a)({},We));t.push(s)}(e=this.canvas).add.apply(e,t)}},{key:"addNodeIfNotExists",value:function(e,t){var i=Object.entries(this.nodeMap).find((function(i){var a=Object(v.a)(i,2)[1];return a.data.x===e&&a.data.y===t}));if(i)return Object(v.a)(i,1)[0];var a=Object(Z.a)(),n=new Be(this,{id:a,name:a,x:e,y:t});return this.nodeMap[a]=n,a}},{key:"addBeamIfNotExists",value:function(e,t){var i=this,a=[e,t],n=Object.entries(this.beamMap).find((function(e){var t=Object(v.a)(e,2)[1];return a.includes(t.data.nodeI)&&a.includes(t.data.nodeJ)}));if(n)return Object(v.a)(n,1)[0];var s=Object(Z.a)(),o=new Ie(this,{id:s,name:s,nodeI:e,nodeJ:t});return this.beamMap[s]=o,a.forEach((function(e){"undefined"===typeof i.nodeBeamMap[e]&&(i.nodeBeamMap[e]=[]),i.nodeBeamMap[e].push(o)})),s}},{key:"attachEvent",value:function(){this.canvas.on("mouse:down",this.onMouseDown.bind(this)),this.canvas.on("mouse:move",this.onMouseMove.bind(this)),this.canvas.on("mouse:up",this.onMouseUp.bind(this)),this.canvas.on("selection:created",this.onSelect.bind(this)),this.canvas.on("selection:updated",this.onSelect.bind(this)),this.canvas.on("selection:cleared",this.onDeselect.bind(this)),this.canvas.on("path:created",this.onCreatePath.bind(this)),this.canvas.on("object:added",this.onCreateObject.bind(this))}},{key:"onMouseDown",value:function(e){if(this.enablePan){var t=ce(e),i=t.clientX,a=t.clientY;this.canvas.selection=!1,this.isCanvasDragging=!0,this.lastPos={x:i,y:a}}}},{key:"onMouseMove",value:function(e){if(this.isCanvasDragging){var t=ce(e),i=t.clientX,a=t.clientY,n=this.canvas.viewportTransform,s=this.canvas.getZoom(),o=this.canvas.getWidth(),r=this.canvas.getHeight();if(n){var c=n[4],l=n[5];o>=this.pageWidth*s?c=o/2-this.pageHeight*s/2:(c+=i-this.lastPos.x)>=0?c=0:c<o-this.pageWidth*s&&(c=o-this.pageWidth*s),r>=this.pageHeight*s?l=r/2-this.pageHeight*s/2:(l+=a-this.lastPos.y)>=0?l=0:l<r-this.pageHeight*s&&(l=r-this.pageHeight*s),n[4]=c,n[5]=l,this.canvas.requestRenderAll()}this.lastPos={x:i,y:a}}}},{key:"onMouseUp",value:function(){if(this.isCanvasDragging){var e=this.canvas.viewportTransform;e&&this.canvas.setViewportTransform(e)}this.isCanvasDragging=!1,this.canvas.selection="select"===this.tool}},{key:"onSelect",value:function(){this.enablePan=!1}},{key:"onDeselect",value:function(){["select","force","delete"].includes(this.tool)&&(this.enablePan=!0)}},{key:"onCreatePath",value:function(e){if((S=e)&&"object"===typeof S&&"object"===typeof S.path){var t=e.path.path;if(t&&function(e){if(Array.isArray(e)){if(e.length>0){var t=e[0],i=e[e.length-1];return Re(t)&&Le(i)}return!0}return!1}(t)&&t.length>=2){var i=t[0],a=t[t.length-1];if(Re(i)&&Le(a)){var n=Object(v.a)(i,3),s=n[1],o=n[2],r=Object(v.a)(a,3),c=r[1],l=r[2];if("pen"===this.tool){var h=ae([s,o],this.snapSize),d=Object(v.a)(h,2);s=d[0],o=d[1];var u=ae([c,l],this.snapSize),g=Object(v.a)(u,2);if(c=g[0],l=g[1],s===c&&o===l)return;if(s>c||s===c&&o>l){var f=[c,s];s=f[0],c=f[1];var b=[l,o];o=b[0],l=b[1]}var p=this.addNodeIfNotExists(s,o),m=this.addNodeIfNotExists(c,l);this.addBeamIfNotExists(p,m)}else if("trapezoid"===this.tool&&this.currentBeam){var j=this.beamMap[this.currentBeam];if(j){var y=new q.a(s,o),O=new q.a(c,l),x=j.calcRatio(y),w=1-j.calcRatio(O),k=Object(Z.a)(),M={id:k,name:k,beam:j.data.id,forceI:10,forceJ:10,distanceI:x,distanceJ:w},E=new _e(this,M);"undefined"===typeof this.trapezoidMap[j.data.id]&&(this.trapezoidMap[j.data.id]=[]),this.trapezoidMap[j.data.id].push(E),this.calcTrapezoidAverage()}this.canvas.isDrawingMode=!1,this.currentBeam=void 0}}}}var S}},{key:"onCreateObject",value:function(e){var t;"path"===(null===(t=e.target)||void 0===t?void 0:t.type)&&this.canvas.remove(e.target)}},{key:"dispose",value:function(){console.log("dispose canvas."),this._initialized&&(this.canvas.clear(),this.canvas.dispose())}}]),e}();Ge.LongpressInterval=1e3;var Fe,Xe=Ge,Ve=Object(r.createContext)(void 0),Ye=function(e){var t=e.children,i=Object(r.useState)(),a=Object(v.a)(i,2),n=a[0],s=a[1],o=Object(r.useState)({top:0,left:0}),c=Object(v.a)(o,2),l=c[0],h=c[1],d=Object(r.useState)({}),u=Object(v.a)(d,2),g=u[0],b=u[1],p=Object(r.useRef)(),m=Object(r.useCallback)((function(e,t,i,a){s(e),h(t),b(null!==i&&void 0!==i?i:{}),p.current=a}),[]),j=Object(r.useCallback)((function(){s(void 0),h({top:0,left:0}),b({}),p.current=void 0}),[]),y=Object(r.useCallback)((function(e){p.current&&p.current(e)}),[]);return Object(f.jsx)(Ve.Provider,{value:{popupType:n,setPopupType:s,popupPosition:l,setPopupPosition:h,open:m,close:j,popupParams:g,callback:y},children:t})},He=["tool"],Ze=function(e,t){var i=e.tool,a=Object(F.a)(e,He),n=Object(r.useContext)(Ve).open,s=Object(r.useRef)(null),o=Object(r.useRef)();return Object(r.useImperativeHandle)(t,(function(){return{getStructure:function(){return o.current?o.current.toCanvasProps():C}}})),Object(r.useEffect)((function(){s.current&&0!==a.width&&0!==a.height&&"undefined"===typeof o.current&&(o.current=new Xe(s.current,a,n))}),[n,a]),Object(r.useEffect)((function(){o.current&&o.current.tool!==i&&o.current.setTool(i)}),[i]),Object(f.jsx)("canvas",{ref:s,width:a.width,height:a.height})},Ue=Object(r.forwardRef)(Ze),qe=i(188),Ke=i(166),Qe=i(176),$e=i(190),et=i(183),tt=["values"],it=function(e){var t=e.force,i=e.onChange,a=e.onClose,n=Object(r.useState)(""),s=Object(v.a)(n,2),o=s[0],c=s[1],l=Object(r.useState)(),h=Object(v.a)(l,2),d=h[0],u=h[1],g=Object(r.useCallback)((function(e){if(e.preventDefault(),e.currentTarget.checkValidity()&&"undefined"===typeof d){var n=parseFloat(o);isNaN(n)||(i&&i(Object(y.a)(Object(y.a)({},t),{},{force:n})),a())}}),[d,i,a,o,t]),b=Object(r.useCallback)((function(e){var t,i=e.currentTarget.value;c(i),0===i.length&&(t="\u6570\u5024\u3092\u5165\u529b\u3057\u3066\u304f\u3060\u3055\u3044");var a=parseFloat(i);isNaN(a)&&(t="\u6570\u5024\u3092\u5165\u529b\u3057\u3066\u304f\u3060\u3055\u3044"),(0>a||a>Number.MAX_SAFE_INTEGER)&&(t="0 \u3088\u308a\u5927\u304d\u3044\u5024\u3092\u5165\u529b\u3057\u3066\u304f\u3060\u3055\u3044"),u(t)}),[]);return Object(r.useEffect)((function(){c("".concat(t.force)),u(void 0)}),[t]),Object(f.jsx)(qe.a,{children:Object(f.jsxs)(Ke.a,{direction:"column",spacing:1,sx:{p:1,width:240},component:"form",autoComplete:"off",noValidate:!0,onSubmit:g,children:[Object(f.jsx)(Qe.a,{variant:"outlined",margin:"dense",size:"small",label:"\u96c6\u4e2d\u8377\u91cd",value:o,required:!0,fullWidth:!0,onChange:b,InputProps:{endAdornment:Object(f.jsx)($e.a,{position:"end",children:"kN"})},error:Boolean(d),helperText:d}),Object(f.jsxs)(Ke.a,{direction:"row",justifyContent:"flex-end",spacing:1,children:[Object(f.jsx)(et.a,{size:"small",onClick:a,children:"\u30ad\u30e3\u30f3\u30bb\u30eb"}),Object(f.jsx)(et.a,{type:"submit",size:"small",variant:"contained",children:"OK"})]})]})})},at=function(e){var t=e.values,i=Object(F.a)(e,tt),a=Object(r.useMemo)((function(){return k(t)?t:{id:"",name:"",beam:"",force:0,distanceI:0}}),[t]);return Object(f.jsx)(it,Object(y.a)(Object(y.a)({},i),{},{force:a}))},nt=i(87),st=i.n(nt),ot=i(94),rt=i(184),ct=i(191),lt=["title","titleId"];function ht(){return ht=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var i=arguments[t];for(var a in i)Object.prototype.hasOwnProperty.call(i,a)&&(e[a]=i[a])}return e},ht.apply(this,arguments)}function dt(e,t){if(null==e)return{};var i,a,n=function(e,t){if(null==e)return{};var i,a,n={},s=Object.keys(e);for(a=0;a<s.length;a++)i=s[a],t.indexOf(i)>=0||(n[i]=e[i]);return n}(e,t);if(Object.getOwnPropertySymbols){var s=Object.getOwnPropertySymbols(e);for(a=0;a<s.length;a++)i=s[a],t.indexOf(i)>=0||Object.prototype.propertyIsEnumerable.call(e,i)&&(n[i]=e[i])}return n}function ut(e,t){var i=e.title,a=e.titleId,n=dt(e,lt);return r.createElement("svg",ht({id:"svg",viewBox:"0 0 160 160",xmlns:"http://www.w3.org/2000/svg",ref:t,"aria-labelledby":a},n),i?r.createElement("title",{id:a},i):null,Fe||(Fe=r.createElement("path",{d:"M80 0 L30 80 L130 80 Z",strokeWidth:6,stroke:"gray",fill:"transparent"})))}var gt,vt,ft,bt,pt=r.forwardRef(ut),mt=(i.p,["title","titleId"]);function jt(){return jt=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var i=arguments[t];for(var a in i)Object.prototype.hasOwnProperty.call(i,a)&&(e[a]=i[a])}return e},jt.apply(this,arguments)}function yt(e,t){if(null==e)return{};var i,a,n=function(e,t){if(null==e)return{};var i,a,n={},s=Object.keys(e);for(a=0;a<s.length;a++)i=s[a],t.indexOf(i)>=0||(n[i]=e[i]);return n}(e,t);if(Object.getOwnPropertySymbols){var s=Object.getOwnPropertySymbols(e);for(a=0;a<s.length;a++)i=s[a],t.indexOf(i)>=0||Object.prototype.propertyIsEnumerable.call(e,i)&&(n[i]=e[i])}return n}function Ot(e,t){var i=e.title,a=e.titleId,n=yt(e,mt);return r.createElement("svg",jt({id:"svg",viewBox:"0 0 160 160",xmlns:"http://www.w3.org/2000/svg",ref:t,"aria-labelledby":a},n),i?r.createElement("title",{id:a},i):null,gt||(gt=r.createElement("path",{d:"M80 0 L30 80 L130 80 Z",strokeWidth:6,stroke:"gray",fill:"transparent"})),vt||(vt=r.createElement("circle",{stroke:"gray",strokeWidth:6,fill:"transparent",cx:45,cy:115,r:20})),ft||(ft=r.createElement("circle",{stroke:"gray",strokeWidth:6,fill:"transparent",cx:115,cy:115,r:20})),bt||(bt=r.createElement("line",{x1:30,y1:150,x2:130,y2:150,stroke:"gray",strokeWidth:6})))}var xt,wt,kt,Mt,Et=r.forwardRef(Ot),St=(i.p,["title","titleId"]);function It(){return It=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var i=arguments[t];for(var a in i)Object.prototype.hasOwnProperty.call(i,a)&&(e[a]=i[a])}return e},It.apply(this,arguments)}function Ct(e,t){if(null==e)return{};var i,a,n=function(e,t){if(null==e)return{};var i,a,n={},s=Object.keys(e);for(a=0;a<s.length;a++)i=s[a],t.indexOf(i)>=0||(n[i]=e[i]);return n}(e,t);if(Object.getOwnPropertySymbols){var s=Object.getOwnPropertySymbols(e);for(a=0;a<s.length;a++)i=s[a],t.indexOf(i)>=0||Object.prototype.propertyIsEnumerable.call(e,i)&&(n[i]=e[i])}return n}function zt(e,t){var i=e.title,a=e.titleId,n=Ct(e,St);return r.createElement("svg",It({id:"svg",viewBox:"0 0 160 160",xmlns:"http://www.w3.org/2000/svg",ref:t,"aria-labelledby":a},n),i?r.createElement("title",{id:a},i):null,xt||(xt=r.createElement("path",{d:"M30 3 L30 80 L130 80 L130 3 Z",strokeWidth:6,stroke:"gray",fill:"transparent"})),wt||(wt=r.createElement("circle",{stroke:"gray",strokeWidth:6,fill:"transparent",cx:45,cy:115,r:20})),kt||(kt=r.createElement("circle",{stroke:"gray",strokeWidth:6,fill:"transparent",cx:115,cy:115,r:20})),Mt||(Mt=r.createElement("line",{x1:30,y1:150,x2:130,y2:150,stroke:"gray",strokeWidth:6})))}var Pt,Jt,Bt,At,Tt,Nt=r.forwardRef(zt),Dt=(i.p,["title","titleId"]);function _t(){return _t=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var i=arguments[t];for(var a in i)Object.prototype.hasOwnProperty.call(i,a)&&(e[a]=i[a])}return e},_t.apply(this,arguments)}function Rt(e,t){if(null==e)return{};var i,a,n=function(e,t){if(null==e)return{};var i,a,n={},s=Object.keys(e);for(a=0;a<s.length;a++)i=s[a],t.indexOf(i)>=0||(n[i]=e[i]);return n}(e,t);if(Object.getOwnPropertySymbols){var s=Object.getOwnPropertySymbols(e);for(a=0;a<s.length;a++)i=s[a],t.indexOf(i)>=0||Object.prototype.propertyIsEnumerable.call(e,i)&&(n[i]=e[i])}return n}function Lt(e,t){var i=e.title,a=e.titleId,n=Rt(e,Dt);return r.createElement("svg",_t({id:"svg",viewBox:"0 0 160 160",xmlns:"http://www.w3.org/2000/svg",ref:t,"aria-labelledby":a},n),i?r.createElement("title",{id:a},i):null,Pt||(Pt=r.createElement("line",{x1:0,y1:3,x2:160,y2:3,stroke:"gray",strokeWidth:6})),Jt||(Jt=r.createElement("line",{x1:20,y1:0,x2:0,y2:60,stroke:"gray",strokeWidth:6})),Bt||(Bt=r.createElement("line",{x1:60,y1:0,x2:40,y2:60,stroke:"gray",strokeWidth:6})),At||(At=r.createElement("line",{x1:100,y1:0,x2:80,y2:60,stroke:"gray",strokeWidth:6})),Tt||(Tt=r.createElement("line",{x1:140,y1:0,x2:120,y2:60,stroke:"gray",strokeWidth:6})))}var Wt=r.forwardRef(Lt),Gt=(i.p,["values"]),Ft={free:{type:"free",icon:Object(f.jsx)(st.a,{}),label:"\u5b8c\u5168\u30d5\u30ea\u30fc"},pin:{type:"pin",icon:Object(f.jsx)(ot.a,{sx:{width:24},viewBox:"0 0 160 160",children:Object(f.jsx)(pt,{})}),label:"\u5b8c\u5168\u30d4\u30f3"},pinX:{type:"pinX",icon:Object(f.jsx)(ot.a,{sx:{width:24},viewBox:"0 0 160 160",children:Object(f.jsx)(Et,{})}),label:"\u30d4\u30f3X\u30ed\u30fc\u30e9\u30fc"},pinZ:{type:"pinZ",icon:Object(f.jsx)(ot.a,{sx:{width:24,transform:"rotate(-90deg)"},viewBox:"0 0 160 160",children:Object(f.jsx)(Et,{})}),label:"\u30d4\u30f3Z\u30ed\u30fc\u30e9\u30fc"},fixX:{type:"fixX",icon:Object(f.jsx)(ot.a,{sx:{width:24},viewBox:"0 0 160 160",children:Object(f.jsx)(Nt,{})}),label:"\u56fa\u5b9aX\u30ed\u30fc\u30e9\u30fc"},fix:{type:"fix",icon:Object(f.jsx)(ot.a,{sx:{width:24},viewBox:"0 0 160 160",children:Object(f.jsx)(Wt,{})}),label:"\u5b8c\u5168\u56fa\u5b9a"}},Xt={sx:{justifyContent:"flex-start",alignItems:"center"}},Vt=function(e){var t=e.node,i=e.onChange,a=e.onClose,n=Object(r.useState)(),s=Object(v.a)(n,2),o=s[0],c=s[1],l=Object(r.useCallback)((function(e){e.preventDefault();var n=Object(y.a)(Object(y.a)({},t),{},{pin:o});i&&i(n),a()}),[t,i,a,o]),h=Object(r.useCallback)((function(e,t){var i;null!==t&&("string"===typeof(i=t)&&O.some((function(e){return e===i})))&&c(t)}),[]);return Object(r.useEffect)((function(){var e;c(null!==(e=t.pin)&&void 0!==e?e:"free")}),[t.pin]),Object(f.jsx)(qe.a,{children:Object(f.jsxs)(Ke.a,{direction:"column",spacing:1,sx:{p:1,width:240},component:"form",autoComplete:"off",noValidate:!0,onSubmit:l,children:[Object(f.jsx)(rt.a,{orientation:"vertical",value:o,size:"small",exclusive:!0,fullWidth:!0,onChange:h,children:Object.entries(Ft).map((function(e){var t=Object(v.a)(e,2),i=t[0],a=t[1],n=a.icon,s=a.label;return Object(f.jsxs)(ct.a,Object(y.a)(Object(y.a)({value:i},Xt),{},{children:[n,Object(f.jsx)(D.a,{variant:"caption",sx:{ml:1},children:s})]}),i)}))}),Object(f.jsxs)(Ke.a,{direction:"row",justifyContent:"flex-end",spacing:1,children:[Object(f.jsx)(et.a,{size:"small",onClick:a,children:"\u30ad\u30e3\u30f3\u30bb\u30eb"}),Object(f.jsx)(et.a,{type:"submit",size:"small",variant:"contained",children:"OK"})]})]})})},Yt=function(e){var t=e.values,i=Object(F.a)(e,Gt),a=Object(r.useMemo)((function(){return x(t)?t:{id:"",name:"",x:0,y:0}}),[t]);return Object(f.jsx)(Vt,Object(y.a)(Object(y.a)({},i),{},{node:a}))},Ht=i(4),Zt=i(192),Ut=i(178),qt=["values"],Kt=function(e){if(0===e.length)return[NaN,!1,"\u6570\u5024\u3092\u5165\u529b\u3057\u3066\u304f\u3060\u3055\u3044"];var t=parseFloat(e);return isNaN(t)?[NaN,!1,"\u6570\u5024\u3092\u5165\u529b\u3057\u3066\u304f\u3060\u3055\u3044"]:0>=t&&t>Number.MAX_SAFE_INTEGER?[t,!1,"0 \u4ee5\u4e0a\u306e\u6570\u5024\u3092\u5165\u529b\u3057\u3066\u304f\u3060\u3055\u3044"]:[te(t,3),!0,""]},Qt=function(e){if(e.length>0){var t=parseInt(e,10);return isNaN(t)||e.indexOf(".")>=0?[NaN,!1,"\u6574\u6570\u3092\u5165\u529b\u3057\u3066\u304f\u3060\u3055\u3044"]:-180>t||180<t?[t,!1,"-180 \u301c 180 \u3067\u5165\u529b\u3057\u3066\u304f\u3060\u3055\u3044"]:(-180===t&&(t=180),[t,!0,""])}return[90,!0,""]},$t=function(e){var t,i,a,n,s,o,c,l=e.trapezoid,h=e.onChange,d=e.onClose,u=Object(r.useState)({}),g=Object(v.a)(u,2),b=g[0],p=g[1],m=Object(r.useState)({}),j=Object(v.a)(m,2),O=j[0],x=j[1],w=Object(r.useCallback)((function(e){if((e.preventDefault(),e.currentTarget.checkValidity())&&!Object.values(O).some((function(e){return e.length>0}))){var t=function(e){var t,i,a,n,s={forceI:0,forceJ:0,angle:90,isGlobal:!1},o=Kt(null!==(t=e.forceI)&&void 0!==t?t:""),r=Object(v.a)(o,2),c=r[0],l=r[1],h=Kt(null!==(i=e.forceJ)&&void 0!==i?i:""),d=Object(v.a)(h,2),u=d[0],g=d[1],f=Qt(null!==(a=e.angle)&&void 0!==a?a:""),b=Object(v.a)(f,2),p=b[0],m=b[1],j=l&&g&&m;return s.forceI=c,s.forceJ=u,s.angle=p,s.isGlobal=null!==(n=e.isGlobal)&&void 0!==n&&n,[j,s]}(b),i=Object(v.a)(t,2),a=i[0],n=i[1];a&&h&&h(Object(y.a)(Object(y.a)({},l),n)),d()}}),[O,h,d,l,b]),k=Object(r.useCallback)((function(e){var t=e.target,i=t.name,a=t.value,n="";switch(i){case"forceI":case"forceJ":var s=Kt(a),o=Object(v.a)(s,3),r=o[1],c=o[2];r||(n=c);break;case"angle":var l=Qt(a),h=Object(v.a)(l,3),d=h[1],u=h[2];d||(n=u)}x((function(e){return Object(y.a)(Object(y.a)({},e),{},Object(Ht.a)({},i,n))})),p((function(e){return Object(y.a)(Object(y.a)({},e),{},Object(Ht.a)({},i,a))}))}),[]),M=Object(r.useCallback)((function(e){var t=e.target.checked;p((function(e){return Object(y.a)(Object(y.a)({},e),{},{isGlobal:t})}))}),[]);return Object(r.useEffect)((function(){p(function(e){var t,i={};return i.forceI="".concat(e.forceI),i.forceJ="".concat(e.forceJ),i.angle="".concat(null!==(t=e.angle)&&void 0!==t?t:""),i.isGlobal=e.isGlobal,i}(l)),x({})}),[l]),Object(f.jsx)(qe.a,{children:Object(f.jsxs)(Ke.a,{direction:"column",spacing:1,sx:{p:1,width:240},component:"form",autoComplete:"off",noValidate:!0,onSubmit:w,children:[Object(f.jsx)(Qe.a,{variant:"outlined",margin:"dense",size:"small",label:"I\u7aef\u5074\u306e\u8377\u91cd",name:"forceI",value:null!==(t=b.forceI)&&void 0!==t?t:"",required:!0,fullWidth:!0,onChange:k,InputProps:{endAdornment:Object(f.jsx)($e.a,{position:"end",children:"kN/m"})},error:Boolean(O.forceI),helperText:null!==(i=O.forceI)&&void 0!==i?i:""}),Object(f.jsx)(Qe.a,{variant:"outlined",margin:"dense",size:"small",label:"J\u7aef\u5074\u306e\u8377\u91cd",name:"forceJ",value:null!==(a=b.forceJ)&&void 0!==a?a:"",required:!0,fullWidth:!0,onChange:k,InputProps:{endAdornment:Object(f.jsx)($e.a,{position:"end",children:"kN/m"})},error:Boolean(O.forceJ),helperText:null!==(n=O.forceJ)&&void 0!==n?n:""}),Object(f.jsx)(Qe.a,{variant:"outlined",margin:"dense",size:"small",label:"\u89d2\u5ea6",name:"angle",value:null!==(s=b.angle)&&void 0!==s?s:"",fullWidth:!0,onChange:k,InputProps:{endAdornment:Object(f.jsx)($e.a,{position:"end",children:"\xb0"})},error:Boolean(O.angle),helperText:null!==(o=O.angle)&&void 0!==o?o:""}),Object(f.jsx)(Zt.a,{label:"\u5168\u4f53\u5ea7\u6a19\u7cfb",control:Object(f.jsx)(Ut.a,{name:"isGlobal",size:"small",checked:null!==(c=b.isGlobal)&&void 0!==c&&c,onChange:M})}),Object(f.jsxs)(Ke.a,{direction:"row",justifyContent:"flex-end",spacing:1,children:[Object(f.jsx)(et.a,{size:"small",onClick:d,children:"\u30ad\u30e3\u30f3\u30bb\u30eb"}),Object(f.jsx)(et.a,{type:"submit",size:"small",variant:"contained",children:"OK"})]})]})})},ei=function(e){var t=e.values,i=Object(F.a)(e,qt),a=Object(r.useMemo)((function(){return M(t)?t:{id:"",name:"",beam:"",forceI:0,distanceI:0,forceJ:0,distanceJ:0}}),[t]);return Object(f.jsx)($t,Object(y.a)(Object(y.a)({},i),{},{trapezoid:a}))},ti=function(){var e=Object(r.useContext)(Ve),t=e.popupType,i=e.popupPosition,a=e.popupParams,n=e.close,s=e.callback;return"undefined"===typeof t?null:Object(f.jsxs)(A.a,{sx:Object(y.a)({position:"fixed",zIndex:5e3},i),children:["forces"===t&&Object(f.jsx)(at,{values:null!==a&&void 0!==a?a:{},onClose:n,onChange:s}),"trapezoids"===t&&Object(f.jsx)(ei,{values:null!==a&&void 0!==a?a:{},onClose:n,onChange:s}),"nodes"===t&&Object(f.jsx)(Yt,{values:null!==a&&void 0!==a?a:{},onClose:n,onChange:s})]})},ii=["tool","readonly","children"],ai=function(e,t){var i=e.tool,a=void 0===i?"select":i,n=e.readonly,s=void 0!==n&&n,o=(e.children,Object(F.a)(e,ii)),c=Object(r.useState)({width:0,height:0}),l=Object(v.a)(c,2),h=l[0],d=l[1],u=Object(r.useRef)(null),g=Object(r.useRef)(null);return Object(r.useImperativeHandle)(t,(function(){return{getStructure:function(){return g.current?g.current.getStructure():C}}}),[]),Object(r.useEffect)((function(){var e=new ResizeObserver((function(e){var t=e[0].contentRect,i=t.width,a=t.height;d({width:i,height:a})}));return u.current&&e.observe(u.current),function(){e.disconnect()}}),[]),Object(f.jsx)(A.a,{ref:u,sx:{width:"auto",height:"100%",backgroundColor:"#ffffff",overscrollBehavior:"contain"},children:Object(f.jsxs)(Ye,{children:[Object(f.jsx)(Ue,Object(y.a)(Object(y.a)({ref:g,tool:a,readonly:s},h),o)),Object(f.jsx)(ti,{})]})})},ni=Object(r.forwardRef)(ai),si=["select","pen","force","trapezoid","delete"],oi=function(e){if(e&&"object"===typeof e){var t=e;return"number"===typeof t.x&&"number"===typeof t.y}return!1},ri={lockRotation:!0,fill:"#fff",stroke:"#000",strokeWidth:1,hasRotatingPoint:!1,erasable:!1},ci={selectable:!1,evented:!1,erasable:!1},li=function(){function e(t,i){Object(V.a)(this,e),this.manager=void 0,this.data=void 0,this.layer=void 0,this.image=void 0,this.dragging=!1,this.manager=t,this.data=i,this.layer=this.createLayer(),this.manager.canvas.add(this.layer),this.loadImage(),this.attachEvents()}return Object(Y.a)(e,[{key:"update",value:function(e){e&&(this.data=e),this.manager.canvas.remove(this.layer),this.image&&this.manager.canvas.remove(this.image),this.layer=this.createLayer(),this.manager.canvas.add(this.layer),this.loadImage(),this.attachEvents()}},{key:"remove",value:function(){this.manager.canvas.remove(this.layer),this.image&&this.manager.canvas.remove(this.image)}},{key:"createLayer",value:function(){var e=new H.fabric.Rect(Object(y.a)({top:this.data.y,left:this.data.x,height:this.data.height,width:this.data.width},ri));return e.setControlsVisibility({bl:!0,br:!0,mb:!0,ml:!0,mr:!0,mt:!0,tl:!0,tr:!0,mtr:!1}),e}},{key:"loadImage",value:function(){var e=this;this.image&&(this.manager.canvas.remove(this.image),this.image=void 0),this.data.image&&H.fabric.loadSVGFromString(this.data.image,(function(t,i){e.image=H.fabric.util.groupSVGElements(t,i),e.image.setOptions(Object(y.a)(Object(y.a)({},ci),{},{top:e.layer.top,left:e.layer.left})),e.manager.canvas.add(e.image),e.layer.opacity=0,e.layer.bringToFront()}))}},{key:"attachEvents",value:function(){this.layer.on("selected",this.onSelected.bind(this)),this.layer.on("deselected",this.onDeselected.bind(this)),this.layer.on("scaling",this.onScaling.bind(this)),this.layer.on("scaled",this.onScaled.bind(this)),this.layer.on("moving",this.onMoving.bind(this)),this.layer.on("moved",this.onMoved.bind(this))}},{key:"onSelected",value:function(e){var t=this.layer.calcCoords();this.manager.openCanvasNavigation(this.data,t)}},{key:"onDeselected",value:function(e){this.manager.closeCanvasNavigation()}},{key:"onScaling",value:function(e){this.dragging||(this.layer.opacity=this.image?.1:1,this.dragging=!0)}},{key:"onScaled",value:function(e){if(this.dragging){var t,i,a=null!==(t=this.layer.scaleX)&&void 0!==t?t:1,n=null!==(i=this.layer.scaleY)&&void 0!==i?i:1,s=this.data.width*a,o=this.data.height*n;this.layer.scaleX=1,this.layer.scaleY=1,this.layer.width=s,this.layer.height=o,this.data.width=s,this.data.height=o,this.layer.opacity=this.image?0:1,this.dragging=!1,this.onSelected(e)}}},{key:"onMoving",value:function(e){this.dragging||(this.manager.closeCanvasNavigation(),this.dragging=!0),this.image&&(this.image.top=this.layer.top,this.image.left=this.layer.left)}},{key:"onMoved",value:function(e){if(this.dragging){var t=this.layer.calcCoords(!0);(function(e){if(e&&"object"===typeof e){var t=e;return oi(t.tl)&&oi(t.tr)&&oi(t.bl)&&oi(t.br)}return!1})(t)&&(this.data.x=t.tl.x,this.data.y=t.tl.y),this.onSelected(e),this.dragging=!1}}}]),e}(),hi={stroke:"#eee",strokeWidth:1,evented:!1,hasControls:!1,selectable:!1,excludeFromExport:!0,erasable:!1,data:{type:"background",excludeExport:!0}},di=function(){function e(t,i){var a=this,n=i.size,s=i.zoom,o=i.viewport,r=i.drawData,c=i.structures,l=i.showCanvasNavigation,h=i.closeCanvasNavigation;Object(V.a)(this,e),this.canvas=void 0,this._mode="edit",this._readonly=!1,this.pageWidth=0,this.pageHeight=0,this.gridSize=25,this._settings=z,this.enablePan=!0,this.dragging=!1,this.lastPos={x:0,y:0},this.structures={},this.showCanvasNavigation=void 0,this.closeCanvasNavigation=void 0,this.canvas=new H.fabric.Canvas(t,{selection:!0,isDrawingMode:!1,stopContextMenu:!0}),this.canvas.setZoom(s),this.canvas.setViewportTransform(o),this.readonly=!1,this.mode="select";var d=I[n];this.pageHeight=d.height,this.pageWidth=d.width,this.gridSize=25,this.showCanvasNavigation=l,this.closeCanvasNavigation=h,this.drawBackgroundGrid(),r&&this.canvas.loadFromJSON(r,this.canvas.renderAll.bind(this.canvas)),c.forEach((function(e){var t=new li(a,e);a.structures[e.id]=t})),this.attachEvents()}return Object(Y.a)(e,[{key:"mode",get:function(){return this._mode},set:function(e){this._mode=e,this.canvas.selection="select"===this._mode,this.canvas.isDrawingMode="edit"===this._mode,this.enablePan="select"===this._mode}},{key:"readonly",get:function(){return this._readonly},set:function(e){this._readonly=e,this.canvas.isDrawingMode=!e&&"edit"===this._mode,this.canvas.selection=!e&&"select"===this._mode}},{key:"drawSettings",get:function(){return this._settings},set:function(e){var t=this.canvas.freeDrawingBrush;Boolean(t)&&this._settings.eraser===e.eraser||(t=e.eraser?new H.fabric.EraserBrush(this.canvas):new H.fabric.PencilBrush(this.canvas),this.canvas.freeDrawingBrush=t);var i=e.stroke,a=e.strokeWidth;t.color=i,t.width=a,this._settings=Object(y.a)({},e)}},{key:"activeStructure",get:function(){return C},set:function(e){var t=this.structures[e.id];t&&t.update(e)}},{key:"save",value:function(){}},{key:"load",value:function(){}},{key:"clear",value:function(){}},{key:"undo",value:function(){}},{key:"redo",value:function(){}},{key:"openCanvasNavigation",value:function(e,t){var i=Object(y.a)(Object(y.a)({},e),{},{coordinates:t});this.showCanvasNavigation(i)}},{key:"drawBackgroundGrid",value:function(){for(var e,t=[],i=0;i<=this.pageHeight;i+=this.gridSize){var a=new H.fabric.Line([0,i,this.pageWidth,i],Object(y.a)({},hi));t.push(a)}for(var n=0;n<=this.pageWidth;n+=this.gridSize){var s=new H.fabric.Line([n,0,n,this.pageHeight],Object(y.a)({},hi));t.push(s)}(e=this.canvas).add.apply(e,t)}},{key:"attachEvents",value:function(){this.canvas.on("mouse:down",this.onMouseDown.bind(this)),this.canvas.on("mouse:move",this.onMouseMove.bind(this)),this.canvas.on("mouse:up",this.onMouseUp.bind(this)),this.canvas.on("selection:created",this.onSelect.bind(this)),this.canvas.on("selection:updated",this.onSelect.bind(this)),this.canvas.on("selection:cleared",this.onDeselect.bind(this)),this.canvas.on("object:added",this.onCreateObject.bind(this))}},{key:"onSelect",value:function(){this.enablePan=!1}},{key:"onDeselect",value:function(){this.enablePan="select"===this.mode}},{key:"onMouseDown",value:function(e){if(this.enablePan){var t=ce(e),i=t.clientX,a=t.clientY;this.canvas.selection=!1,this.dragging=!0,this.lastPos={x:i,y:a}}}},{key:"onMouseMove",value:function(e){if(this.dragging){var t=ce(e),i=t.clientX,a=t.clientY,n=this.canvas.viewportTransform,s=this.canvas.getZoom(),o=this.canvas.getWidth(),r=this.canvas.getHeight();if(n){var c=n[4],l=n[5];o>=this.pageWidth*s?c=o/2-this.pageHeight*s/2:(c+=i-this.lastPos.x)>=0?c=0:c<o-this.pageWidth*s&&(c=o-this.pageWidth*s),r>=this.pageHeight*s?l=r/2-this.pageHeight*s/2:(l+=a-this.lastPos.y)>=0?l=0:l<r-this.pageHeight*s&&(l=r-this.pageHeight*s),n[4]=c,n[5]=l,this.canvas.requestRenderAll()}this.lastPos={x:i,y:a}}}},{key:"onMouseUp",value:function(){if(this.dragging){var e=this.canvas.viewportTransform;e&&this.canvas.setViewportTransform(e)}this.dragging=!1,this.canvas.selection="select"===this.mode}},{key:"onCreateObject",value:function(e){}},{key:"dispose",value:function(){console.log("dispose canvas."),this.canvas.clear(),this.canvas.dispose()}}]),e}(),ui=i(88),gi=i.n(ui),vi=i(89),fi=i.n(vi),bi=i(90),pi=i.n(bi),mi=i(7),ji=i(194),yi=i(91),Oi=i(179),xi=Object(mi.a)("div")({display:"flex",alignItems:"center",width:"100%",padding:"0 8"}),wi=Object(mi.a)("div")({flex:1}),ki=function(e){var t=e.mode,i=e.coordinates,a=e.width,n=e.onEdit,s=e.onCopy,o=e.onDelete,c=e.onCancel,l=Object(r.useState)(null),h=Object(v.a)(l,2),d=h[0],u=h[1],g=Object(r.useCallback)((function(e){u(e.currentTarget)}),[]),b=Object(r.useCallback)((function(){u(null)}),[]),p=Object(r.useMemo)((function(){var e=i.tl.y-34,t=i.tl.x;return e<0&&(e=i.bl.y),[e,t]}),[i.bl.y,i.tl.x,i.tl.y]),m=Object(v.a)(p,2),j=m[0],y=m[1];return Object(f.jsxs)(A.a,{sx:{position:"absolute",top:j,left:y,width:a},children:[Object(f.jsxs)(xi,{children:["canvas"===t&&Object(f.jsx)(ji.a,{size:"small",onClick:c,children:Object(f.jsx)(gi.a,{})}),"note"===t&&Object(f.jsxs)(f.Fragment,{children:[Object(f.jsx)(ji.a,{size:"small",onClick:n,children:Object(f.jsx)(fi.a,{})}),Object(f.jsx)(wi,{}),Object(f.jsx)(ji.a,{size:"small",onClick:g,children:Object(f.jsx)(pi.a,{})})]})]}),Object(f.jsxs)(yi.a,{anchorEl:d,open:Boolean(d),onClose:b,children:[Object(f.jsx)(Oi.a,{onClick:s,children:"\u30b3\u30d4\u30fc"}),Object(f.jsx)(Oi.a,{onClick:o,children:"\u524a\u9664"})]})]})},Mi=["mode","tool","viewSize","drawSettings","onEditCanvas","onCloseCanvas"],Ei=function(e,t){var i=e.mode,a=e.tool,n=e.viewSize,s=e.drawSettings,o=e.onEditCanvas,c=e.onCloseCanvas,l=Object(F.a)(e,Mi),h=Object(r.useRef)(null),d=Object(r.useRef)(),u=Object(r.useState)(),g=Object(v.a)(u,2),b=g[0],p=g[1];Object(r.useImperativeHandle)(t,(function(){return{getActiveStructure:function(){if(d.current)return d.current.activeStructure},setActiveStructure:function(e){d.current&&(d.current.activeStructure=e)}}}));var m=Object(r.useCallback)((function(e){p(e)}),[]),j=Object(r.useCallback)((function(){p(void 0),c&&c()}),[c]),O=Object(r.useCallback)((function(){o&&b&&o(b,(function(e){d.current&&(d.current.activeStructure=e)}))}),[b,o]);return Object(r.useLayoutEffect)((function(){h.current&&0!==n.width&&0!==n.height&&"undefined"===typeof d.current&&(d.current=new di(h.current,Object(y.a)(Object(y.a)({},l),{},{showCanvasNavigation:m,closeCanvasNavigation:j})))}),[j,l,m,n.height,n.width]),Object(r.useEffect)((function(){d.current&&(d.current.readonly="canvas"===i)}),[i]),Object(r.useEffect)((function(){d.current&&(d.current.mode=a)}),[a]),Object(r.useEffect)((function(){d.current&&(d.current.drawSettings=s)}),[s]),Object(f.jsxs)(f.Fragment,{children:[Object(f.jsx)("canvas",{ref:h,width:n.width,height:n.height}),b&&Object(f.jsx)(ki,Object(y.a)(Object(y.a)({mode:i},b),{},{onEdit:O,onCancel:j}))]})},Si=Object(r.forwardRef)(Ei),Ii=function(){var e=Object(r.useRef)(null),t=Object(r.useState)(),i=Object(v.a)(t,2),a=i[0],n=i[1],s=Object(r.useContext)(b),o=s.mode,c=s.editCanvas,l=s.closeCanvas,h=Object(r.useContext)(J),d=h.mode,u=h.settings;return Object(r.useEffect)((function(){var t=new ResizeObserver((function(e){var t=e[0].target.getBoundingClientRect();n(t)}));return e.current&&t.observe(e.current),function(){t.disconnect()}}),[]),Object(f.jsx)(A.a,{ref:e,sx:{width:"auto",height:"100%",backgroundColor:"#ffffff",overscrollBehavior:"contain",overflow:"hidden"},children:a&&Object(f.jsx)(Si,Object(y.a)({mode:o,tool:d,viewSize:a,drawSettings:u,onEditCanvas:c,onCloseCanvas:l},P))})},Ci=function(){var e=Object(r.useContext)(b),t=e.mode,i=e.canvasProps,a=e.canvasRef,n=Object(r.useContext)(m).tool;return Object(f.jsxs)(A.a,{sx:{position:"relative",boxSizing:"border-box",ml:1,mb:1,flex:1,border:function(e){return"1px solid ".concat(e.palette.divider)},borderRadius:1,overflow:"hidden"},children:[Object(f.jsx)(Ii,{}),i&&Object(f.jsx)(A.a,{sx:{position:"absolute",top:i.coordinates.tl.y,left:i.coordinates.tl.x,width:i.width,height:i.height},children:Object(f.jsx)(ni,Object(y.a)({ref:a,tool:n,readonly:"note"===t},i))})]})},zi=i(169),Pi=i(170),Ji=i(171),Bi=i(172),Ai=i(173),Ti={select:{tool:"select",icon:Object(f.jsx)(zi.a,{}),label:"\u9078\u629e"},pen:{tool:"pen",icon:Object(f.jsx)(Pi.a,{}),label:"\u6881\u8981\u7d20\u306e\u63cf\u753b"},force:{tool:"force",icon:Object(f.jsx)(Ji.a,{}),label:"\u96c6\u4e2d\u8377\u91cd\u306e\u8ffd\u52a0"},trapezoid:{tool:"trapezoid",icon:Object(f.jsx)(Bi.a,{}),label:"\u5206\u5e03\u8377\u91cd\u306e\u8ffd\u52a0"},delete:{tool:"delete",icon:Object(f.jsx)(Ai.a,{}),label:"\u8981\u7d20\u306e\u524a\u9664"}},Ni=function(e){var t=e.tool,i=e.onChange,a=Object(r.useCallback)((function(e,t){var a;null!==t&&("string"===typeof(a=t)&&si.some((function(e){return e===a})))&&i(t)}),[i]);return Object(f.jsxs)(Ke.a,{sx:{width:160},alignItems:"flex-start",children:[Object(f.jsx)(D.a,{variant:"caption",children:"Toolbox"}),Object(f.jsx)(rt.a,{orientation:"vertical",value:t,exclusive:!0,fullWidth:!0,onChange:a,children:Object.entries(Ti).map((function(e){var t=Object(v.a)(e,2),i=t[0],a=t[1],n=a.icon,s=a.label;return Object(f.jsxs)(ct.a,{value:i,sx:{justifyContent:"flex-start",alignItems:"center"},children:[n,Object(f.jsx)(D.a,{variant:"caption",sx:{ml:1},children:s})]},i)}))})]})},Di=function(){var e=Object(r.useContext)(m),t=e.tool,i=e.setTool;return Object(f.jsx)(Ni,{tool:t,onChange:i})},_i=i(174),Ri=i(180),Li=["pen","eraser"],Wi={select:{mode:"select",icon:Object(f.jsx)(zi.a,{}),label:"\u9078\u629e"},edit:{mode:"edit",icon:Object(f.jsx)(Pi.a,{}),label:"\u63cf\u753b"}},Gi={pen:{mode:"pen",icon:Object(f.jsx)(Pi.a,{}),label:"\u30da\u30f3\u30c4\u30fc\u30eb"},eraser:{mode:"eraser",icon:Object(f.jsx)(_i.a,{}),label:"\u6d88\u3057\u30b4\u30e0"}},Fi=function(e){var t=e.mode,i=e.settings,a=e.onChangeMode,n=e.onChangeDrawSettings,s=Object(r.useCallback)((function(e,t){var i;null!==t&&("string"===typeof(i=t)&&S.some((function(e){return e===i})))&&a(t)}),[a]),o=Object(r.useCallback)((function(e,t){var i;null!==t&&("string"===typeof(i=t)&&Li.some((function(e){return e===i})))&&n((function(e){return Object(y.a)(Object(y.a)({},e),{},{eraser:"eraser"===t})}))}),[n]),c=Object(r.useCallback)((function(e,t){"number"===typeof t&&n((function(e){return Object(y.a)(Object(y.a)({},e),{},{strokeWidth:t})}))}),[n]),l=Object(r.useCallback)((function(e){if(e.target.checkValidity()){var t=e.target.value;n((function(e){return Object(y.a)(Object(y.a)({},e),{},{stroke:t})}))}}),[n]);return Object(f.jsxs)(Ke.a,{sx:{width:160},alignItems:"flex-start",children:[Object(f.jsx)(D.a,{variant:"caption",children:"Toolbox"}),Object(f.jsx)(rt.a,{orientation:"vertical",value:t,exclusive:!0,fullWidth:!0,onChange:s,children:Object.entries(Wi).map((function(e){var t=Object(v.a)(e,2),i=t[0],a=t[1],n=a.icon,s=a.label;return Object(f.jsxs)(ct.a,{value:i,sx:{justifyContent:"flex-start",alignItems:"center"},children:[n,Object(f.jsx)(D.a,{variant:"caption",sx:{ml:1},children:s})]},i)}))}),Object(f.jsx)(D.a,{variant:"caption",sx:{mt:1},children:"\u63cf\u753b\u30c4\u30fc\u30eb"}),Object(f.jsx)(rt.a,{orientation:"vertical",value:i.eraser?"eraser":"pen",exclusive:!0,fullWidth:!0,disabled:"edit"!==t,onChange:o,children:Object.entries(Gi).map((function(e){var t=Object(v.a)(e,2),i=t[0],a=t[1],n=a.icon,s=a.label;return Object(f.jsxs)(ct.a,{value:i,sx:{justifyContent:"flex-start",alignItems:"center"},children:[n,Object(f.jsx)(D.a,{variant:"caption",sx:{ml:1},children:s})]},i)}))}),Object(f.jsx)(D.a,{variant:"caption",sx:{mt:1},children:"\u592a\u3055"}),Object(f.jsx)(Ri.a,{sx:{ml:1,mb:2,boxSizing:"border-box",width:140},value:i.strokeWidth,min:1,max:20,step:1,valueLabelDisplay:"auto",disabled:"edit"!==t,onChange:c}),Object(f.jsx)(Qe.a,{type:"color",label:"\u30da\u30f3\u306e\u8272",value:i.stroke,disabled:"edit"!==t||i.eraser,fullWidth:!0,margin:"dense",size:"small",onChange:l})]})},Xi=function(){var e=Object(r.useContext)(J);return Object(f.jsx)(Fi,Object(y.a)({},e))},Vi=function(){return"canvas"===Object(r.useContext)(b).mode?Object(f.jsx)(Di,{}):Object(f.jsx)(Xi,{})},Yi=function(){var e=Object(r.useState)({width:0,height:0}),t=Object(v.a)(e,2),i=t[0],a=t[1],n=Object(r.useCallback)((function(){var e=window,t=e.innerHeight,i=e.innerWidth;a({height:t,width:i})}),[]);return Object(r.useEffect)((function(){return n(),window.addEventListener("resize",n),function(){window.removeEventListener("resize",n)}}),[n]),Object(f.jsxs)(A.a,{sx:Object(y.a)(Object(y.a)({},i),{},{overflow:"hidden"}),children:[Object(f.jsx)(G,{}),Object(f.jsxs)(A.a,{sx:{boxSizing:"border-box",width:"auto",height:"calc(100% - 48px)",display:"flex",flexDirection:"row",flexWrap:"nowrap",alignItems:"stretch",pt:1,px:1},children:[Object(f.jsx)(Vi,{}),Object(f.jsx)(Ci,{})]})]})},Hi=Object(d.a)(),Zi=function(){return Object(f.jsx)(u.a,{theme:Hi,children:Object(f.jsx)(p,{children:Object(f.jsx)(j,{children:Object(f.jsxs)(B,{children:[Object(f.jsx)(g.a,{}),Object(f.jsx)(Yi,{})]})})})})},Ui=function(e){e&&e instanceof Function&&i.e(3).then(i.bind(null,195)).then((function(t){var i=t.getCLS,a=t.getFID,n=t.getFCP,s=t.getLCP,o=t.getTTFB;i(e),a(e),n(e),s(e),o(e)}))};h.a.render(Object(f.jsx)(c.a.StrictMode,{children:Object(f.jsx)(Zi,{})}),document.getElementById("root")),Ui()}},[[125,1,2]]]);
//# sourceMappingURL=main.513f9b88.chunk.js.map